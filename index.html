<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SalesManager 7.0 - Enhanced Business Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* SalesManager 7.0 - Enhanced Navy Blue Theme */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Print Styles */
        @media print {
            body { background: white !important; color: black !important; }
            .header, .nav-bar, .footer, .btn { display: none !important; }
            .card { box-shadow: none !important; border: 1px solid #ccc !important; }
            .receipt-container { width: 80mm !important; font-size: 12px !important; }
        }

        /* Login Modal */
        .modal {
            display: flex;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            width: 450px;
            max-width: 90%;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .company-logo {
            font-size: 48px;
            color: #1a237e;
            margin-bottom: 20px;
        }

        .modal-content h2 {
            color: #1a237e;
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 600;
        }

        .company-display {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
            font-weight: 500;
        }

        .login-form .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .login-form input,
        .login-form select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .login-form input:focus,
        .login-form select:focus {
            outline: none;
            border-color: #1a237e;
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .login-btn:hover {
            background: linear-gradient(135deg, #283593 0%, #1a237e 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(26, 35, 126, 0.3);
        }

        /* App Container */
        .app-hidden {
            display: none;
        }

        #app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 15px 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo-section h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .company-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .branch-name {
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-count {
            background: #ff6b6b;
            color: white;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .username {
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Navigation */
        .nav-bar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .nav-list {
            list-style: none;
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
        }

        .nav-item {
            text-decoration: none;
            color: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }

        .nav-item:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            color: #fff;
            border-bottom-color: #ffd700;
            background: rgba(255, 255, 255, 0.15);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }

        .card h2, .card h3 {
            color: #1a237e;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: 600;
        }

        /* Home Page */
        .welcome-card {
            text-align: center;
            padding: 60px 40px;
        }

        .welcome-card i {
            font-size: 80px;
            color: #1a237e;
            margin-bottom: 30px;
        }

        .welcome-card h1 {
            color: #1a237e;
            font-size: 36px;
            margin-bottom: 20px;
        }

        .welcome-card p {
            font-size: 18px;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Transaction & Sales Dropdown */
        .transaction-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .transaction-select, .sales-select {
            padding: 12px 16px;
            border: 2px solid #1a237e;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            color: #333;
            min-width: 250px;
            cursor: pointer;
        }

        .transaction-select:focus, .sales-select:focus {
            outline: none;
            border-color: #283593;
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        /* Sub-dropdown controls */
        .sub-controls {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: rgba(26, 35, 126, 0.05);
            border-radius: 8px;
            border-left: 4px solid #1a237e;
        }

        .sub-controls.active {
            display: block;
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            color: #555;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1a237e;
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .form-group input[readonly] {
            background: #f8f9fa;
            color: #6c757d;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-size: 14px;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f1f3f4;
            font-size: 14px;
            color: #333;
        }

        tr:hover:not(.no-records) {
            background: rgba(26, 35, 126, 0.05);
        }

        .no-records td {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px;
        }

        /* POS Styles */
        .pos-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            height: 70vh;
        }

        .pos-items {
            background: white;
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
        }

        .pos-cart {
            background: white;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .item-card {
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .item-card:hover {
            border-color: #1a237e;
            transform: translateY(-2px);
        }

        .item-card h5 {
            color: #1a237e;
            margin-bottom: 8px;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e1e8ed;
        }

        .cart-total {
            border-top: 2px solid #1a237e;
            padding-top: 15px;
            font-size: 18px;
            font-weight: bold;
            color: #1a237e;
        }

        /* Receipt Styles */
        .receipt-container {
            background: white;
            color: black;
            padding: 20px;
            width: 300px;
            margin: 20px auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .receipt-items {
            margin: 10px 0;
        }

        .receipt-total {
            border-top: 2px dashed #000;
            padding-top: 10px;
            text-align: right;
            font-weight: bold;
        }

        /* Settings Page */
        .settings-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            border: 2px solid #1a237e;
            background: transparent;
            color: #1a237e;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-btn.active,
        .tab-btn:hover {
            background: #1a237e;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .permission-grid, .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .permission-card, .user-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .permission-card h4, .user-card h4 {
            color: #1a237e;
            margin-bottom: 15px;
        }

        .permission-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .permission-item:last-child {
            border-bottom: none;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #1a237e;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .user-role {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .role-admin {
            background: #dc3545;
            color: white;
        }

        .role-user {
            background: #28a745;
            color: white;
        }

        /* Stock Management */
        .stock-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #1a237e;
            margin-bottom: 15px;
        }

        .stock-item h5 {
            color: #1a237e;
            margin-bottom: 8px;
        }

        .price-display {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .price-tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .retail-price {
            background: #28a745;
            color: white;
        }

        .factory-price {
            background: #17a2b8;
            color: white;
        }

        /* Footer */
        .footer {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px 30px;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        .developer-info {
            font-size: 14px;
            margin-top: 10px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.warning { background: #ffc107; color: #333; }
        .notification.info { background: #17a2b8; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Reports Styles */
        .report-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .account-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .summary-card h4 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .summary-card .amount {
            font-size: 24px;
            font-weight: bold;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-content { padding: 20px; }
            .form-row { grid-template-columns: 1fr; }
            .permission-grid { grid-template-columns: 1fr; }
            .user-grid { grid-template-columns: 1fr; }
            .pos-container { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .header-content { 
                flex-direction: column; 
                gap: 15px; 
                text-align: center; 
            }
            
            .nav-list { 
                flex-wrap: wrap; 
                justify-content: center; 
            }
            
            .nav-item { 
                padding: 12px 15px; 
            }
            
            .transaction-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .transaction-select, .sales-select {
                min-width: 100%;
            }
            
            .settings-tabs {
                flex-direction: column;
            }
            
            .account-summary {
                grid-template-columns: 1fr;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 600; }
        .text-primary { color: #1a237e; }
        .text-success { color: #28a745; }
        .text-danger { color: #dc3545; }
        .text-warning { color: #ffc107; }
        .text-muted { color: #6c757d; }
        .mb-20 { margin-bottom: 20px; }
        .mt-20 { margin-top: 20px; }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(26, 35, 126, 0.3);
            border-radius: 50%;
            border-top-color: #1a237e;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="company-logo">
                <i class="fas fa-business-time"></i>
            </div>
            <h2>SalesManager 7.0</h2>
            <div class="company-display" id="loginCompanyDisplay">Business Management System</div>
            <div class="login-form">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" name="username" value="admin" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" value="admin123" required>
                </div>
                <div class="form-group">
                    <label for="branch">Select Branch:</label>
                    <select id="branch" name="branch" required>
                        <option value="">Choose Branch...</option>
                        <option value="MAIN BRANCH" selected>MAIN BRANCH</option>
                        <option value="KAMPALA">KAMPALA</option>
                        <option value="ENTEBBE">ENTEBBE</option>
                        <option value="JINJA">JINJA</option>
                        <option value="MBARARA">MBARARA</option>
                        <option value="GULU">GULU</option>
                    </select>
                </div>
                <button type="button" onclick="login()" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="app-hidden">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <h1><i class="fas fa-business-time"></i> SalesManager 7.0</h1>
                    <div class="company-info">
                        <span class="company-name" id="companyDisplay">Business Management System</span>
                        <span class="branch-name"> >> <span id="currentBranch">MAIN BRANCH</span></span>
                    </div>
                </div>
                <div class="user-info">
                    <span class="notification-count" id="notificationCount">0</span>
                    <span class="username" id="currentUser">ADMIN</span>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-bar">
            <ul class="nav-list">
                <li><a href="#" data-section="home" class="nav-item active">
                    <i class="fas fa-home"></i> Home</a></li>
                <li><a href="#" data-section="transaction" class="nav-item">
                    <i class="fas fa-exchange-alt"></i> Transaction</a></li>
                <li><a href="#" data-section="sales" class="nav-item">
                    <i class="fas fa-shopping-cart"></i> Sales</a></li>
                <li><a href="#" data-section="item" class="nav-item" data-permission="item">
                    <i class="fas fa-box"></i> Item</a></li>
                <li><a href="#" data-section="partner" class="nav-item" data-permission="partner">
                    <i class="fas fa-users"></i> Partner</a></li>
                <li><a href="#" data-section="accounts" class="nav-item" data-permission="accounts">
                    <i class="fas fa-calculator"></i> Accounts</a></li>
                <li><a href="#" data-section="reports" class="nav-item" data-permission="reports">
                    <i class="fas fa-chart-bar"></i> Reports</a></li>
                <li><a href="#" data-section="settings" class="nav-item" data-permission="settings">
                    <i class="fas fa-cog"></i> Settings</a></li>
                <li><a href="#" data-section="dashboards" class="nav-item" data-permission="dashboards">
                    <i class="fas fa-tachometer-alt"></i> Dashboards</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Home Section -->
            <section id="home" class="content-section active">
                <div class="card welcome-card">
                    <i class="fas fa-chart-line"></i>
                    <h1>Welcome to SalesManager 7.0</h1>
                    <p>Your comprehensive business management solution with enhanced POS, complete accounting books, and advanced sales functionality. Navigate through the system using the menu above to access different modules.</p>
                </div>
            </section>

            <!-- Transaction Section -->
            <section id="transaction" class="content-section">
                <div class="card">
                    <h2><i class="fas fa-exchange-alt"></i> Transaction Management</h2>
                    <div class="transaction-controls">
                        <select id="transactionType" class="transaction-select" onchange="loadTransactionModule()">
                            <option value="">Select Transaction Type...</option>
                            <optgroup label="Purchase & Expense">
                                <option value="purchase-expense">Purchase & Expense</option>
                            </optgroup>
                            <optgroup label="Sales">
                                <option value="sales-invoice">Sales Invoice</option>
                                <option value="sales-order">Sales Order</option>
                                <option value="sales-quote">Sales Quote</option>
                            </optgroup>
                            <optgroup label="Production">
                                <option value="production-order">Production Order</option>
                                <option value="material-consumption">Material Consumption</option>
                            </optgroup>
                            <optgroup label="Stock Management">
                                <option value="manage-stock">Manage Stock</option>
                                <option value="stock-transfer">Stock Transfer</option>
                                <option value="stock-adjustment">Stock Adjustment</option>
                            </optgroup>
                            <optgroup label="Cash Management">
                                <option value="cash-receipts">Cash Receipts</option>
                                <option value="cash-payments">Cash Payments</option>
                            </optgroup>
                            <optgroup label="Workflow">
                                <option value="manage-approval">Manage Approval</option>
                                <option value="manage-draft">Manage Draft</option>
                            </optgroup>
                        </select>
                        <button class="btn btn-primary" onclick="newTransaction()">
                            <i class="fas fa-plus"></i> New Transaction
                        </button>
                        <button class="btn btn-info" onclick="printPage()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>

                    <!-- Purchase & Expense Sub-menu -->
                    <div id="purchaseControls" class="sub-controls">
                        <h4><i class="fas fa-shopping-cart"></i> Purchase & Expense Options</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <select id="purchaseSubType" class="transaction-select" onchange="loadPurchaseSubModule()">
                                    <option value="">Select Purchase Type...</option>
                                    <option value="purchase-order">Purchase Order</option>
                                    <option value="purchase-invoice">Purchase Invoice</option>
                                    <option value="goods-services">Goods and Services</option>
                                    <option value="expenses">Expenses</option>
                                    <option value="assets">Assets</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transaction Module Container -->
                    <div id="transactionModule">
                        <div class="card">
                            <div style="text-align: center; padding: 40px;">
                                <i class="fas fa-clipboard-list" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                                <h3 style="color: #1a237e; margin-bottom: 10px;">Select Transaction Type</h3>
                                <p style="color: #666;">Choose a transaction type from the dropdown above to get started.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Enhanced Sales Section -->
            <section id="sales" class="content-section">
                <div class="card">
                    <h2><i class="fas fa-shopping-cart"></i> Sales Management</h2>
                    <div class="transaction-controls">
                        <select id="salesType" class="sales-select" onchange="loadSalesModule()">
                            <option value="">Select Sales Type...</option>
                            <option value="sale-quotation">Sale Quotation</option>
                            <option value="sale-order">Sale Order</option>
                            <option value="sale-invoice">Sale Invoice</option>
                            <option value="retail-sale-invoice">Retail Sale Invoice</option>
                            <option value="wholesale-invoice">Wholesale Invoice</option>
                            <option value="special-sale-invoice">Special Sale Invoice</option>
                            <option value="prepaid-sale">Prepaid Sale</option>
                            <option value="customer-screen">Customer Screen (POS)</option>
                        </select>
                        <button class="btn btn-primary" onclick="newSaleTransaction()">
                            <i class="fas fa-plus"></i> New Sale
                        </button>
                        <button class="btn btn-success" onclick="openPOS()">
                            <i class="fas fa-cash-register"></i> Open POS
                        </button>
                        <button class="btn btn-info" onclick="printPage()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                    
                    <!-- Sales Module Container -->
                    <div id="salesModule">
                        <div class="card">
                            <div style="text-align: center; padding: 40px;">
                                <i class="fas fa-store" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                                <h3 style="color: #1a237e; margin-bottom: 10px;">Select Sales Type</h3>
                                <p style="color: #666;">Choose a sales type from the dropdown above to get started with sales transactions.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- POS Container -->
                <div id="posContainer" style="display: none;">
                    <div class="card">
                        <h3><i class="fas fa-cash-register"></i> Point of Sale System</h3>
                        <div class="pos-container">
                            <div class="pos-items">
                                <h4>Available Items</h4>
                                <div id="itemGrid" class="item-grid"></div>
                            </div>
                            <div class="pos-cart">
                                <h4>Shopping Cart</h4>
                                <div id="cartItems" class="cart-items"></div>
                                <div class="cart-total">
                                    <div>Subtotal: <span id="subtotal">0.00</span></div>
                                    <div>Tax: <span id="taxAmount">0.00</span></div>
                                    <div>Total: <span id="grandTotal">0.00</span></div>
                                </div>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-success" onclick="processPayment()">
                                        <i class="fas fa-credit-card"></i> Process Payment
                                    </button>
                                    <button class="btn btn-warning" onclick="clearCart()">
                                        <i class="fas fa-trash"></i> Clear Cart
                                    </button>
                                    <button class="btn btn-info" onclick="printReceipt()">
                                        <i class="fas fa-print"></i> Print Receipt
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Item Section -->
            <section id="item" class="content-section">
                <div class="card">
                    <h2><i class="fas fa-box"></i> Item Management</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Item Code</label>
                            <input type="text" id="itemCodeInput" placeholder="Enter item code">
                        </div>
                        <div class="form-group">
                            <label>Item Name</label>
                            <input type="text" id="itemNameInput" placeholder="Enter item name">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="itemCategory">
                                <option value="">Select category</option>
                                <option value="furniture">Furniture</option>
                                <option value="electronics">Electronics</option>
                                <option value="clothing">Clothing</option>
                                <option value="accessories">Accessories</option>
                                <option value="food">Food & Beverages</option>
                                <option value="office">Office Supplies</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Retail Price</label>
                            <input type="number" id="itemRetailPrice" placeholder="0.00" step="0.01">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Factory Price</label>
                            <input type="number" id="itemFactoryPrice" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Stock Quantity</label>
                            <input type="number" id="itemStock" placeholder="0" min="0">
                        </div>
                        <div class="form-group">
                            <label>Unit</label>
                            <select id="itemUnit">
                                <option value="PCS">Pieces</option>
                                <option value="KG">Kilograms</option>
                                <option value="L">Liters</option>
                                <option value="M">Meters</option>
                                <option value="BOX">Box</option>
                                <option value="SET">Set</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Minimum Stock Level</label>
                            <input type="number" id="itemMinStock" placeholder="0" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <button class="btn btn-success" onclick="saveItem()">
                            <i class="fas fa-save"></i> Save Item
                        </button>
                        <button class="btn btn-warning" onclick="clearItemForm()">
                            <i class="fas fa-broom"></i> Clear Form
                        </button>
                        <button class="btn btn-primary" onclick="exportStock()">
                            <i class="fas fa-download"></i> Export Stock
                        </button>
                        <button class="btn btn-info" onclick="printPage()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Item Code</th>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Stock</th>
                                <th>Retail Price</th>
                                <th>Factory Price</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <tr class="no-records">
                                <td colspan="8">No items found. Add your first item above.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Partner Section -->
            <section id="partner" class="content-section">
                <div class="card">
                    <h2><i class="fas fa-users"></i> Partner Management</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Partner Name</label>
                            <input type="text" id="partnerName" placeholder="Enter partner name">
                        </div>
                        <div class="form-group">
                            <label>Partner Type</label>
                            <select id="partnerType">
                                <option value="customer">Customer</option>
                                <option value="supplier">Supplier</option>
                                <option value="both">Customer & Supplier</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="partnerEmail" placeholder="partner@example.com">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="partnerPhone" placeholder="Enter phone number">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Address</label>
                            <textarea id="partnerAddress" rows="3" placeholder="Enter full address"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <button class="btn btn-success" onclick="savePartner()">
                            <i class="fas fa-save"></i> Save Partner
                        </button>
                        <button class="btn btn-warning" onclick="clearPartnerForm()">
                            <i class="fas fa-broom"></i> Clear Form
                        </button>
                        <button class="btn btn-info" onclick="printPage()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Partner Name</th>
                                <th>Type</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="partnersTableBody">
                            <tr class="no-records">
                                <td colspan="5">No partners found. Add your first partner above.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Enhanced Accounts Section -->
            <section id="accounts" class="content-section">
                <div class="card">
                    <h2><i class="fas fa-calculator"></i> Accounting Books</h2>
                    
                    <!-- Account Summary -->
                    <div class="account-summary">
                        <div class="summary-card">
                            <h4>Total Assets</h4>
                            <div class="amount" id="totalAssets">0.00</div>
                        </div>
                        <div class="summary-card">
                            <h4>Total Liabilities</h4>
                            <div class="amount" id="totalLiabilities">0.00</div>
                        </div>
                        <div class="summary-card">
                            <h4>Total Equity</h4>
                            <div class="amount" id="totalEquity">0.00</div>
                        </div>
                        <div class="summary-card">
                            <h4>Net Profit</h4>
                            <div class="amount" id="netProfit">0.00</div>
                        </div>
                    </div>

                    <!-- Account Controls -->
                    <div class="transaction-controls">
                        <select id="accountBookType" class="transaction-select" onchange="loadAccountBook()">
                            <option value="">Select Account Book...</option>
                            <option value="general-ledger">General Ledger</option>
                            <option value="cash-book">Cash Book</option>
                            <option value="sales-book">Sales Book</option>
                            <option value="purchase-book">Purchase Book</option>
                            <option value="trial-balance">Trial Balance</option>
                            <option value="profit-loss">Profit & Loss</option>
                            <option value="balance-sheet">Balance Sheet</option>
                            <option value="chart-of-accounts">Chart of Accounts</option>
                        </select>
                        <button class="btn btn-primary" onclick="newAccountEntry()">
                            <i class="fas fa-plus"></i> New Entry
                        </button>
                        <button class="btn btn-success" onclick="calculateTotals()">
                            <i class="fas fa-calculator"></i> Calculate
                        </button>
                        <button class="btn btn-info" onclick="printPage()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                    
                    <!-- Account Module Container -->
                    <div id="accountModule">
                        <div class="card">
                            <div style="text-align: center; padding: 40px;">
                                <i class="fas fa-chart-pie" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                                <h3 style="color: #1a237e; margin-bottom: 10px;">Select Account Book</h3>
                                <p style="color: #666;">Choose an account book from the dropdown above to view or manage your accounting records.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Enhanced Reports Section -->
            <section id="reports" class="content-section">
                <div class="card">
                    <h2><i class="fas fa-chart-bar"></i> Reports & Analytics</h2>
                    
                    <!-- Report Controls -->
                    <div class="report-controls">
                        <select id="reportType" class="transaction-select" onchange="loadReport()">
                            <option value="">Select Report Type...</option>
                            <optgroup label="Sales Reports">
                                <option value="daily-sales">Daily Sales Report</option>
                                <option value="monthly-sales">Monthly Sales Report</option>
                                <option value="customer-sales">Customer Sales Report</option>
                                <option value="product-sales">Product Sales Report</option>
                            </optgroup>
                            <optgroup label="Financial Reports">
                                <option value="income-statement">Income Statement</option>
                                <option value="balance-sheet-report">Balance Sheet</option>
                                <option value="cash-flow">Cash Flow Statement</option>
                                <option value="trial-balance-report">Trial Balance</option>
                            </optgroup>
                            <optgroup label="Inventory Reports">
                                <option value="stock-report">Stock Report</option>
                                <option value="low-stock">Low Stock Report</option>
                                <option value="stock-movement">Stock Movement Report</option>
                                <option value="valuation-report">Inventory Valuation</option>
                            </optgroup>
                            <optgroup label="Purchase Reports">
                                <option value="purchase-report">Purchase Report</option>
                                <option value="supplier-report">Supplier Report</option>
                                <option value="purchase-analysis">Purchase Analysis</option>
                            </optgroup>
                        </select>
                        
                        <div class="date-range">
                            <label>From:</label>
                            <input type="date" id="reportFromDate" value="">
                            <label>To:</label>
                            <input type="date" id="reportToDate" value="">
                        </div>
                        
                        <button class="btn btn-primary" onclick="generateReport()">
                            <i class="fas fa-chart-line"></i> Generate Report
                        </button>
                        <button class="btn btn-success" onclick="exportReport()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-info" onclick="printPage()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                    
                    <!-- Report Module Container -->
                    <div id="reportModule">
                        <div class="card">
                            <div style="text-align: center; padding: 40px;">
                                <i class="fas fa-chart-area" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                                <h3 style="color: #1a237e; margin-bottom: 10px;">Select Report Type</h3>
                                <p style="color: #666;">Choose a report type and date range from the dropdowns above to generate comprehensive business reports.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="content-section">
                <div class="card">
                    <h2><i class="fas fa-cog"></i> System Settings</h2>
                    
                    <div class="settings-tabs">
                        <button class="tab-btn active" onclick="showTab('company')">Company Info</button>
                        <button class="tab-btn" onclick="showTab('users')">User Management</button>
                        <button class="tab-btn" onclick="showTab('permissions')">User Permissions</button>
                        <button class="tab-btn" onclick="showTab('system')">System Settings</button>
                        <button class="tab-btn" onclick="showTab('developer')">Developer Info</button>
                    </div>

                    <!-- Company Info Tab -->
                    <div id="company-tab" class="tab-content active">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Company Name</label>
                                <input type="text" id="companyName" placeholder="Enter company name" value="Business Management System">
                            </div>
                            <div class="form-group">
                                <label>Business Registration Number</label>
                                <input type="text" id="businessRegNo" placeholder="Enter registration number">
                            </div>
                            <div class="form-group">
                                <label>Tax Identification Number</label>
                                <input type="text" id="taxId" placeholder="Enter tax ID">
                            </div>
                            <div class="form-group">
                                <label>Main Branch Location</label>
                                <input type="text" id="mainLocation" placeholder="Enter main location" value="MAIN BRANCH">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="tel" id="companyPhone" placeholder="Enter phone number">
                            </div>
                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" id="companyEmail" placeholder="company@example.com">
                            </div>
                            <div class="form-group">
                                <label>Website</label>
                                <input type="url" id="companyWebsite" placeholder="https://www.company.com">
                            </div>
                            <div class="form-group">
                                <label>Currency</label>
                                <select id="companyCurrency">
                                    <option value="UGX">UGX - Ugandan Shilling</option>
                                    <option value="USD">USD - US Dollar</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="KES">KES - Kenyan Shilling</option>
                                    <option value="TZS">TZS - Tanzanian Shilling</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Full Address</label>
                                <textarea id="companyAddress" rows="4" placeholder="Enter complete business address"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Enable VAT</label>
                                <label class="switch">
                                    <input type="checkbox" id="enableVAT" onchange="toggleVAT()">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="form-group" id="vatRateGroup" style="display: none;">
                                <label>VAT Rate (%)</label>
                                <input type="number" id="vatRate" value="18" min="0" max="100" step="0.01">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="saveCompanyInfo()">
                            <i class="fas fa-save"></i> Save Company Information
                        </button>
                    </div>

                    <!-- User Management Tab -->
                    <div id="users-tab" class="tab-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" id="newUsername" placeholder="Enter username">
                            </div>
                            <div class="form-group">
                                <label>Password</label>
                                <input type="password" id="newPassword" placeholder="Enter password">
                            </div>
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="newFullName" placeholder="Enter full name">
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <select id="newUserRole">
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="newUserEmail" placeholder="user@example.com">
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="newUserPhone" placeholder="Enter phone number">
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="addUser()">
                            <i class="fas fa-user-plus"></i> Add User
                        </button>

                        <h4 class="mt-20">Current Users</h4>
                        <div class="user-grid" id="userGrid">
                            <!-- Users will be dynamically loaded here -->
                        </div>
                    </div>

                    <!-- User Permissions Tab -->
                    <div id="permissions-tab" class="tab-content">
                        <div class="permission-grid">
                            <div class="permission-card">
                                <h4><i class="fas fa-exchange-alt"></i> Transaction Module</h4>
                                <div class="permission-item">
                                    <span>View Transactions</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="transaction-view" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>Create Transactions</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="transaction-create" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>Edit Transactions</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="transaction-edit" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>Delete Transactions</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="transaction-delete" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="permission-card">
                                <h4><i class="fas fa-shopping-cart"></i> Sales Module</h4>
                                <div class="permission-item">
                                    <span>View Sales</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="sales-view" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>Create Sales</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="sales-create" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>POS Access</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="pos-access" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="permission-card">
                                <h4><i class="fas fa-box"></i> Item Management</h4>
                                <div class="permission-item">
                                    <span>View Items</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="item-view" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>Create Items</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="item-create" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>Edit Items</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="item-edit" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>Delete Items</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="item-delete" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="permission-card">
                                <h4><i class="fas fa-users"></i> Partner Management</h4>
                                <div class="permission-item">
                                    <span>View Partners</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="partner-view" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>Create Partners</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="partner-create" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>Edit Partners</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="partner-edit" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>Delete Partners</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="partner-delete" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="permission-card">
                                <h4><i class="fas fa-calculator"></i> Accounting</h4>
                                <div class="permission-item">
                                    <span>View Accounts</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="accounts-view" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>Create Entries</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="accounts-create" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>Edit Entries</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="accounts-edit" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>Delete Entries</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="accounts-delete" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="permission-card">
                                <h4><i class="fas fa-chart-bar"></i> Reports</h4>
                                <div class="permission-item">
                                    <span>View Reports</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="reports-view" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>Export Reports</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="reports-export" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="permission-card">
                                <h4><i class="fas fa-cog"></i> System Settings</h4>
                                <div class="permission-item">
                                    <span>Access Settings</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="settings-access" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="permission-item">
                                    <span>Modify Settings</span>
                                    <label class="switch">
                                        <input type="checkbox" data-permission="settings-modify" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-success mt-20" onclick="savePermissions()">
                            <i class="fas fa-save"></i> Save Permissions
                        </button>
                    </div>

                    <!-- System Settings Tab -->
                    <div id="system-tab" class="tab-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date Format</label>
                                <select id="dateFormat">
                                    <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                    <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Time Format</label>
                                <select id="timeFormat">
                                    <option value="24">24 Hour</option>
                                    <option value="12">12 Hour</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Decimal Places</label>
                                <select id="decimalPlaces">
                                    <option value="0">0</option>
                                    <option value="2" selected>2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Auto Backup</label>
                                <label class="switch">
                                    <input type="checkbox" id="autoBackup">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="saveSystemSettings()">
                            <i class="fas fa-save"></i> Save System Settings
                        </button>
                    </div>

                    <!-- Developer Info Tab -->
                    <div id="developer-tab" class="tab-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Development Company</label>
                                <input type="text" id="devCompany" placeholder="Enter development company name">
                            </div>
                            <div class="form-group">
                                <label>Developer Name</label>
                                <input type="text" id="devName" placeholder="Enter developer name">
                            </div>
                            <div class="form-group">
                                <label>Contact Email</label>
                                <input type="email" id="devEmail" placeholder="developer@example.com">
                            </div>
                            <div class="form-group">
                                <label>Contact Phone</label>
                                <input type="tel" id="devPhone" placeholder="Enter contact phone">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Website</label>
                                <input type="url" id="devWebsite" placeholder="https://www.developer.com">
                            </div>
                            <div class="form-group">
                                <label>Support Email</label>
                                <input type="email" id="supportEmail" placeholder="support@example.com">
                            </div>
                            <div class="form-group">
                                <label>Version</label>
                                <input type="text" id="systemVersion" value="7.0" readonly>
                            </div>
                            <div class="form-group">
                                <label>License Type</label>
                                <select id="licenseType">
                                    <option value="commercial">Commercial</option>
                                    <option value="opensource">Open Source</option>
                                    <option value="trial">Trial</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="saveDeveloperInfo()">
                            <i class="fas fa-save"></i> Save Developer Information
                        </button>
                    </div>
                </div>
            </section>

            <!-- Dashboards Section -->
            <section id="dashboards" class="content-section">
                <div class="card">
                    <h2><i class="fas fa-tachometer-alt"></i> Business Dashboard</h2>
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-chart-area" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                        <h3 style="color: #1a237e; margin-bottom: 10px;">Executive Dashboard</h3>
                        <p style="color: #666;">Real-time business metrics, KPIs, and interactive charts for informed decision making.</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div> 2025 SalesManager 7.0 - Enhanced Business Management System</div>
                <div class="developer-info" id="footerDeveloperInfo">
                    Developed by: <span id="footerDevName">System Developer</span> | 
                    Contact: <span id="footerDevEmail">developer@example.com</span>
                </div>
            </div>
        </footer>
    </div>

    <!-- Receipt Template (Hidden) -->
    <div id="receiptTemplate" style="display: none;">
        <div class="receipt-container">
            <div class="receipt-header">
                <h3 id="receiptCompanyName">Business Management System</h3>
                <p id="receiptCompanyAddress">Company Address</p>
                <p id="receiptCompanyPhone">Phone: +256-000-000-000</p>
                <hr>
                <p>Receipt #: <span id="receiptNumber"></span></p>
                <p>Date: <span id="receiptDate"></span></p>
                <p>Cashier: <span id="receiptCashier"></span></p>
            </div>
            <div class="receipt-items" id="receiptItems">
                <!-- Items will be inserted here -->
            </div>
            <div class="receipt-total">
                <p>Subtotal: <span id="receiptSubtotal"></span></p>
                <p>Tax: <span id="receiptTax"></span></p>
                <p><strong>Total: <span id="receiptGrandTotal"></span></strong></p>
                <hr>
                <p style="text-align: center;">Thank you for your business!</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let systemConfig = {
            companyName: 'Business Management System',
            mainLocation: 'MAIN BRANCH',
            enableVAT: false,
            vatRate: 18,
            currency: 'UGX',
            phone: '',
            email: '',
            address: '',
            devInfo: {
                company: 'System Developer',
                name: 'Development Team',
                email: 'developer@example.com',
                phone: '',
                website: '',
                support: 'support@example.com'
            }
        };

        let userPermissions = {};
        let items = [];
        let partners = [];
        let users = [
            { id: 1, username: 'admin', password: 'admin123', fullName: 'System Administrator', role: 'admin', email: 'admin@system.com', phone: '', active: true }
        ];
        let currentUser = null;
        let transactions = [];
        let stockMovements = [];
        let accountEntries = [];
        let salesData = [];
        let currentCart = [];
        let receiptCounter = 1000;
        let customerDeposits = [];
        let goodsServicesItems = [];
        let priceHistory = [];
        let lastReceipt = null;

        // Accounting books structure
        let accountingBooks = {
            chartOfAccounts: [
                { code: '1000', name: 'Cash', type: 'Asset', balance: 0 },
                { code: '1100', name: 'Accounts Receivable', type: 'Asset', balance: 0 },
                { code: '1200', name: 'Inventory', type: 'Asset', balance: 0 },
                { code: '2000', name: 'Accounts Payable', type: 'Liability', balance: 0 },
                { code: '3000', name: 'Capital', type: 'Equity', balance: 0 },
                { code: '4000', name: 'Sales Revenue', type: 'Revenue', balance: 0 },
                { code: '5000', name: 'Cost of Goods Sold', type: 'Expense', balance: 0 },
                { code: '6000', name: 'Operating Expenses', type: 'Expense', balance: 0 }
            ],
            generalLedger: [],
            cashBook: [],
            salesBook: [],
            purchaseBook: []
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            showLoginForm();
            initializeDates();
            initializeAccounting();
        });

        function initializeDates() {
            const today = new Date().toISOString().split('T')[0];
            const elements = ['reportFromDate', 'reportToDate'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = today;
            });
        }

        function initializeAccounting() {
            // Initialize opening balances
            accountingBooks.chartOfAccounts.forEach(account => {
                if (account.type === 'Asset') {
                    account.balance = Math.random() * 10000; // Sample data
                } else if (account.type === 'Liability') {
                    account.balance = Math.random() * 5000; // Sample data
                } else if (account.type === 'Equity') {
                    account.balance = Math.random() * 15000; // Sample data
                }
            });
        }

        // Login functionality
        function showLoginForm() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('app').classList.add('app-hidden');
            updateLoginDisplay();
        }

        function updateLoginDisplay() {
            document.getElementById('loginCompanyDisplay').textContent = systemConfig.companyName;
        }

        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const branch = document.getElementById('branch').value;

            if (!username || !password || !branch) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            // Check credentials
            const user = users.find(u => u.username === username && u.password === password && u.active);
            
            if (user) {
                currentUser = user;
                
                // Update UI with user info
                document.getElementById('currentUser').textContent = user.fullName.toUpperCase();
                document.getElementById('currentBranch').textContent = branch;
                
                // Hide login modal and show app
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('app').classList.remove('app-hidden');
                
                // Initialize application
                initNavigation();
                loadSystemConfig();
                updateFooter();
                loadUsers();
                updateNotificationCount();
                
                showNotification(`Welcome ${user.fullName}! Login successful.`, 'success');
            } else {
                showNotification('Invalid credentials. Please try again.', 'error');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                
                // Reset form
                document.getElementById('username').value = 'admin';
                document.getElementById('password').value = 'admin123';
                document.getElementById('branch').value = 'MAIN BRANCH';
                
                showLoginForm();
                showNotification('Logged out successfully', 'info');
            }
        }

        function updateNotificationCount() {
            const lowStockItems = items.filter(item => item.stock <= item.minStock).length;
            document.getElementById('notificationCount').textContent = lowStockItems;
        }

        // Navigation functionality
        function initNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const contentSections = document.querySelectorAll('.content-section');

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    const permission = item.getAttribute('data-permission');
                    if (permission && !checkPermission(permission + '-view')) {
                        showNotification('Access denied: Insufficient permissions', 'error');
                        return;
                    }
                    
                    navItems.forEach(nav => nav.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));
                    
                    item.classList.add('active');
                    
                    const sectionId = item.getAttribute('data-section');
                    document.getElementById(sectionId).classList.add('active');
                    
                    // Load section-specific data
                    if (sectionId === 'accounts') {
                        calculateAccountSummary();
                    } else if (sectionId === 'item') {
                        refreshItemsTable();
                    } else if (sectionId === 'partner') {
                        refreshPartnersTable();
                    }
                });
            });
        }

        // Enhanced Sales Module Functions
        function loadSalesModule() {
            const salesType = document.getElementById('salesType').value;
            const moduleContainer = document.getElementById('salesModule');
            const posContainer = document.getElementById('posContainer');
            
            if (!salesType) {
                moduleContainer.innerHTML = `
                    <div class="card">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-store" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                            <h3 style="color: #1a237e; margin-bottom: 10px;">Select Sales Type</h3>
                            <p style="color: #666;">Choose a sales type from the dropdown above to get started with sales transactions.</p>
                        </div>
                    </div>
                `;
                posContainer.style.display = 'none';
                return;
            }

            if (salesType === 'customer-screen') {
                posContainer.style.display = 'block';
                moduleContainer.innerHTML = '';
                loadPOSItems();
            } else if (salesType === 'prepaid-sale') {
                posContainer.style.display = 'none';
                moduleContainer.innerHTML = generatePrepaidSaleInterface();
            } else {
                posContainer.style.display = 'none';
                let moduleContent = generateSalesInterface(salesType);
                moduleContainer.innerHTML = moduleContent;
            }
        }

        function generateSalesInterface(salesType) {
            const title = salesType.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const invoiceNumber = salesType.toUpperCase().replace(/-/g, '') + '-' + Date.now();
            
            return `
                <div class="card">
                    <h3><i class="fas fa-file-invoice"></i> ${title}</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Invoice/Document Number</label>
                            <input type="text" value="${invoiceNumber}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>Customer</label>
                            <select id="salesCustomer">
                                <option>Select Customer...</option>
                                ${partners.filter(p => p.type === 'customer' || p.type === 'both')
                                  .map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sales Representative</label>
                            <input type="text" value="${currentUser.fullName}" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Item</label>
                            <select id="salesItem" onchange="updateSalesItemDetails()">
                                <option>Select Item...</option>
                                ${items.map(item => `<option value="${item.id}">${item.name} - ${formatCurrency(salesType.includes('wholesale') ? item.factoryPrice : item.retailPrice)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" id="salesQty" min="1" value="1" onchange="calculateSalesAmount()">
                        </div>
                        <div class="form-group">
                            <label>Unit Price</label>
                            <input type="number" id="salesPrice" step="0.01" onchange="calculateSalesAmount()">
                        </div>
                        <div class="form-group">
                            <label>Discount (%)</label>
                            <input type="number" id="salesDiscount" min="0" max="100" value="0" onchange="calculateSalesAmount()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Subtotal</label>
                            <input type="number" id="salesSubtotal" readonly>
                        </div>
                        ${systemConfig.enableVAT ? `
                        <div class="form-group">
                            <label>VAT (${systemConfig.vatRate}%)</label>
                            <input type="number" id="salesVAT" readonly>
                        </div>
                        ` : ''}
                        <div class="form-group">
                            <label>Total Amount</label>
                            <input type="number" id="salesTotal" readonly style="font-weight: bold; font-size: 16px;">
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="paymentMethod">
                                <option value="cash">Cash</option>
                                <option value="card">Credit/Debit Card</option>
                                <option value="mobile">Mobile Money</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="credit">Credit</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea rows="3" placeholder="Additional notes or special instructions"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <button class="btn btn-success" onclick="saveSaleTransaction('${salesType}')">
                            <i class="fas fa-save"></i> Save Sale
                        </button>
                        <button class="btn btn-primary" onclick="processSalePayment()">
                            <i class="fas fa-money-bill"></i> Process Payment
                        </button>
                        <button class="btn btn-info" onclick="printSalesReceipt()">
                            <i class="fas fa-print"></i> Print Receipt
                        </button>
                        <button class="btn btn-warning" onclick="clearSalesForm()">
                            <i class="fas fa-broom"></i> Clear Form
                        </button>
                    </div>
                </div>
            `;
        }

        function updateSalesItemDetails() {
            const itemId = document.getElementById('salesItem').value;
            const item = items.find(i => i.id === itemId);
            if (item) {
                const salesType = document.getElementById('salesType').value;
                const price = salesType.includes('wholesale') ? item.factoryPrice : item.retailPrice;
                document.getElementById('salesPrice').value = price || 0;
                calculateSalesAmount();
            }
        }

        function calculateSalesAmount() {
            const qty = parseFloat(document.getElementById('salesQty').value) || 0;
            const price = parseFloat(document.getElementById('salesPrice').value) || 0;
            const discount = parseFloat(document.getElementById('salesDiscount').value) || 0;
            
            const subtotal = qty * price;
            const discountAmount = subtotal * (discount / 100);
            const afterDiscount = subtotal - discountAmount;
            
            document.getElementById('salesSubtotal').value = afterDiscount.toFixed(2);
            
            if (systemConfig.enableVAT) {
                const vatAmount = afterDiscount * (systemConfig.vatRate / 100);
                document.getElementById('salesVAT').value = vatAmount.toFixed(2);
                document.getElementById('salesTotal').value = (afterDiscount + vatAmount).toFixed(2);
            } else {
                document.getElementById('salesTotal').value = afterDiscount.toFixed(2);
            }
        }

        function saveSaleTransaction(salesType) {
            const transaction = {
                id: salesType.toUpperCase().replace(/-/g, '') + '-' + Date.now(),
                type: salesType,
                date: new Date().toISOString().split('T')[0],
                amount: parseFloat(document.getElementById('salesTotal').value) || 0,
                customer: document.getElementById('salesCustomer').value,
                status: 'completed',
                createdBy: currentUser.fullName
            };
            
            transactions.push(transaction);
            salesData.push(transaction);
            
            // Update inventory
            const itemId = document.getElementById('salesItem').value;
            const qty = parseFloat(document.getElementById('salesQty').value) || 0;
            const item = items.find(i => i.id === itemId);
            if (item && qty > 0) {
                item.stock = Math.max(0, item.stock - qty);
                item.status = item.stock <= item.minStock ? 'Low Stock' : 'In Stock';
                
                // Record stock movement
                const stockMovement = {
                    id: 'STK-' + Date.now(),
                    itemId: item.id,
                    itemName: item.name,
                    type: 'Sale',
                    quantity: -qty,
                    date: new Date().toISOString().split('T')[0],
                    user: currentUser.fullName,
                    notes: `Sale transaction: ${transaction.id}`
                };
                stockMovements.push(stockMovement);
            }
            
            // Add to accounting books
            addAccountingEntry({
                account: 'Sales Revenue',
                type: 'Credit',
                amount: transaction.amount,
                reference: transaction.id,
                description: `Sale: ${salesType}`
            });
            
            addAccountingEntry({
                account: 'Cash',
                type: 'Debit',
                amount: transaction.amount,
                reference: transaction.id,
                description: `Sale: ${salesType}`
            });
            
            refreshItemsTable();
            updateNotificationCount();
            showNotification(`${salesType.replace('-', ' ')} saved successfully!`, 'success');
        }

        function clearSalesForm() {
            document.querySelectorAll('#salesModule input[type="number"]').forEach(input => {
                if (!input.readOnly) input.value = '';
            });
            document.querySelectorAll('#salesModule select').forEach(select => {
                if (!select.disabled) select.selectedIndex = 0;
            });
        }

        function newSaleTransaction() {
            const salesType = document.getElementById('salesType').value;
            if (!salesType) {
                showNotification('Please select a sales type first', 'warning');
                return;
            }
            
            loadSalesModule();
            showNotification('New sales transaction form loaded', 'info');
        }

        // POS System Functions
        function openPOS() {
            document.getElementById('salesType').value = 'customer-screen';
            loadSalesModule();
            showNotification('POS system opened', 'info');
        }

        function loadPOSItems() {
            const itemGrid = document.getElementById('itemGrid');
            itemGrid.innerHTML = '';
            
            items.forEach(item => {
                if (item.stock > 0) {
                    const itemCard = document.createElement('div');
                    itemCard.className = 'item-card';
                    itemCard.innerHTML = `
                        <h5>${item.name}</h5>
                        <p>Stock: ${item.stock}</p>
                        <p class="text-success font-bold">${formatCurrency(item.retailPrice)}</p>
                        <button class="btn btn-primary" onclick="addToCart('${item.id}')">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    `;
                    itemGrid.appendChild(itemCard);
                }
            });
        }

        function addToCart(itemId) {
            const item = items.find(i => i.id === itemId);
            if (!item) return;
            
            const existingItem = currentCart.find(c => c.id === itemId);
            if (existingItem) {
                if (existingItem.quantity < item.stock) {
                    existingItem.quantity++;
                    existingItem.total = existingItem.quantity * existingItem.price;
                }
            } else {
                currentCart.push({
                    id: itemId,
                    name: item.name,
                    price: item.retailPrice,
                    quantity: 1,
                    total: item.retailPrice
                });
            }
            
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            cartItems.innerHTML = '';
            
            let subtotal = 0;
            
            currentCart.forEach((cartItem, index) => {
                subtotal += cartItem.total;
                
                const cartItemDiv = document.createElement('div');
                cartItemDiv.className = 'cart-item';
                cartItemDiv.innerHTML = `
                    <div>
                        <strong>${cartItem.name}</strong><br>
                        ${formatCurrency(cartItem.price)} x ${cartItem.quantity}
                    </div>
                    <div>
                        <button class="btn btn-warning" onclick="removeFromCart(${index})" style="padding: 5px;">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span style="margin: 0 10px;">${formatCurrency(cartItem.total)}</span>
                        <button class="btn btn-primary" onclick="addQuantity(${index})" style="padding: 5px;">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                `;
                cartItems.appendChild(cartItemDiv);
            });
            
            const taxAmount = systemConfig.enableVAT ? subtotal * (systemConfig.vatRate / 100) : 0;
            const grandTotal = subtotal + taxAmount;
            
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('taxAmount').textContent = formatCurrency(taxAmount);
            document.getElementById('grandTotal').textContent = formatCurrency(grandTotal);
        }

        function addQuantity(index) {
            const cartItem = currentCart[index];
            const item = items.find(i => i.id === cartItem.id);
            if (cartItem.quantity < item.stock) {
                cartItem.quantity++;
                cartItem.total = cartItem.quantity * cartItem.price;
                updateCartDisplay();
            }
        }

        function removeFromCart(index) {
            const cartItem = currentCart[index];
            if (cartItem.quantity > 1) {
                cartItem.quantity--;
                cartItem.total = cartItem.quantity * cartItem.price;
            } else {
                currentCart.splice(index, 1);
            }
            updateCartDisplay();
        }

        function clearCart() {
            currentCart = [];
            updateCartDisplay();
            showNotification('Cart cleared', 'info');
        }

        function processPayment() {
            if (currentCart.length === 0) {
                showNotification('Cart is empty', 'warning');
                return;
            }
            
            const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace(/[^\d.-]/g, ''));
            const taxAmount = parseFloat(document.getElementById('taxAmount').textContent.replace(/[^\d.-]/g, ''));
            const grandTotal = parseFloat(document.getElementById('grandTotal').textContent.replace(/[^\d.-]/g, ''));
            
            // Create sale transaction
            const saleId = 'POS-' + Date.now();
            const transaction = {
                id: saleId,
                type: 'pos-sale',
                date: new Date().toISOString().split('T')[0],
                items: [...currentCart],
                subtotal: subtotal,
                tax: taxAmount,
                total: grandTotal,
                status: 'completed',
                createdBy: currentUser.fullName
            };
            
            transactions.push(transaction);
            salesData.push(transaction);
            
            // Update inventory
            currentCart.forEach(cartItem => {
                const item = items.find(i => i.id === cartItem.id);
                if (item) {
                    item.stock -= cartItem.quantity;
                    item.status = item.stock <= item.minStock ? 'Low Stock' : 'In Stock';
                    
                    // Record stock movement
                    const stockMovement = {
                        id: 'STK-' + Date.now(),
                        itemId: item.id,
                        itemName: item.name,
                        type: 'POS Sale',
                        quantity: -cartItem.quantity,
                        date: new Date().toISOString().split('T')[0],
                        user: currentUser.fullName,
                        notes: `POS Sale: ${saleId}`
                    };
                    stockMovements.push(stockMovement);
                }
            });
            
            // Add to accounting books
            addAccountingEntry({
                account: 'Sales Revenue',
                type: 'Credit',
                amount: grandTotal,
                reference: saleId,
                description: 'POS Sale'
            });
            
            addAccountingEntry({
                account: 'Cash',
                type: 'Debit',
                amount: grandTotal,
                reference: saleId,
                description: 'POS Sale'
            });
            
            clearCart();
            loadPOSItems();
            updateNotificationCount();
            showNotification('Payment processed successfully!', 'success');
        }

        function printReceipt() {
            if (currentCart.length === 0) {
                showNotification('Cart is empty', 'warning');
                return;
            }
            
            generateAndPrintReceipt();
        }

        function generateAndPrintReceipt() {
            const receiptTemplate = document.getElementById('receiptTemplate').cloneNode(true);
            receiptTemplate.style.display = 'block';
            receiptTemplate.id = 'printableReceipt';
            
            // Fill receipt data
            receiptTemplate.querySelector('#receiptCompanyName').textContent = systemConfig.companyName;
            receiptTemplate.querySelector('#receiptCompanyAddress').textContent = systemConfig.address || 'Company Address';
            receiptTemplate.querySelector('#receiptCompanyPhone').textContent = `Phone: ${systemConfig.phone || '+256-000-000-000'}`;
            receiptTemplate.querySelector('#receiptNumber').textContent = 'R' + (++receiptCounter);
            receiptTemplate.querySelector('#receiptDate').textContent = new Date().toLocaleString();
            receiptTemplate.querySelector('#receiptCashier').textContent = currentUser.fullName;
            
            // Fill items
            const itemsContainer = receiptTemplate.querySelector('#receiptItems');
            itemsContainer.innerHTML = '';
            
            currentCart.forEach(cartItem => {
                const itemDiv = document.createElement('div');
                itemDiv.style.display = 'flex';
                itemDiv.style.justifyContent = 'space-between';
                itemDiv.innerHTML = `
                    <span>${cartItem.name} x${cartItem.quantity}</span>
                    <span>${formatCurrency(cartItem.total)}</span>
                `;
                itemsContainer.appendChild(itemDiv);
            });
            
            // Fill totals
            receiptTemplate.querySelector('#receiptSubtotal').textContent = document.getElementById('subtotal').textContent;
            receiptTemplate.querySelector('#receiptTax').textContent = document.getElementById('taxAmount').textContent;
            receiptTemplate.querySelector('#receiptGrandTotal').textContent = document.getElementById('grandTotal').textContent;
            
            // Add to body and print
            document.body.appendChild(receiptTemplate);
            
            setTimeout(() => {
                window.print();
                document.body.removeChild(receiptTemplate);
            }, 100);
        }

        // Transaction module functionality
        function loadTransactionModule() {
            const transactionType = document.getElementById('transactionType').value;
            const moduleContainer = document.getElementById('transactionModule');
            const purchaseControls = document.getElementById('purchaseControls');
            
            if (!transactionType) {
                moduleContainer.innerHTML = `
                    <div class="card">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-clipboard-list" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                            <h3 style="color: #1a237e; margin-bottom: 10px;">Select Transaction Type</h3>
                            <p style="color: #666;">Choose a transaction type from the dropdown above to get started.</p>
                        </div>
                    </div>
                `;
                purchaseControls.classList.remove('active');
                return;
            }

            if (transactionType === 'purchase-expense') {
                purchaseControls.classList.add('active');
                moduleContainer.innerHTML = `
                    <div class="card">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-shopping-cart" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                            <h3 style="color: #1a237e; margin-bottom: 10px;">Purchase & Expense Module</h3>
                            <p style="color: #666;">Select a specific purchase type from the dropdown above to continue.</p>
                        </div>
                    </div>
                `;
            } else if (transactionType === 'cash-receipts') {
                moduleContainer.innerHTML = generateCashReceiptsInterface();
                purchaseControls.classList.remove('active');
            } else {
                purchaseControls.classList.remove('active');
                let moduleContent = generateGenericTransactionInterface(transactionType);
                moduleContainer.innerHTML = moduleContent;
            }
        }

        function loadPurchaseSubModule() {
            const purchaseSubType = document.getElementById('purchaseSubType').value;
            const moduleContainer = document.getElementById('transactionModule');
            
            if (!purchaseSubType) return;

            let moduleContent = '';
            
            switch(purchaseSubType) {
                case 'purchase-order':
                    moduleContent = generatePurchaseOrderInterface();
                    break;
                case 'purchase-invoice':
                    moduleContent = generatePurchaseInvoiceInterface();
                    break;
                case 'goods-services':
                    moduleContent = generateGoodsServicesInterface();
                    break;
                case 'expenses':
                    moduleContent = generateExpensesInterface();
                    break;
                case 'assets':
                    moduleContent = generateAssetsInterface();
                    break;
                default:
                    moduleContent = generateGenericTransactionInterface(purchaseSubType);
            }
            
            moduleContainer.innerHTML = moduleContent;
        }

        function generatePurchaseOrderInterface() {
            return `
                <div class="card">
                    <h3><i class="fas fa-shopping-cart"></i> Purchase Order</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>PO Number</label>
                            <input type="text" value="PO-${Date.now()}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>Supplier</label>
                            <select id="purchaseSupplier">
                                <option>Select Supplier...</option>
                                ${partners.filter(p => p.type === 'supplier' || p.type === 'both')
                                  .map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Expected Delivery</label>
                            <input type="date">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Item</label>
                            <select id="purchaseItem" onchange="updatePurchaseItemDetails()">
                                <option>Select Item...</option>
                                ${items.map(item => `<option value="${item.id}">${item.name} - ${formatCurrency(item.factoryPrice || item.retailPrice)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" id="purchaseQty" min="1" value="1" onchange="calculatePurchaseAmount()">
                        </div>
                        <div class="form-group">
                            <label>Unit Cost</label>
                            <input type="number" id="purchaseCost" step="0.01" onchange="calculatePurchaseAmount()">
                        </div>
                        <div class="form-group">
                            <label>Total Amount</label>
                            <input type="number" id="purchaseTotal" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea rows="3" placeholder="Additional notes or requirements"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <button class="btn btn-success" onclick="savePurchaseOrder()">
                            <i class="fas fa-save"></i> Save Purchase Order
                        </button>
                        <button class="btn btn-primary" onclick="sendPurchaseOrder()">
                            <i class="fas fa-paper-plane"></i> Send to Supplier
                        </button>
                        <button class="btn btn-warning" onclick="clearPurchaseForm()">
                            <i class="fas fa-broom"></i> Clear Form
                        </button>
                        <button class="btn btn-info" onclick="printPage()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
            `;
        }

        function generatePurchaseInvoiceInterface() {
            return `
                <div class="card">
                    <h3><i class="fas fa-file-invoice"></i> Purchase Invoice</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Invoice Number</label>
                            <input type="text" value="PI-${Date.now()}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Supplier Invoice No.</label>
                            <input type="text" placeholder="Supplier's invoice number">
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Supplier</label>
                            <select>
                                <option>Select Supplier...</option>
                                ${partners.filter(p => p.type === 'supplier' || p.type === 'both')
                                  .map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <select>
                                <option>Net 30</option>
                                <option>Net 15</option>
                                <option>Immediate</option>
                                <option>Cash on Delivery</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Currency</label>
                            <select>
                                <option value="${systemConfig.currency}">${systemConfig.currency}</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Item</label>
                            <select>
                                <option>Select Item...</option>
                                ${items.map(item => `<option value="${item.id}">${item.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantity Received</label>
                            <input type="number" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label>Unit Cost</label>
                            <input type="number" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Update Stock?</label>
                            <label class="switch">
                                <input type="checkbox" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    ${systemConfig.enableVAT ? `
                    <div class="form-row">
                        <div class="form-group">
                            <label>VAT Amount</label>
                            <input type="number" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                            <label>Total Amount</label>
                            <input type="number" step="0.01" readonly>
                        </div>
                    </div>
                    ` : ''}
                    <div class="form-row">
                        <button class="btn btn-success" onclick="saveTransaction('purchase-invoice')">
                            <i class="fas fa-save"></i> Save Invoice
                        </button>
                        <button class="btn btn-primary" onclick="recordPayment()">
                            <i class="fas fa-money-bill"></i> Record Payment
                        </button>
                        <button class="btn btn-info" onclick="printPage()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
            `;
        }

        function generateExpensesInterface() {
            return `
                <div class="card">
                    <h3><i class="fas fa-receipt"></i> Business Expenses</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Expense Number</label>
                            <input type="text" value="EXP-${Date.now()}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>Expense Category</label>
                            <select id="expenseCategory">
                                <option value="office-supplies">Office Supplies</option>
                                <option value="utilities">Utilities</option>
                                <option value="rent">Rent & Facilities</option>
                                <option value="transport">Transport</option>
                                <option value="marketing">Marketing</option>
                                <option value="insurance">Insurance</option>
                                <option value="professional-fees">Professional Fees</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select>
                                <option value="cash">Cash</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="mobile">Mobile Money</option>
                                <option value="card">Credit/Debit Card</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Payee/Supplier</label>
                            <input type="text" placeholder="Who was paid?">
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Reference/Receipt No.</label>
                            <input type="text" placeholder="Receipt or reference number">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Description</label>
                            <textarea rows="3" placeholder="Detailed description of the expense"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <button class="btn btn-success" onclick="saveTransaction('expense')">
                            <i class="fas fa-save"></i> Save Expense
                        </button>
                        <button class="btn btn-primary" onclick="attachReceipt()">
                            <i class="fas fa-paperclip"></i> Attach Receipt
                        </button>
                        <button class="btn btn-info" onclick="printPage()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
            `;
        }

        function generateAssetsInterface() {
            return `
                <div class="card">
                    <h3><i class="fas fa-desktop"></i> Asset Purchase</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Asset Number</label>
                            <input type="text" value="AST-${Date.now()}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Purchase Date</label>
                            <input type="date" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>Asset Category</label>
                            <select id="assetCategory">
                                <option value="equipment">Equipment</option>
                                <option value="furniture">Furniture</option>
                                <option value="vehicles">Vehicles</option>
                                <option value="computers">Computers & IT</option>
                                <option value="machinery">Machinery</option>
                                <option value="property">Property</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Supplier</label>
                            <select>
                                <option>Select Supplier...</option>
                                ${partners.filter(p => p.type === 'supplier' || p.type === 'both')
                                  .map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Asset Name</label>
                            <input type="text" placeholder="Name/Description of asset">
                        </div>
                        <div class="form-group">
                            <label>Model/Serial Number</label>
                            <input type="text" placeholder="Model or serial number">
                        </div>
                        <div class="form-group">
                            <label>Purchase Cost</label>
                            <input type="number" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Useful Life (Years)</label>
                            <input type="number" min="1" max="50" value="5">
                        </div>
                    </div>
                    <div class="form-row">
                        <button class="btn btn-success" onclick="saveTransaction('asset')">
                            <i class="fas fa-save"></i> Save Asset
                        </button>
                        <button class="btn btn-primary" onclick="generateAssetTag()">
                            <i class="fas fa-tags"></i> Generate Asset Tag
                        </button>
                        <button class="btn btn-info" onclick="printPage()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
            `;
        }

        function generateGoodsServicesInterface() {
            return `
                <div class="card">
                    <h3><i class="fas fa-truck"></i> GOODS AND SERVICE - Purchase Invoice (For Sale)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>From</label>
                            <input type="text" value="KITINTALE" placeholder="Enter location">
                        </div>
                        <div class="form-group">
                            <label>Currency</label>
                            <select id="gsCurrency">
                                <option value="UGX">UGX</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Date</label>
                            <input type="date" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>Purchase Invoice No</label>
                            <input type="text" value="PI-${Date.now()}" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Purchase Order Ref</label>
                            <input type="text" placeholder="Reference number">
                        </div>
                        <div class="form-group">
                            <label>Supplier</label>
                            <select id="gsSupplier" onchange="loadSupplierDetails()">
                                <option value="">Select Supplier...</option>
                                ${partners.filter(p => p.type === 'supplier' || p.type === 'both')
                                  .map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Supplier Invoice No.</label>
                            <input type="text" placeholder="Supplier's invoice number">
                        </div>
                        <div class="form-group">
                            <label>Payable (UGX)</label>
                            <input type="number" id="gsPayable" value="0" step="0.01">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Prepaid (UGX)</label>
                            <input type="number" id="gsPrepaid" value="0" step="0.01">
                        </div>
                    </div>
                    
                    <h4 style="color: #1a237e; margin: 20px 0;"><i class="fas fa-box"></i> Item Details</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Item Description</label>
                            <input type="text" id="gsItemDesc" placeholder="Enter item description" list="itemSuggestions">
                            <datalist id="itemSuggestions">
                                ${items.map(item => `<option value="${item.name}">`).join('')}
                            </datalist>
                        </div>
                        <div class="form-group">
                            <label>Unit</label>
                            <select id="gsUnit">
                                <option value="PCS">PCS</option>
                                <option value="KG">KG</option>
                                <option value="L">L</option>
                                <option value="M">M</option>
                                <option value="BOX">BOX</option>
                                <option value="SET">SET</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Qty</label>
                            <input type="number" id="gsQty" value="1" min="0" onchange="calculateGSAmount()">
                        </div>
                        <div class="form-group">
                            <label>Unit Price</label>
                            <input type="number" id="gsUnitPrice" value="0" step="0.01" onchange="calculateGSAmount()">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Unit VAT</label>
                            <input type="number" id="gsUnitVAT" value="0" step="0.01" onchange="calculateGSAmount()">
                        </div>
                        <div class="form-group">
                            <label>Unit Discount</label>
                            <input type="number" id="gsUnitDiscount" value="0" step="0.01" onchange="calculateGSAmount()">
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" id="gsAmount" value="0" step="0.01" readonly>
                        </div>
                    </div>
                    
                    <h4 style="color: #1a237e; margin: 20px 0;"><i class="fas fa-tags"></i> Batch Information</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Batch</label>
                            <input type="text" id="gsBatch" placeholder="Batch number">
                        </div>
                        <div class="form-group">
                            <label>Manuf Date</label>
                            <input type="date" id="gsManufDate">
                        </div>
                        <div class="form-group">
                            <label>Expiry Date</label>
                            <input type="date" id="gsExpiryDate">
                        </div>
                        <div class="form-group">
                            <label>Excise Duty</label>
                            <input type="number" id="gsExciseDuty" value="0" step="0.01">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-success" onclick="addGSItem()">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                        <button class="btn btn-primary" onclick="clearGSItemForm()">
                            <i class="fas fa-broom"></i> Clear Item
                        </button>
                    </div>
                    
                    <div class="table-container" style="margin: 20px 0;">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Item Description</th>
                                    <th>Unit</th>
                                    <th>Batch No.</th>
                                    <th>Inventory/Cost Account</th>
                                    <th>Qty</th>
                                    <th>Unit Price</th>
                                    <th>Unit VAT</th>
                                    <th>Unit Item Discount</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="gsItemsTable">
                                <tr class="no-records">
                                    <td colspan="11">No records found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Excise Duty</label>
                            <input type="number" id="gsTotalExcise" value="0" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                            <label>Subtotal</label>
                            <input type="number" id="gsSubtotal" value="0" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                            <label>Discount</label>
                            <input type="number" id="gsTotalDiscount" value="0" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                            <label>VAT</label>
                            <input type="number" id="gsTotalVAT" value="0" step="0.01" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cash Discount</label>
                            <input type="number" id="gsCashDiscount" value="0" step="0.01" onchange="calculateGSTotals()">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: bold; font-size: 16px;">TOTAL</label>
                            <input type="number" id="gsGrandTotal" value="0" step="0.01" readonly style="font-weight: bold; font-size: 16px;">
                        </div>
                    </div>
                    
                    <h4 style="color: #1a237e; margin: 20px 0;"><i class="fas fa-money-bill"></i> Payment Information</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Paid Amount</label>
                            <input type="number" id="gsPaidAmount" value="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="gsPaymentMethod">
                                <option value="CASH">CASH</option>
                                <option value="BANK">BANK</option>
                                <option value="MOBILE">MOBILE MONEY</option>
                                <option value="CARD">CARD</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Paid From Account</label>
                            <input type="text" value="COH (ROSCOE COH)" readonly>
                        </div>
                        <div class="form-group">
                            <label>Paid By</label>
                            <input type="text" id="gsPaidBy" placeholder="Payment processed by">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-success" onclick="saveGoodsServices()">
                            <i class="fas fa-save"></i> SAVE
                        </button>
                        <button class="btn btn-warning" onclick="clearGSForm()">
                            <i class="fas fa-broom"></i> CLEAR
                        </button>
                        <button class="btn btn-primary" onclick="newGSDraft()">
                            <i class="fas fa-file"></i> NEW DRAFT
                        </button>
                        <button class="btn btn-info" onclick="printPage()">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <button class="btn btn-secondary" onclick="printLastReceipt()">
                            <i class="fas fa-receipt"></i> Print Receipt
                        </button
                    </div>
                </div>
            `;
        }

        function generateGenericTransactionInterface(type) {
            const title = type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
            return `
                <div class="card">
                    <h3><i class="fas fa-file-alt"></i> ${title}</h3>
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-tools" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                        <h4 style="color: #1a237e; margin-bottom: 10px;">${title} Interface</h4>
                        <p style="color: #666;">This transaction module is ready for implementation. All required fields and functionality will be added based on business requirements.</p>
                        <button class="btn btn-primary mt-20" onclick="showNotification('${title} module is under development', 'info')">
                            <i class="fas fa-cog"></i> Configure Module
                        </button>
                    </div>
                </div>
            `;
        }

        // Enhanced Accounting Functions
        function loadAccountBook() {
            const bookType = document.getElementById('accountBookType').value;
            const moduleContainer = document.getElementById('accountModule');
            
            if (!bookType) {
                moduleContainer.innerHTML = `
                    <div class="card">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-chart-pie" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                            <h3 style="color: #1a237e; margin-bottom: 10px;">Select Account Book</h3>
                            <p style="color: #666;">Choose an account book from the dropdown above to view or manage your accounting records.</p>
                        </div>
                    </div>
                `;
                return;
            }

            let moduleContent = '';
            
            switch(bookType) {
                case 'general-ledger':
                    moduleContent = generateGeneralLedgerInterface();
                    break;
                case 'cash-book':
                    moduleContent = generateCashBookInterface();
                    break;
                case 'sales-book':
                    moduleContent = generateSalesBookInterface();
                    break;
                case 'purchase-book':
                    moduleContent = generatePurchaseBookInterface();
                    break;
                case 'trial-balance':
                    moduleContent = generateTrialBalanceInterface();
                    break;
                case 'profit-loss':
                    moduleContent = generateProfitLossInterface();
                    break;
                case 'balance-sheet':
                    moduleContent = generateBalanceSheetInterface();
                    break;
                case 'chart-of-accounts':
                    moduleContent = generateChartOfAccountsInterface();
                    break;
                default:
                    moduleContent = generateGenericAccountInterface(bookType);
            }
            
            moduleContainer.innerHTML = moduleContent;
        }

        function generateGeneralLedgerInterface() {
            return `
                <div class="card">
                    <h3><i class="fas fa-book"></i> General Ledger</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Account</th>
                                    <th>Reference</th>
                                    <th>Description</th>
                                    <th>Debit</th>
                                    <th>Credit</th>
                                    <th>Balance</th>
                                </tr>
                            </thead>
                            <tbody id="generalLedgerBody">
                                ${generateGeneralLedgerRows()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function generateCashBookInterface() {
            const cashEntries = accountingBooks.cashBook;
            return `
                <div class="card">
                    <h3><i class="fas fa-money-bill-wave"></i> Cash Book</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Reference</th>
                                    <th>Cash In</th>
                                    <th>Cash Out</th>
                                    <th>Balance</th>
                                </tr>
                            </thead>
                            <tbody id="cashBookBody">
                                ${cashEntries.length === 0 ? '<tr class="no-records"><td colspan="6">No cash transactions recorded yet.</td></tr>' : generateCashBookRows()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function generateSalesBookInterface() {
            return `
                <div class="card">
                    <h3><i class="fas fa-shopping-cart"></i> Sales Book</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Invoice No.</th>
                                    <th>Customer</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Tax</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="salesBookBody">
                                ${generateSalesBookRows()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function generatePurchaseBookInterface() {
            return `
                <div class="card">
                    <h3><i class="fas fa-file-invoice"></i> Purchase Book</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Invoice No.</th>
                                    <th>Supplier</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Tax</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseBookBody">
                                ${generatePurchaseBookRows()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function generateTrialBalanceInterface() {
            return `
                <div class="card">
                    <h3><i class="fas fa-balance-scale"></i> Trial Balance</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Account Code</th>
                                    <th>Account Name</th>
                                    <th>Debit Balance</th>
                                    <th>Credit Balance</th>
                                </tr>
                            </thead>
                            <tbody id="trialBalanceBody">
                                ${generateTrialBalanceRows()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function generateProfitLossInterface() {
            const profitLoss = calculateProfitLoss();
            return `
                <div class="card">
                    <h3><i class="fas fa-chart-line"></i> Profit & Loss Statement</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <h4 class="text-success">INCOME</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Account</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Sales Revenue</td>
                                            <td class="text-success">${formatCurrency(profitLoss.income.sales)}</td>
                                        </tr>
                                        <tr>
                                            <td>Other Income</td>
                                            <td class="text-success">${formatCurrency(profitLoss.income.other)}</td>
                                        </tr>
                                        <tr class="font-bold">
                                            <td>Total Income</td>
                                            <td class="text-success">${formatCurrency(profitLoss.income.total)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="form-group">
                            <h4 class="text-danger">EXPENSES</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Account</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Cost of Goods Sold</td>
                                            <td class="text-danger">${formatCurrency(profitLoss.expenses.cogs)}</td>
                                        </tr>
                                        <tr>
                                            <td>Operating Expenses</td>
                                            <td class="text-danger">${formatCurrency(profitLoss.expenses.operating)}</td>
                                        </tr>
                                        <tr class="font-bold">
                                            <td>Total Expenses</td>
                                            <td class="text-danger">${formatCurrency(profitLoss.expenses.total)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="summary-card">
                        <h3>Net Profit/Loss: <span class="${profitLoss.netProfit >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(profitLoss.netProfit)}</span></h3>
                    </div>
                </div>
            `;
        }

        function generateBalanceSheetInterface() {
            const balanceSheet = calculateBalanceSheet();
            return `
                <div class="card">
                    <h3><i class="fas fa-clipboard-list"></i> Balance Sheet</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <h4 class="text-primary">ASSETS</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Account</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${balanceSheet.assets.map(asset => `
                                            <tr>
                                                <td>${asset.name}</td>
                                                <td class="text-primary">${formatCurrency(asset.balance)}</td>
                                            </tr>
                                        `).join('')}
                                        <tr class="font-bold">
                                            <td>Total Assets</td>
                                            <td class="text-primary">${formatCurrency(balanceSheet.totalAssets)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="form-group">
                            <h4 class="text-warning">LIABILITIES & EQUITY</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Account</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${balanceSheet.liabilities.map(liability => `
                                            <tr>
                                                <td>${liability.name}</td>
                                                <td class="text-warning">${formatCurrency(liability.balance)}</td>
                                            </tr>
                                        `).join('')}
                                        ${balanceSheet.equity.map(equity => `
                                            <tr>
                                                <td>${equity.name}</td>
                                                <td class="text-success">${formatCurrency(equity.balance)}</td>
                                            </tr>
                                        `).join('')}
                                        <tr class="font-bold">
                                            <td>Total Liabilities & Equity</td>
                                            <td>${formatCurrency(balanceSheet.totalLiabilitiesEquity)}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateChartOfAccountsInterface() {
            return `
                <div class="card">
                    <h3><i class="fas fa-list"></i> Chart of Accounts</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Account Code</th>
                                    <th>Account Name</th>
                                    <th>Account Type</th>
                                    <th>Balance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${accountingBooks.chartOfAccounts.map(account => `
                                    <tr>
                                        <td>${account.code}</td>
                                        <td>${account.name}</td>
                                        <td>
                                            <span class="price-tag ${getAccountTypeClass(account.type)}">
                                                ${account.type}
                                            </span>
                                        </td>
                                        <td class="font-bold">${formatCurrency(account.balance)}</td>
                                        <td>
                                            <button class="btn btn-primary" onclick="editAccount('${account.code}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function getAccountTypeClass(type) {
            switch(type) {
                case 'Asset': return 'retail-price';
                case 'Liability': return 'factory-price';
                case 'Equity': return 'retail-price';
                case 'Revenue': return 'retail-price';
                case 'Expense': return 'factory-price';
                default: return '';
            }
        }

        // Accounting calculation functions
        function calculateAccountSummary() {
            let totalAssets = 0;
            let totalLiabilities = 0;
            let totalEquity = 0;
            let netProfit = 0;
            
            accountingBooks.chartOfAccounts.forEach(account => {
                switch(account.type) {
                    case 'Asset':
                        totalAssets += account.balance;
                        break;
                    case 'Liability':
                        totalLiabilities += account.balance;
                        break;
                    case 'Equity':
                        totalEquity += account.balance;
                        break;
                }
            });
            
            // Calculate net profit from sales data
            const totalSales = salesData.reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, expense) => sum + (expense.amount || 0), 0);
            netProfit = totalSales - totalExpenses;
            
            // Update UI
            document.getElementById('totalAssets').textContent = formatCurrency(totalAssets);
            document.getElementById('totalLiabilities').textContent = formatCurrency(totalLiabilities);
            document.getElementById('totalEquity').textContent = formatCurrency(totalEquity);
            document.getElementById('netProfit').textContent = formatCurrency(netProfit);
        }

        function calculateProfitLoss() {
            const totalSales = salesData.reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, expense) => sum + (expense.amount || 0), 0);
            const totalCOGS = 0; // Calculate based on cost of items sold
            
            return {
                income: {
                    sales: totalSales,
                    other: 0,
                    total: totalSales
                },
                expenses: {
                    cogs: totalCOGS,
                    operating: totalExpenses,
                    total: totalCOGS + totalExpenses
                },
                netProfit: totalSales - (totalCOGS + totalExpenses)
            };
        }

        function calculateBalanceSheet() {
            const assets = accountingBooks.chartOfAccounts.filter(a => a.type === 'Asset');
            const liabilities = accountingBooks.chartOfAccounts.filter(a => a.type === 'Liability');
            const equity = accountingBooks.chartOfAccounts.filter(a => a.type === 'Equity');
            
            const totalAssets = assets.reduce((sum, asset) => sum + asset.balance, 0);
            const totalLiabilities = liabilities.reduce((sum, liability) => sum + liability.balance, 0);
            const totalEquity = equity.reduce((sum, eq) => sum + eq.balance, 0);
            
            return {
                assets: assets,
                liabilities: liabilities,
                equity: equity,
                totalAssets: totalAssets,
                totalLiabilities: totalLiabilities,
                totalEquity: totalEquity,
                totalLiabilitiesEquity: totalLiabilities + totalEquity
            };
        }

        function generateGeneralLedgerRows() {
            if (accountEntries.length === 0) {
                return '<tr class="no-records"><td colspan="7">No general ledger entries recorded yet.</td></tr>';
            }
            
            return accountEntries.map(entry => `
                <tr>
                    <td>${entry.date}</td>
                    <td>${entry.account}</td>
                    <td>${entry.reference}</td>
                    <td>${entry.description}</td>
                    <td class="text-success">${entry.type === 'Debit' ? formatCurrency(entry.amount) : ''}</td>
                    <td class="text-danger">${entry.type === 'Credit' ? formatCurrency(entry.amount) : ''}</td>
                    <td>${formatCurrency(entry.balance || 0)}</td>
                </tr>
            `).join('');
        }

        function generateCashBookRows() {
            // Generate cash book entries based on cash transactions
            const cashTransactions = transactions.filter(t => t.paymentMethod === 'cash' || t.type === 'cash-receipts' || t.type === 'cash-payments');
            let balance = 0;
            
            if (cashTransactions.length === 0) {
                return '<tr class="no-records"><td colspan="6">No cash transactions recorded yet.</td></tr>';
            }
            
            return cashTransactions.map(transaction => {
                const isIncoming = transaction.type.includes('receipt') || transaction.type.includes('sale');
                const amount = transaction.amount || transaction.total || 0;
                balance += isIncoming ? amount : -amount;
                
                return `
                    <tr>
                        <td>${transaction.date}</td>
                        <td>${transaction.description || transaction.type}</td>
                        <td>${transaction.id}</td>
                        <td class="text-success">${isIncoming ? formatCurrency(amount) : ''}</td>
                        <td class="text-danger">${!isIncoming ? formatCurrency(amount) : ''}</td>
                        <td class="font-bold">${formatCurrency(balance)}</td>
                    </tr>
                `;
            }).join('');
        }

        function generateSalesBookRows() {
            if (salesData.length === 0) {
                return '<tr class="no-records"><td colspan="7">No sales transactions recorded yet.</td></tr>';
            }
            
            return salesData.map(sale => {
                const taxAmount = sale.tax || (systemConfig.enableVAT ? (sale.amount * systemConfig.vatRate / 100) : 0);
                const total = sale.total || sale.amount || 0;
                
                return `
                    <tr>
                        <td>${sale.date}</td>
                        <td>${sale.id}</td>
                        <td>${getCustomerName(sale.customer) || 'Walk-in Customer'}</td>
                        <td>${sale.type || 'Sale'}</td>
                        <td class="text-success">${formatCurrency(total - taxAmount)}</td>
                        <td class="text-warning">${formatCurrency(taxAmount)}</td>
                        <td class="font-bold">${formatCurrency(total)}</td>
                    </tr>
                `;
            }).join('');
        }

        function generatePurchaseBookRows() {
            const purchaseTransactions = transactions.filter(t => t.type.includes('purchase'));
            
            if (purchaseTransactions.length === 0) {
                return '<tr class="no-records"><td colspan="7">No purchase transactions recorded yet.</td></tr>';
            }
            
            return purchaseTransactions.map(purchase => {
                const taxAmount = systemConfig.enableVAT ? (purchase.amount * systemConfig.vatRate / 100) : 0;
                
                return `
                    <tr>
                        <td>${purchase.date}</td>
                        <td>${purchase.id}</td>
                        <td>${getSupplierName(purchase.supplier) || 'Unknown Supplier'}</td>
                        <td>${purchase.type}</td>
                        <td class="text-primary">${formatCurrency(purchase.amount - taxAmount)}</td>
                        <td class="text-warning">${formatCurrency(taxAmount)}</td>
                        <td class="font-bold">${formatCurrency(purchase.amount)}</td>
                    </tr>
                `;
            }).join('');
        }

        function generateTrialBalanceRows() {
            let totalDebits = 0;
            let totalCredits = 0;
            
            const rows = accountingBooks.chartOfAccounts.map(account => {
                const isDebitBalance = ['Asset', 'Expense'].includes(account.type);
                if (isDebitBalance) totalDebits += account.balance;
                else totalCredits += account.balance;
                
                return `
                    <tr>
                        <td>${account.code}</td>
                        <td>${account.name}</td>
                        <td class="text-success">${isDebitBalance ? formatCurrency(account.balance) : ''}</td>
                        <td class="text-danger">${!isDebitBalance ? formatCurrency(account.balance) : ''}</td>
                    </tr>
                `;
            }).join('');
            
            const totalRow = `
                <tr class="font-bold" style="border-top: 2px solid #1a237e;">
                    <td colspan="2">TOTALS</td>
                    <td class="text-success">${formatCurrency(totalDebits)}</td>
                    <td class="text-danger">${formatCurrency(totalCredits)}</td>
                </tr>
            `;
            
            return rows + totalRow;
        }

        function addAccountingEntry(entry) {
            const accountEntry = {
                id: 'ACC-' + Date.now(),
                date: new Date().toISOString().split('T')[0],
                account: entry.account,
                type: entry.type, // 'Debit' or 'Credit'
                amount: entry.amount,
                reference: entry.reference,
                description: entry.description,
                balance: 0
            };
            
            accountEntries.push(accountEntry);
            
            // Update account balance
            const account = accountingBooks.chartOfAccounts.find(a => a.name === entry.account);
            if (account) {
                if (entry.type === 'Debit') {
                    if (['Asset', 'Expense'].includes(account.type)) {
                        account.balance += entry.amount;
                    } else {
                        account.balance -= entry.amount;
                    }
                } else { // Credit
                    if (['Asset', 'Expense'].includes(account.type)) {
                        account.balance -= entry.amount;
                    } else {
                        account.balance += entry.amount;
                    }
                }
            }
        }

        function getCustomerName(customerId) {
            const customer = partners.find(p => p.id === customerId);
            return customer ? customer.name : null;
        }

        function getSupplierName(supplierId) {
            const supplier = partners.find(p => p.id === supplierId);
            return supplier ? supplier.name : null;
        }

        // Enhanced Reports Functions
        function loadReport() {
            const reportType = document.getElementById('reportType').value;
            const moduleContainer = document.getElementById('reportModule');
            
            if (!reportType) {
                moduleContainer.innerHTML = `
                    <div class="card">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-chart-area" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                            <h3 style="color: #1a237e; margin-bottom: 10px;">Select Report Type</h3>
                            <p style="color: #666;">Choose a report type and date range from the dropdowns above to generate comprehensive business reports.</p>
                        </div>
                    </div>
                `;
                return;
            }

            let moduleContent = generateReportInterface(reportType);
            moduleContainer.innerHTML = moduleContent;
        }

        function generateReportInterface(reportType) {
            const title = reportType.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            switch(reportType) {
                case 'daily-sales':
                    return generateDailySalesReport();
                case 'monthly-sales':
                    return generateMonthlySalesReport();
                case 'stock-report':
                    return generateStockReport();
                case 'low-stock':
                    return generateLowStockReport();
                case 'income-statement':
                    return generateIncomeStatementReport();
                case 'cash-flow':
                    return generateCashFlowReport();
                default:
                    return `
                        <div class="card">
                            <h3><i class="fas fa-chart-bar"></i> ${title}</h3>
                            <div style="text-align: center; padding: 40px;">
                                <i class="fas fa-file-alt" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                                <h4 style="color: #1a237e; margin-bottom: 10px;">${title} Report</h4>
                                <p style="color: #666;">This report module is ready for implementation with customized data analysis and visualization.</p>
                                <button class="btn btn-primary mt-20" onclick="showNotification('${title} report is under development', 'info')">
                                    <i class="fas fa-cog"></i> Configure Report
                                </button>
                            </div>
                        </div>
                    `;
            }
        }

        function generateDailySalesReport() {
            const today = new Date().toISOString().split('T')[0];
            const todaySales = salesData.filter(sale => sale.date === today);
            const totalSales = todaySales.reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);
            
            return `
                <div class="card">
                    <h3><i class="fas fa-calendar-day"></i> Daily Sales Report</h3>
                    <div class="summary-card">
                        <h4>Today's Sales Summary (${today})</h4>
                        <p>Total Transactions: ${todaySales.length}</p>
                        <p class="text-success font-bold">Total Sales: ${formatCurrency(totalSales)}</p>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Invoice No.</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${todaySales.length === 0 ? 
                                    '<tr class="no-records"><td colspan="5">No sales recorded for today.</td></tr>' :
                                    todaySales.map(sale => `
                                        <tr>
                                            <td>${new Date(sale.date).toLocaleTimeString()}</td>
                                            <td>${sale.id}</td>
                                            <td>${getCustomerName(sale.customer) || 'Walk-in Customer'}</td>
                                            <td>${sale.items ? sale.items.length : 1}</td>
                                            <td class="text-success font-bold">${formatCurrency(sale.total || sale.amount)}</td>
                                        </tr>
                                    `).join('')
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function generateMonthlySalesReport() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlySales = salesData.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
            const totalSales = monthlySales.reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);
            
            return `
                <div class="card">
                    <h3><i class="fas fa-calendar-alt"></i> Monthly Sales Report</h3>
                    <div class="summary-card">
                        <h4>This Month's Sales Summary</h4>
                        <p>Total Transactions: ${monthlySales.length}</p>
                        <p class="text-success font-bold">Total Sales: ${formatCurrency(totalSales)}</p>
                        <p>Average per Transaction: ${formatCurrency(monthlySales.length > 0 ? totalSales / monthlySales.length : 0)}</p>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Invoice No.</th>
                                    <th>Customer</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${monthlySales.length === 0 ? 
                                    '<tr class="no-records"><td colspan="5">No sales recorded for this month.</td></tr>' :
                                    monthlySales.map(sale => `
                                        <tr>
                                            <td>${sale.date}</td>
                                            <td>${sale.id}</td>
                                            <td>${getCustomerName(sale.customer) || 'Walk-in Customer'}</td>
                                            <td>${sale.type || 'Sale'}</td>
                                            <td class="text-success font-bold">${formatCurrency(sale.total || sale.amount)}</td>
                                        </tr>
                                    `).join('')
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function generateStockReport() {
            const totalStockValue = items.reduce((sum, item) => sum + (item.stock * (item.retailPrice || 0)), 0);
            
            return `
                <div class="card">
                    <h3><i class="fas fa-boxes"></i> Stock Report</h3>
                    <div class="summary-card">
                        <h4>Current Stock Summary</h4>
                        <p>Total Items: ${items.length}</p>
                        <p>Items in Stock: ${items.filter(item => item.stock > 0).length}</p>
                        <p>Out of Stock: ${items.filter(item => item.stock === 0).length}</p>
                        <p class="text-success font-bold">Total Stock Value: ${formatCurrency(totalStockValue)}</p>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Stock Qty</th>
                                    <th>Unit Price</th>
                                    <th>Stock Value</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.length === 0 ? 
                                    '<tr class="no-records"><td colspan="7">No items in inventory.</td></tr>' :
                                    items.map(item => `
                                        <tr>
                                            <td>${item.code}</td>
                                            <td>${item.name}</td>
                                            <td>${item.category}</td>
                                            <td>${item.stock}</td>
                                            <td>${formatCurrency(item.retailPrice)}</td>
                                            <td class="font-bold">${formatCurrency(item.stock * item.retailPrice)}</td>
                                            <td>
                                                <span class="price-tag ${item.status === 'Low Stock' ? 'retail-price' : 'factory-price'}">
                                                    ${item.status}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function generateLowStockReport() {
            const lowStockItems = items.filter(item => item.stock <= item.minStock);
            
            return `
                <div class="card">
                    <h3><i class="fas fa-exclamation-triangle"></i> Low Stock Report</h3>
                    <div class="summary-card" style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);">
                        <h4>Low Stock Alert</h4>
                        <p>Items Below Minimum Stock: ${lowStockItems.length}</p>
                        <p>Action Required: Reorder these items immediately</p>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Item Name</th>
                                    <th>Current Stock</th>
                                    <th>Minimum Stock</th>
                                    <th>Shortage</th>
                                    <th>Suggested Reorder</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lowStockItems.length === 0 ? 
                                    '<tr><td colspan="6" class="text-success text-center">All items are above minimum stock levels.</td></tr>' :
                                    lowStockItems.map(item => {
                                        const shortage = Math.max(0, item.minStock - item.stock);
                                        const suggestedReorder = Math.max(shortage, item.minStock * 2);
                                        return `
                                            <tr>
                                                <td>${item.code}</td>
                                                <td>${item.name}</td>
                                                <td class="text-danger font-bold">${item.stock}</td>
                                                <td>${item.minStock}</td>
                                                <td class="text-danger font-bold">${shortage}</td>
                                                <td class="text-success font-bold">${suggestedReorder}</td>
                                            </tr>
                                        `;
                                    }).join('')
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function generateIncomeStatementReport() {
            const profitLoss = calculateProfitLoss();
            
            return `
                <div class="card">
                    <h3><i class="fas fa-chart-line"></i> Income Statement</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th colspan="2">REVENUE</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Sales Revenue</td>
                                    <td class="text-success font-bold">${formatCurrency(profitLoss.income.sales)}</td>
                                </tr>
                                <tr>
                                    <td>Other Income</td>
                                    <td class="text-success">${formatCurrency(profitLoss.income.other)}</td>
                                </tr>
                                <tr class="font-bold">
                                    <td>Total Revenue</td>
                                    <td class="text-success">${formatCurrency(profitLoss.income.total)}</td>
                                </tr>
                            </tbody>
                        </table>
                        <table style="margin-top: 20px;">
                            <thead>
                                <tr>
                                    <th colspan="2">EXPENSES</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Cost of Goods Sold</td>
                                    <td class="text-danger">${formatCurrency(profitLoss.expenses.cogs)}</td>
                                </tr>
                                <tr>
                                    <td>Operating Expenses</td>
                                    <td class="text-danger">${formatCurrency(profitLoss.expenses.operating)}</td>
                                </tr>
                                <tr class="font-bold">
                                    <td>Total Expenses</td>
                                    <td class="text-danger">${formatCurrency(profitLoss.expenses.total)}</td>
                                </tr>
                            </tbody>
                        </table>
                        <table style="margin-top: 20px;">
                            <thead>
                                <tr>
                                    <th colspan="2">NET RESULT</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="font-bold" style="font-size: 18px;">
                                    <td>Net Profit/(Loss)</td>
                                    <td class="${profitLoss.netProfit >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(profitLoss.netProfit)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function generateCashFlowReport() {
            const cashInflows = salesData.reduce((sum, sale) => sum + (sale.total || sale.amount || 0), 0);
            const cashOutflows = transactions.filter(t => t.type === 'expense').reduce((sum, expense) => sum + (expense.amount || 0), 0);
            const netCashFlow = cashInflows - cashOutflows;
            
            return `
                <div class="card">
                    <h3><i class="fas fa-money-bill-wave"></i> Cash Flow Statement</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th colspan="2">CASH INFLOWS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Sales Collections</td>
                                    <td class="text-success font-bold">${formatCurrency(cashInflows)}</td>
                                </tr>
                                <tr>
                                    <td>Other Receipts</td>
                                    <td class="text-success">0.00</td>
                                </tr>
                                <tr class="font-bold">
                                    <td>Total Cash Inflows</td>
                                    <td class="text-success">${formatCurrency(cashInflows)}</td>
                                </tr>
                            </tbody>
                        </table>
                        <table style="margin-top: 20px;">
                            <thead>
                                <tr>
                                    <th colspan="2">CASH OUTFLOWS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Operating Expenses</td>
                                    <td class="text-danger">${formatCurrency(cashOutflows)}</td>
                                </tr>
                                <tr>
                                    <td>Capital Expenditure</td>
                                    <td class="text-danger">0.00</td>
                                </tr>
                                <tr class="font-bold">
                                    <td>Total Cash Outflows</td>
                                    <td class="text-danger">${formatCurrency(cashOutflows)}</td>
                                </tr>
                            </tbody>
                        </table>
                        <table style="margin-top: 20px;">
                            <thead>
                                <tr>
                                    <th colspan="2">NET CASH FLOW</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="font-bold" style="font-size: 18px;">
                                    <td>Net Cash Flow</td>
                                    <td class="${netCashFlow >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(netCashFlow)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            if (!reportType) {
                showNotification('Please select a report type first', 'warning');
                return;
            }
            
            loadReport();
            showNotification('Report generated successfully', 'success');
        }

        function exportReport() {
            const reportType = document.getElementById('reportType').value;
            if (!reportType) {
                showNotification('Please select and generate a report first', 'warning');
                return;
            }
            
            // Generate CSV export based on report type
            let csvContent = '';
            let filename = '';
            
            switch(reportType) {
                case 'stock-report':
                    csvContent = generateStockCSV();
                    filename = 'stock_report';
                    break;
                case 'daily-sales':
                    csvContent = generateDailySalesCSV();
                    filename = 'daily_sales_report';
                    break;
                case 'monthly-sales':
                    csvContent = generateMonthlySalesCSV();
                    filename = 'monthly_sales_report';
                    break;
                default:
                    csvContent = "Report Type,Data\nGeneric Report,Data not available for export";
                    filename = 'generic_report';
            }
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showNotification('Report exported successfully!', 'success');
        }

        function generateStockCSV() {
            let csvContent = "Item Code,Item Name,Category,Stock Qty,Unit Price,Stock Value,Status\n";
            items.forEach(item => {
                csvContent += `${item.code},${item.name},${item.category},${item.stock},${item.retailPrice},${item.stock * item.retailPrice},${item.status}\n`;
            });
            return csvContent;
        }

        function generateDailySalesCSV() {
            const today = new Date().toISOString().split('T')[0];
            const todaySales = salesData.filter(sale => sale.date === today);
            let csvContent = "Time,Invoice No,Customer,Items,Amount\n";
            todaySales.forEach(sale => {
                csvContent += `${new Date(sale.date).toLocaleTimeString()},${sale.id},${getCustomerName(sale.customer) || 'Walk-in Customer'},${sale.items ? sale.items.length : 1},${sale.total || sale.amount}\n`;
            });
            return csvContent;
        }

        function generateMonthlySalesCSV() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlySales = salesData.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
            let csvContent = "Date,Invoice No,Customer,Type,Amount\n";
            monthlySales.forEach(sale => {
                csvContent += `${sale.date},${sale.id},${getCustomerName(sale.customer) || 'Walk-in Customer'},${sale.type || 'Sale'},${sale.total || sale.amount}\n`;
            });
            return csvContent;
        }

        // Transaction helper functions
        function updatePurchaseItemDetails() {
            const itemId = document.getElementById('purchaseItem').value;
            const item = items.find(i => i.id === itemId);
            if (item) {
                document.getElementById('purchaseCost').value = item.factoryPrice || item.retailPrice || 0;
                calculatePurchaseAmount();
            }
        }

        function calculatePurchaseAmount() {
            const qty = parseFloat(document.getElementById('purchaseQty').value) || 0;
            const cost = parseFloat(document.getElementById('purchaseCost').value) || 0;
            const total = qty * cost;
            document.getElementById('purchaseTotal').value = total.toFixed(2);
        }

        function savePurchaseOrder() {
            const transaction = {
                id: 'PO-' + Date.now(),
                type: 'purchase-order',
                date: new Date().toISOString().split('T')[0],
                amount: parseFloat(document.getElementById('purchaseTotal').value) || 0,
                status: 'pending',
                createdBy: currentUser.fullName
            };
            
            transactions.push(transaction);
            showNotification('Purchase order saved successfully!', 'success');
        }

        function newTransaction() {
            const transactionType = document.getElementById('transactionType').value;
            if (!transactionType) {
                showNotification('Please select a transaction type first', 'warning');
                return;
            }
            
            if (transactionType === 'purchase-expense') {
                const purchaseSubType = document.getElementById('purchaseSubType').value;
                if (!purchaseSubType) {
                    showNotification('Please select a purchase sub-type first', 'warning');
                    return;
                }
            }
            
            loadTransactionModule();
            showNotification('New transaction form loaded', 'info');
        }

        function saveTransaction(type) {
            const transaction = {
                id: type.toUpperCase() + '-' + Date.now(),
                type: type,
                date: new Date().toISOString().split('T')[0],
                user: currentUser.fullName,
                status: 'completed'
            };
            
            transactions.push(transaction);
            showNotification(`${type.replace('-', ' ')} saved successfully!`, 'success');
        }

        function newAccountEntry() {
            const bookType = document.getElementById('accountBookType').value;
            if (!bookType) {
                showNotification('Please select an account book first', 'warning');
                return;
            }
            
            showNotification('New account entry form would open here', 'info');
        }

        function calculateTotals() {
            calculateAccountSummary();
            showNotification('Account totals calculated and updated', 'success');
        }

        // Settings functionality
        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        function toggleVAT() {
            const enableVAT = document.getElementById('enableVAT').checked;
            const vatRateGroup = document.getElementById('vatRateGroup');
            
            if (enableVAT) {
                vatRateGroup.style.display = 'block';
                systemConfig.enableVAT = true;
            } else {
                vatRateGroup.style.display = 'none';
                systemConfig.enableVAT = false;
            }
        }

        function saveCompanyInfo() {
            systemConfig.companyName = document.getElementById('companyName').value;
            systemConfig.mainLocation = document.getElementById('mainLocation').value;
            systemConfig.currency = document.getElementById('companyCurrency').value;
            systemConfig.enableVAT = document.getElementById('enableVAT').checked;
            systemConfig.vatRate = parseFloat(document.getElementById('vatRate').value) || 18;
            systemConfig.phone = document.getElementById('companyPhone').value;
            systemConfig.email = document.getElementById('companyEmail').value;
            systemConfig.address = document.getElementById('companyAddress').value;
            
            // Update header display
            document.getElementById('companyDisplay').textContent = systemConfig.companyName;
            document.getElementById('currentBranch').textContent = systemConfig.mainLocation;
            
            // Update login display
            updateLoginDisplay();
            
            showNotification('Company information saved successfully!', 'success');
        }

        function savePermissions() {
            const permissionInputs = document.querySelectorAll('[data-permission]');
            permissionInputs.forEach(input => {
                userPermissions[input.getAttribute('data-permission')] = input.checked;
            });
            
            showNotification('User permissions saved successfully!', 'success');
        }

        function saveSystemSettings() {
            showNotification('System settings saved successfully!', 'success');
        }

        function saveDeveloperInfo() {
            systemConfig.devInfo = {
                company: document.getElementById('devCompany').value || 'System Developer',
                name: document.getElementById('devName').value || 'Development Team',
                email: document.getElementById('devEmail').value || 'developer@example.com',
                phone: document.getElementById('devPhone').value,
                website: document.getElementById('devWebsite').value,
                support: document.getElementById('supportEmail').value || 'support@example.com'
            };
            
            updateFooter();
            showNotification('Developer information saved successfully!', 'success');
        }

        function updateFooter() {
            document.getElementById('footerDevName').textContent = systemConfig.devInfo.name;
            document.getElementById('footerDevEmail').textContent = systemConfig.devInfo.email;
        }

        // User management functionality
        function loadUsers() {
            const userGrid = document.getElementById('userGrid');
            userGrid.innerHTML = '';
            
            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.innerHTML = `
                    <h4>${user.fullName}</h4>
                    <div class="user-role role-${user.role}">${user.role.toUpperCase()}</div>
                    <p><strong>Username:</strong> ${user.username}</p>
                    <p><strong>Email:</strong> ${user.email || 'Not provided'}</p>
                    <p><strong>Phone:</strong> ${user.phone || 'Not provided'}</p>
                    <p><strong>Status:</strong> ${user.active ? 'Active' : 'Inactive'}</p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="editUser(${user.id})" style="margin-right: 5px;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        ${user.id !== 1 ? `
                        <button class="btn btn-danger" onclick="deleteUser(${user.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        ` : ''}
                    </div>
                `;
                userGrid.appendChild(userCard);
            });
        }

        function addUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const fullName = document.getElementById('newFullName').value.trim();
            const role = document.getElementById('newUserRole').value;
            const email = document.getElementById('newUserEmail').value.trim();
            const phone = document.getElementById('newUserPhone').value.trim();
            
            if (!username || !password || !fullName) {
                showNotification('Please fill in required fields (Username, Password, Full Name)', 'error');
                return;
            }
            
            if (users.find(u => u.username === username)) {
                showNotification('Username already exists!', 'error');
                return;
            }
            
            const newUser = {
                id: users.length + 1,
                username,
                password,
                fullName,
                role,
                email,
                phone,
                active: true
            };
            
            users.push(newUser);
            
            // Clear form
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newFullName').value = '';
            document.getElementById('newUserRole').value = 'user';
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserPhone').value = '';
            
            loadUsers();
            showNotification('User added successfully!', 'success');
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                document.getElementById('newUsername').value = user.username;
                document.getElementById('newPassword').value = user.password;
                document.getElementById('newFullName').value = user.fullName;
                document.getElementById('newUserRole').value = user.role;
                document.getElementById('newUserEmail').value = user.email || '';
                document.getElementById('newUserPhone').value = user.phone || '';
                
                showNotification('User details loaded for editing', 'info');
            }
        }

        function deleteUser(userId) {
            if (userId === 1) {
                showNotification('Cannot delete default admin user!', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this user?')) {
                users = users.filter(u => u.id !== userId);
                loadUsers();
                showNotification('User deleted successfully!', 'success');
            }
        }

        // Item management with stock recording
        function saveItem() {
            if (!checkPermission('item-create')) {
                showNotification('Access denied: Cannot create items', 'error');
                return;
            }
            
            const code = document.getElementById('itemCodeInput').value.trim();
            const name = document.getElementById('itemNameInput').value.trim();
            const category = document.getElementById('itemCategory').value;
            const retailPrice = parseFloat(document.getElementById('itemRetailPrice').value) || 0;
            const factoryPrice = parseFloat(document.getElementById('itemFactoryPrice').value) || 0;
            const stock = parseInt(document.getElementById('itemStock').value) || 0;
            const unit = document.getElementById('itemUnit').value;
            const minStock = parseInt(document.getElementById('itemMinStock').value) || 0;
            
            if (!code || !name || !category) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            const item = {
                id: 'ITM-' + Date.now(),
                code,
                name,
                category,
                retailPrice,
                factoryPrice,
                stock,
                unit,
                minStock,
                status: stock <= minStock ? 'Low Stock' : 'In Stock',
                dateAdded: new Date().toISOString().split('T')[0]
            };
            
            items.push(item);
            
            // Record stock movement
            if (stock > 0) {
                const stockMovement = {
                    id: 'STK-' + Date.now(),
                    itemId: item.id,
                    itemName: item.name,
                    type: 'Initial Stock',
                    quantity: stock,
                    date: new Date().toISOString().split('T')[0],
                    user: currentUser.fullName,
                    notes: 'Initial stock entry'
                };
                stockMovements.push(stockMovement);
            }
            
            refreshItemsTable();
            clearItemForm();
            updateNotificationCount();
            showNotification('Item saved successfully with stock recorded!', 'success');
        }

        function clearItemForm() {
            document.getElementById('itemCodeInput').value = '';
            document.getElementById('itemNameInput').value = '';
            document.getElementById('itemCategory').value = '';
            document.getElementById('itemRetailPrice').value = '';
            document.getElementById('itemFactoryPrice').value = '';
            document.getElementById('itemStock').value = '';
            document.getElementById('itemUnit').value = 'PCS';
            document.getElementById('itemMinStock').value = '';
        }

        function refreshItemsTable() {
            const tbody = document.getElementById('itemsTableBody');
            
            if (items.length === 0) {
                tbody.innerHTML = '<tr class="no-records"><td colspan="8">No items found. Add your first item above.</td></tr>';
                return;
            }
            
            tbody.innerHTML = items.map(item => `
                <tr>
                    <td>${item.code}</td>
                    <td>${item.name}</td>
                    <td>${item.category}</td>
                    <td>${item.stock} ${item.unit}</td>
                    <td class="text-success font-bold">${formatCurrency(item.retailPrice)}</td>
                    <td class="text-primary font-bold">${formatCurrency(item.factoryPrice)}</td>
                    <td>
                        <span class="price-tag ${item.status === 'Low Stock' ? 'retail-price' : 'factory-price'}">
                            ${item.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary" onclick="editItem('${item.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteItem('${item.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function exportStock() {
            if (items.length === 0) {
                showNotification('No items to export!', 'warning');
                return;
            }
            
            let csvContent = "Item Code,Item Name,Category,Stock,Unit,Retail Price,Factory Price,Status\n";
            items.forEach(item => {
                csvContent += `${item.code},${item.name},${item.category},${item.stock},${item.unit},${item.retailPrice},${item.factoryPrice},${item.status}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stock_report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showNotification('Stock report exported successfully!', 'success');
        }

        // Partner management
        function savePartner() {
            if (!checkPermission('partner-create')) {
                showNotification('Access denied: Cannot create partners', 'error');
                return;
            }
            
            const name = document.getElementById('partnerName').value.trim();
            const type = document.getElementById('partnerType').value;
            const email = document.getElementById('partnerEmail').value.trim();
            const phone = document.getElementById('partnerPhone').value.trim();
            const address = document.getElementById('partnerAddress').value.trim();
            
            if (!name || !type) {
                showNotification('Please fill in required fields', 'error');
                return;
            }
            
            const partner = {
                id: 'PTN-' + Date.now(),
                name,
                type,
                email,
                phone,
                address,
                dateAdded: new Date().toISOString().split('T')[0]
            };
            
            partners.push(partner);
            refreshPartnersTable();
            clearPartnerForm();
            showNotification('Partner saved successfully!', 'success');
        }

        function clearPartnerForm() {
            document.getElementById('partnerName').value = '';
            document.getElementById('partnerType').value = 'customer';
            document.getElementById('partnerEmail').value = '';
            document.getElementById('partnerPhone').value = '';
            document.getElementById('partnerAddress').value = '';
        }

        function refreshPartnersTable() {
            const tbody = document.getElementById('partnersTableBody');
            
            if (partners.length === 0) {
                tbody.innerHTML = '<tr class="no-records"><td colspan="5">No partners found. Add your first partner above.</td></tr>';
                return;
            }
            
            tbody.innerHTML = partners.map(partner => `
                <tr>
                    <td>${partner.name}</td>
                    <td>
                        <span class="price-tag ${partner.type === 'customer' ? 'retail-price' : partner.type === 'supplier' ? 'factory-price' : 'text-warning'}">
                            ${partner.type.toUpperCase()}
                        </span>
                    </td>
                    <td>${partner.email || 'N/A'}</td>
                    <td>${partner.phone || 'N/A'}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editPartner('${partner.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deletePartner('${partner.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Print functionality
        function printPage() {
            window.print();
        }

        // Utility functions
        function checkPermission(permission) {
            // Admin has all permissions by default
            return currentUser && (currentUser.role === 'admin' || userPermissions[permission] !== false);
        }

        function formatCurrency(amount, currency = null) {
            const curr = currency || systemConfig.currency;
            const num = parseFloat(amount) || 0;
            
            if (curr === 'UGX') {
                return 'UGX ' + num.toLocaleString('en-UG', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            } else if (curr === 'USD') {
                return 'USD ' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                return curr + ' ' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
        }

        function loadSystemConfig() {
            // Load saved configuration from localStorage
            const saved = localStorage.getItem('salesManagerConfig');
            if (saved) {
                systemConfig = { ...systemConfig, ...JSON.parse(saved) };
                
                // Update UI with saved values
                document.getElementById('companyName').value = systemConfig.companyName;
                document.getElementById('mainLocation').value = systemConfig.mainLocation;
                document.getElementById('enableVAT').checked = systemConfig.enableVAT;
                
                if (systemConfig.enableVAT) {
                    document.getElementById('vatRateGroup').style.display = 'block';
                }
                
                updateFooter();
                updateLoginDisplay();
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas fa-${getNotificationIcon(type)}"></i> ${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }

        // Enhanced Goods & Services Functions
        function calculateGSAmount() {
            const qty = parseFloat(document.getElementById('gsQty').value) || 0;
            const unitPrice = parseFloat(document.getElementById('gsUnitPrice').value) || 0;
            const unitVAT = parseFloat(document.getElementById('gsUnitVAT').value) || 0;
            const unitDiscount = parseFloat(document.getElementById('gsUnitDiscount').value) || 0;
            
            const subtotal = qty * unitPrice;
            const discountAmount = qty * unitDiscount;
            const vatAmount = qty * unitVAT;
            const total = subtotal - discountAmount + vatAmount;
            
            document.getElementById('gsAmount').value = total.toFixed(2);
        }
        
        function addGSItem() {
            const itemDesc = document.getElementById('gsItemDesc').value.trim();
            const unit = document.getElementById('gsUnit').value;
            const qty = parseFloat(document.getElementById('gsQty').value) || 0;
            const unitPrice = parseFloat(document.getElementById('gsUnitPrice').value) || 0;
            const unitVAT = parseFloat(document.getElementById('gsUnitVAT').value) || 0;
            const unitDiscount = parseFloat(document.getElementById('gsUnitDiscount').value) || 0;
            const amount = parseFloat(document.getElementById('gsAmount').value) || 0;
            const batch = document.getElementById('gsBatch').value.trim();
            const manufDate = document.getElementById('gsManufDate').value;
            const expiryDate = document.getElementById('gsExpiryDate').value;
            const exciseDuty = parseFloat(document.getElementById('gsExciseDuty').value) || 0;
            
            if (!itemDesc || qty <= 0 || unitPrice <= 0) {
                showNotification('Please fill in all required item fields', 'error');
                return;
            }
            
            const gsItem = {
                id: 'GSI-' + Date.now(),
                description: itemDesc,
                unit: unit,
                quantity: qty,
                unitPrice: unitPrice,
                unitVAT: unitVAT,
                unitDiscount: unitDiscount,
                amount: amount,
                batch: batch,
                manufDate: manufDate,
                expiryDate: expiryDate,
                exciseDuty: exciseDuty,
                inventoryAccount: 'Inventory'
            };
            
            goodsServicesItems.push(gsItem);
            refreshGSItemsTable();
            clearGSItemForm();
            calculateGSTotals();
            
            // Add to inventory if new item
            const existingItem = items.find(item => item.name.toLowerCase() === itemDesc.toLowerCase());
            if (!existingItem) {
                const newItem = {
                    id: 'ITM-' + Date.now(),
                    code: 'GS-' + Date.now().toString().slice(-6),
                    name: itemDesc,
                    category: 'goods-services',
                    retailPrice: unitPrice * 1.2, // Add 20% markup
                    factoryPrice: unitPrice,
                    stock: qty,
                    unit: unit,
                    minStock: 5,
                    status: qty > 5 ? 'In Stock' : 'Low Stock',
                    dateAdded: new Date().toISOString().split('T')[0],
                    batch: batch,
                    manufDate: manufDate,
                    expiryDate: expiryDate
                };
                items.push(newItem);
                
                // Record stock movement
                const stockMovement = {
                    id: 'STK-' + Date.now(),
                    itemId: newItem.id,
                    itemName: newItem.name,
                    type: 'Goods & Services Purchase',
                    quantity: qty,
                    date: new Date().toISOString().split('T')[0],
                    user: currentUser.fullName,
                    notes: `Added via Goods & Services: Batch ${batch}`
                };
                stockMovements.push(stockMovement);
            } else {
                existingItem.stock += qty;
                existingItem.status = existingItem.stock <= existingItem.minStock ? 'Low Stock' : 'In Stock';
            }
            
            refreshItemsTable();
            updateNotificationCount();
            showNotification('Item added to Goods & Services and inventory updated', 'success');
        }
        
        function refreshGSItemsTable() {
            const tbody = document.getElementById('gsItemsTable');
            if (!tbody) return;
            
            if (goodsServicesItems.length === 0) {
                tbody.innerHTML = '<tr class="no-records"><td colspan="11">No records found.</td></tr>';
                return;
            }
            
            tbody.innerHTML = goodsServicesItems.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.description}</td>
                    <td>${item.unit}</td>
                    <td>${item.batch || 'N/A'}</td>
                    <td>${item.inventoryAccount}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.unitPrice)}</td>
                    <td>${formatCurrency(item.unitVAT)}</td>
                    <td>${formatCurrency(item.unitDiscount)}</td>
                    <td class="font-bold">${formatCurrency(item.amount)}</td>
                    <td>
                        <button class="btn btn-danger" onclick="removeGSItem('${item.id}')" style="padding: 5px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function removeGSItem(itemId) {
            goodsServicesItems = goodsServicesItems.filter(item => item.id !== itemId);
            refreshGSItemsTable();
            calculateGSTotals();
        }
        
        function calculateGSTotals() {
            let subtotal = 0;
            let totalVAT = 0;
            let totalDiscount = 0;
            let totalExcise = 0;
            
            goodsServicesItems.forEach(item => {
                subtotal += item.quantity * item.unitPrice;
                totalVAT += item.quantity * item.unitVAT;
                totalDiscount += item.quantity * item.unitDiscount;
                totalExcise += item.exciseDuty;
            });
            
            const cashDiscount = parseFloat(document.getElementById('gsCashDiscount').value) || 0;
            const grandTotal = subtotal + totalVAT - totalDiscount - cashDiscount + totalExcise;
            
            document.getElementById('gsSubtotal').value = subtotal.toFixed(2);
            document.getElementById('gsTotalVAT').value = totalVAT.toFixed(2);
            document.getElementById('gsTotalDiscount').value = totalDiscount.toFixed(2);
            document.getElementById('gsTotalExcise').value = totalExcise.toFixed(2);
            document.getElementById('gsGrandTotal').value = grandTotal.toFixed(2);
        }
        
        function clearGSItemForm() {
            document.getElementById('gsItemDesc').value = '';
            document.getElementById('gsQty').value = '1';
            document.getElementById('gsUnitPrice').value = '0';
            document.getElementById('gsUnitVAT').value = '0';
            document.getElementById('gsUnitDiscount').value = '0';
            document.getElementById('gsAmount').value = '0';
            document.getElementById('gsBatch').value = '';
            document.getElementById('gsManufDate').value = '';
            document.getElementById('gsExpiryDate').value = '';
            document.getElementById('gsExciseDuty').value = '0';
        }
        
        function clearGSForm() {
            goodsServicesItems = [];
            refreshGSItemsTable();
            calculateGSTotals();
            clearGSItemForm();
        }
        
        function saveGoodsServices() {
            if (goodsServicesItems.length === 0) {
                showNotification('Please add at least one item before saving', 'warning');
                return;
            }
            
            const transaction = {
                id: 'GS-' + Date.now(),
                type: 'goods-services',
                date: new Date().toISOString().split('T')[0],
                supplier: document.getElementById('gsSupplier').value,
                items: [...goodsServicesItems],
                subtotal: parseFloat(document.getElementById('gsSubtotal').value) || 0,
                totalVAT: parseFloat(document.getElementById('gsTotalVAT').value) || 0,
                totalDiscount: parseFloat(document.getElementById('gsTotalDiscount').value) || 0,
                grandTotal: parseFloat(document.getElementById('gsGrandTotal').value) || 0,
                paidAmount: parseFloat(document.getElementById('gsPaidAmount').value) || 0,
                paymentMethod: document.getElementById('gsPaymentMethod').value,
                status: 'completed',
                createdBy: currentUser.fullName
            };
            
            transactions.push(transaction);
            
            // Add to accounting books
            addAccountingEntry({
                account: 'Inventory',
                type: 'Debit',
                amount: transaction.grandTotal,
                reference: transaction.id,
                description: 'Goods & Services Purchase'
            });
            
            addAccountingEntry({
                account: 'Accounts Payable',
                type: 'Credit',
                amount: transaction.grandTotal - transaction.paidAmount,
                reference: transaction.id,
                description: 'Goods & Services Purchase'
            });
            
            if (transaction.paidAmount > 0) {
                addAccountingEntry({
                    account: 'Cash',
                    type: 'Credit',
                    amount: transaction.paidAmount,
                    reference: transaction.id,
                    description: 'Goods & Services Payment'
                });
            }
            
            // Prepare last receipt for printing
            setLastReceipt({
                type: 'goods-services',
                headerTitle: 'Goods & Services Purchase Invoice',
                reference: transaction.id,
                date: transaction.date,
                partyLabel: 'Supplier',
                partyName: (partners.find(p => p.id === transaction.supplier)?.name) || 'N/A',
                items: transaction.items.map(it => ({ name: it.description, quantity: it.quantity, price: it.unitPrice, discount: it.unitDiscount, tax: it.unitVAT, total: it.amount })),
                totals: {
                    subtotal: transaction.subtotal,
                    discount: transaction.totalDiscount,
                    tax: transaction.totalVAT,
                    grandTotal: transaction.grandTotal,
                    paid: transaction.paidAmount,
                    balance: Math.max(0, transaction.grandTotal - transaction.paidAmount)
                },
                preparedBy: currentUser.fullName,
                paymentMethod: transaction.paymentMethod
            });
            
            clearGSForm();
            showNotification('Goods & Services transaction saved successfully! Receipt ready to print.', 'success');
        }
        
        // Cash Receipts Functions
        function generateCashReceiptsInterface() {
            return `
                <div class="card">
                    <h3><i class="fas fa-money-bill-wave"></i> Cash Receipts</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Receipt Type</label>
                            <select id="receiptType" onchange="loadReceiptType()">
                                <option value="">Select Receipt Type...</option>
                                <option value="credit-sale">From Credit Sale</option>
                                <option value="shareholder">From Shareholder</option>
                                <option value="loan">Receive Loan</option>
                                <option value="customer-deposit">Receive Customer Deposit</option>
                                <option value="other-revenue">Receive Other Revenue</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="receiptTypeContent">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-hand-holding-usd" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                            <h4 style="color: #1a237e; margin-bottom: 10px;">Select Receipt Type</h4>
                            <p style="color: #666;">Choose a receipt type from the dropdown above to proceed.</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadReceiptType() {
            const receiptType = document.getElementById('receiptType').value;
            const contentDiv = document.getElementById('receiptTypeContent');
            
            if (!receiptType) {
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-hand-holding-usd" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                        <h4 style="color: #1a237e; margin-bottom: 10px;">Select Receipt Type</h4>
                        <p style="color: #666;">Choose a receipt type from the dropdown above to proceed.</p>
                    </div>
                `;
                return;
            }
            
            if (receiptType === 'customer-deposit') {
                contentDiv.innerHTML = generateCustomerDepositInterface();
            } else {
                contentDiv.innerHTML = generateGenericReceiptInterface(receiptType);
            }
        }
        
        function generateCustomerDepositInterface() {
            return `
                <div style="border: 2px solid #1a237e; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="color: #1a237e;"><i class="fas fa-piggy-bank"></i> Cash Receipt - Customer Deposit (Prepaid Income)</h4>
                    <p style="color: #666; margin-bottom: 20px;"><strong>Ledger:</strong> Cash Customer Deposit(Prepaid Income)</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Currency:</label>
                            <select id="depositCurrency">
                                <option value="UGX">UGX</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Received from Customer:</label>
                            <input type="text" id="depositCustomer" placeholder="Enter or search customer name" list="customerList" onchange="loadCustomerDeposits()">
                            <datalist id="customerList">
                                ${partners.filter(p => p.type === 'customer' || p.type === 'both')
                                  .map(p => `<option value="${p.name}">`).join('')}
                            </datalist>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Deposit(UGX):</label>
                            <input type="number" id="depositAmount" value="0" step="0.01" onchange="updateDepositAmount()">
                        </div>
                        <div class="form-group">
                            <label>Amount Received:</label>
                            <input type="number" id="amountReceived" value="0" step="0.01" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Receipt Date:</label>
                            <input type="date" id="depositDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>Payment Method:</label>
                            <select id="depositPaymentMethod">
                                <option value="CASH">Cash</option>
                                <option value="BANK">Bank Transfer</option>
                                <option value="MOBILE">Mobile Money</option>
                                <option value="CARD">Card Payment</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Received on Account:</label>
                            <input type="text" id="receivedAccount" placeholder="Account details">
                        </div>
                        <div class="form-group">
                            <label>Reference No.:</label>
                            <input type="text" id="depositReference" placeholder="Reference number">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Status:</label>
                            <select id="depositStatus">
                                <option value="Cleared">Cleared</option>
                                <option value="Pending">Pending</option>
                                <option value="Processing">Processing</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status Description:</label>
                            <textarea id="depositStatusDesc" rows="2" placeholder="Status description"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Items Deposited On</label>
                            <button class="btn btn-primary" onclick="openItemDepositModal()">
                                <i class="fas fa-plus"></i> Add Items
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container" style="margin: 20px 0;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="depositItemsTable">
                                <tr class="no-records">
                                    <td colspan="5">No items selected for deposit.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-success" onclick="saveCustomerDeposit()">
                            <i class="fas fa-save"></i> SAVE
                        </button>
                        <button class="btn btn-warning" onclick="clearDepositForm()">
                            <i class="fas fa-broom"></i> CLEAR
                        </button>
                        <button class="btn btn-secondary" onclick="printLastReceipt()">
                            <i class="fas fa-receipt"></i> Print Receipt
                        </button>
                    </div>
                </div>
            `;
        }
        
        function generateGenericReceiptInterface(receiptType) {
            const title = receiptType.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            return `
                <div style="border: 2px solid #1a237e; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="color: #1a237e;"><i class="fas fa-receipt"></i> Cash Receipt - ${title}</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Receipt Date:</label>
                            <input type="date" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label>Amount Received:</label>
                            <input type="number" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Currency:</label>
                            <select>
                                <option value="UGX">UGX</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Method:</label>
                            <select>
                                <option value="CASH">Cash</option>
                                <option value="BANK">Bank Transfer</option>
                                <option value="MOBILE">Mobile Money</option>
                                <option value="CARD">Card Payment</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Received From:</label>
                            <input type="text" placeholder="Source of receipt">
                        </div>
                        <div class="form-group">
                            <label>Reference No.:</label>
                            <input type="text" placeholder="Reference number">
                        </div>
                        <div class="form-group">
                            <label>Description:</label>
                            <textarea rows="2" placeholder="Receipt description"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-success" onclick="saveGenericReceipt('${receiptType}')">
                            <i class="fas fa-save"></i> SAVE
                        </button>
                        <button class="btn btn-warning" onclick="clearReceiptForm()">
                            <i class="fas fa-broom"></i> CLEAR
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Customer Deposit Functions
        let selectedDepositItems = [];
        
        function updateDepositAmount() {
            const amount = parseFloat(document.getElementById('depositAmount').value) || 0;
            document.getElementById('amountReceived').value = amount.toFixed(2);
        }
        
        function openItemDepositModal() {
            // Create modal for item selection
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="width: 600px;">
                    <h3><i class="fas fa-box"></i> Select Items for Deposit</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Item:</label>
                            <select id="modalItemSelect">
                                <option value="">Select Item...</option>
                                ${items.filter(item => item.stock > 0)
                                  .map(item => `<option value="${item.id}">${item.name} - Stock: ${item.stock}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantity:</label>
                            <input type="number" id="modalItemQty" min="1" value="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Unit Price:</label>
                            <input type="number" id="modalItemPrice" step="0.01" value="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <button class="btn btn-success" onclick="addDepositItem()">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                        <button class="btn btn-warning" onclick="closeDepositModal()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.id = 'depositItemModal';
        }
        
        function addDepositItem() {
            const itemId = document.getElementById('modalItemSelect').value;
            const qty = parseFloat(document.getElementById('modalItemQty').value) || 0;
            const price = parseFloat(document.getElementById('modalItemPrice').value) || 0;
            
            if (!itemId || qty <= 0 || price <= 0) {
                showNotification('Please fill in all item details', 'error');
                return;
            }
            
            const item = items.find(i => i.id === itemId);
            if (!item) return;
            
            if (qty > item.stock) {
                showNotification(`Insufficient stock. Available: ${item.stock}`, 'error');
                return;
            }
            
            const depositItem = {
                id: itemId,
                name: item.name,
                quantity: qty,
                unitPrice: price,
                total: qty * price
            };
            
            selectedDepositItems.push(depositItem);
            refreshDepositItemsTable();
            closeDepositModal();
        }
        
        function closeDepositModal() {
            const modal = document.getElementById('depositItemModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        function refreshDepositItemsTable() {
            const tbody = document.getElementById('depositItemsTable');
            if (!tbody) return;
            
            if (selectedDepositItems.length === 0) {
                tbody.innerHTML = '<tr class="no-records"><td colspan="5">No items selected for deposit.</td></tr>';
                return;
            }
            
            tbody.innerHTML = selectedDepositItems.map((item, index) => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${formatCurrency(item.unitPrice)}</td>
                    <td class="font-bold">${formatCurrency(item.total)}</td>
                    <td>
                        <button class="btn btn-danger" onclick="removeDepositItem(${index})" style="padding: 5px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function removeDepositItem(index) {
            selectedDepositItems.splice(index, 1);
            refreshDepositItemsTable();
        }
        
        function saveCustomerDeposit() {
            const customer = document.getElementById('depositCustomer').value.trim();
            const amount = parseFloat(document.getElementById('depositAmount').value) || 0;
            
            if (!customer || amount <= 0) {
                showNotification('Please enter customer name and deposit amount', 'error');
                return;
            }
            
            const deposit = {
                id: 'DEP-' + Date.now(),
                customer: customer,
                amount: amount,
                currency: document.getElementById('depositCurrency').value,
                date: document.getElementById('depositDate').value,
                paymentMethod: document.getElementById('depositPaymentMethod').value,
                reference: document.getElementById('depositReference').value,
                status: document.getElementById('depositStatus').value,
                items: [...selectedDepositItems],
                createdBy: currentUser.fullName,
                type: 'customer-deposit'
            };
            
            customerDeposits.push(deposit);
            
            // Add to accounting
            addAccountingEntry({
                account: 'Cash',
                type: 'Debit',
                amount: amount,
                reference: deposit.id,
                description: `Customer Deposit: ${customer}`
            });
            
            addAccountingEntry({
                account: 'Customer Deposit',
                type: 'Credit',
                amount: amount,
                reference: deposit.id,
                description: `Customer Deposit: ${customer}`
            });
            
            // Reserve items in stock
            selectedDepositItems.forEach(depositItem => {
                const item = items.find(i => i.id === depositItem.id);
                if (item) {
                    item.stock -= depositItem.quantity;
                    item.reserved = (item.reserved || 0) + depositItem.quantity;
                    item.status = item.stock <= item.minStock ? 'Low Stock' : 'In Stock';
                }
            });
            
            // Prepare last receipt for printing
            setLastReceipt({
                type: 'customer-deposit',
                headerTitle: 'Cash Receipt - Customer Deposit',
                reference: deposit.id,
                date: deposit.date,
                partyLabel: 'Customer',
                partyName: deposit.customer,
                items: deposit.items.map(it => ({ name: it.name, quantity: it.quantity, price: it.unitPrice, discount: 0, tax: 0, total: it.total })),
                totals: {
                    subtotal: deposit.items.reduce((s,i)=>s+i.total,0),
                    discount: 0,
                    tax: 0,
                    grandTotal: amount,
                    paid: amount,
                    balance: 0
                },
                preparedBy: currentUser.fullName,
                paymentMethod: deposit.paymentMethod
            });
            
            refreshItemsTable();
            updateNotificationCount();
            clearDepositForm();
            showNotification('Customer deposit recorded successfully! Receipt ready to print.', 'success');
        }
        
        function clearDepositForm() {
            selectedDepositItems = [];
            refreshDepositItemsTable();
            document.getElementById('depositCustomer').value = '';
            document.getElementById('depositAmount').value = '0';
            document.getElementById('amountReceived').value = '0';
        }
        
        // Prepaid Sale Functions
        function generatePrepaidSaleInterface() {
            return `
                <div class="card">
                    <h3><i class="fas fa-hand-holding-usd"></i> Prepaid Sale - Complete Customer Deposit</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Customer Name:</label>
                            <input type="text" id="prepaidCustomer" placeholder="Enter customer name" list="depositCustomerList" onchange="loadCustomerDeposit()">
                            <datalist id="depositCustomerList">
                                ${customerDeposits.map(d => `<option value="${d.customer}">`).join('')}
                            </datalist>
                        </div>
                        <div class="form-group">
                            <label>Deposit Status:</label>
                            <select id="prepaidStatus" disabled>
                                <option value="pending">Pending Completion</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="customerDepositDetails">
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-search" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                            <h4 style="color: #1a237e; margin-bottom: 10px;">Enter Customer Name</h4>
                            <p style="color: #666;">Type the customer name to load their deposit details.</p>
                        </div>
                    </div>
                    
                    <div class="form-row" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="completePrepaidSale()" id="completeSaleBtn" disabled>
                            <i class="fas fa-check-circle"></i> Complete Sale
                        </button>
                        <button class="btn btn-warning" onclick="clearPrepaidForm()">
                            <i class="fas fa-broom"></i> Clear
                        </button>
                        <button class="btn btn-info" onclick="printPage()">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <button class="btn btn-secondary" onclick="printLastReceipt()">
                            <i class="fas fa-receipt"></i> Print Receipt
                        </button
                    </div>
                </div>
            `;
        }
        
        function loadCustomerDeposit() {
            const customerName = document.getElementById('prepaidCustomer').value.trim();
            const detailsDiv = document.getElementById('customerDepositDetails');
            const completeBtn = document.getElementById('completeSaleBtn');
            
            if (!customerName) {
                detailsDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-search" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                        <h4 style="color: #1a237e; margin-bottom: 10px;">Enter Customer Name</h4>
                        <p style="color: #666;">Type the customer name to load their deposit details.</p>
                    </div>
                `;
                completeBtn.disabled = true;
                return;
            }
            
            const deposit = customerDeposits.find(d => d.customer.toLowerCase() === customerName.toLowerCase() && d.status !== 'completed');
            
            if (!deposit) {
                detailsDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc3545; margin-bottom: 20px;"></i>
                        <h4 style="color: #dc3545; margin-bottom: 10px;">No Active Deposit Found</h4>
                        <p style="color: #666;">No pending deposit found for customer "${customerName}".</p>
                    </div>
                `;
                completeBtn.disabled = true;
                return;
            }
            
            detailsDiv.innerHTML = `
                <div style="border: 2px solid #28a745; padding: 20px; border-radius: 8px; background: #f8fff8;">
                    <h4 style="color: #28a745; margin-bottom: 15px;"><i class="fas fa-check-circle"></i> Customer Deposit Found</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Customer:</label>
                            <input type="text" value="${deposit.customer}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Deposit Amount:</label>
                            <input type="text" value="${formatCurrency(deposit.amount)}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Deposit Date:</label>
                            <input type="text" value="${deposit.date}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Payment Method:</label>
                            <input type="text" value="${deposit.paymentMethod}" readonly>
                        </div>
                    </div>
                    
                    <h5 style="color: #1a237e; margin: 15px 0;">Items on Deposit:</h5>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${deposit.items.map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.quantity}</td>
                                        <td>${formatCurrency(item.unitPrice)}</td>
                                        <td class="font-bold">${formatCurrency(item.total)}</td>
                                    </tr>
                                `).join('')}
                                <tr style="background: #f0f0f0; font-weight: bold;">
                                    <td colspan="3">Total Deposit Value:</td>
                                    <td>${formatCurrency(deposit.items.reduce((sum, item) => sum + item.total, 0))}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group">
                            <label>Balance Due:</label>
                            <input type="number" id="balanceDue" value="${Math.max(0, deposit.items.reduce((sum, item) => sum + item.total, 0) - deposit.amount).toFixed(2)}" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Payment Method for Balance:</label>
                            <select id="balancePaymentMethod">
                                <option value="CASH">Cash</option>
                                <option value="CARD">Card</option>
                                <option value="MOBILE">Mobile Money</option>
                                <option value="BANK">Bank Transfer</option>
                                <option value="NO_BALANCE">No Balance Due</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            completeBtn.disabled = false;
        }
        
        function completePrepaidSale() {
            const customerName = document.getElementById('prepaidCustomer').value.trim();
            const deposit = customerDeposits.find(d => d.customer.toLowerCase() === customerName.toLowerCase() && d.status !== 'completed');
            
            if (!deposit) {
                showNotification('No active deposit found for this customer', 'error');
                return;
            }
            
            const balanceDue = parseFloat(document.getElementById('balanceDue').value) || 0;
            const balancePaymentMethod = document.getElementById('balancePaymentMethod').value;
            
            // Create sale transaction
            const saleTransaction = {
                id: 'PS-' + Date.now(),
                type: 'prepaid-sale',
                customer: deposit.customer,
                depositId: deposit.id,
                items: deposit.items,
                depositAmount: deposit.amount,
                balanceDue: balanceDue,
                totalAmount: deposit.amount + balanceDue,
                balancePaymentMethod: balancePaymentMethod,
                date: new Date().toISOString().split('T')[0],
                status: 'completed',
                createdBy: currentUser.fullName
            };
            
            transactions.push(saleTransaction);
            salesData.push(saleTransaction);
            
            // Update deposit status
            deposit.status = 'completed';
            deposit.completedDate = new Date().toISOString().split('T')[0];
            deposit.saleId = saleTransaction.id;
            
            // Update inventory - remove reserved stock
            deposit.items.forEach(item => {
                const inventoryItem = items.find(i => i.id === item.id);
                if (inventoryItem) {
                    inventoryItem.reserved = Math.max(0, (inventoryItem.reserved || 0) - item.quantity);
                    inventoryItem.status = inventoryItem.stock <= inventoryItem.minStock ? 'Low Stock' : 'In Stock';
                    
                    // Record stock movement
                    const stockMovement = {
                        id: 'STK-' + Date.now(),
                        itemId: inventoryItem.id,
                        itemName: inventoryItem.name,
                        type: 'Prepaid Sale',
                        quantity: -item.quantity,
                        date: new Date().toISOString().split('T')[0],
                        user: currentUser.fullName,
                        notes: `Prepaid sale completion: ${saleTransaction.id}`
                    };
                    stockMovements.push(stockMovement);
                }
            });
            
            // Accounting entries
            if (balanceDue > 0) {
                addAccountingEntry({
                    account: 'Cash',
                    type: 'Debit',
                    amount: balanceDue,
                    reference: saleTransaction.id,
                    description: `Prepaid Sale Balance: ${deposit.customer}`
                });
            }
            
            addAccountingEntry({
                account: 'Customer Deposit',
                type: 'Debit',
                amount: deposit.amount,
                reference: saleTransaction.id,
                description: `Prepaid Sale Deposit: ${deposit.customer}`
            });
            
            addAccountingEntry({
                account: 'Sales Revenue',
                type: 'Credit',
                amount: saleTransaction.totalAmount,
                reference: saleTransaction.id,
                description: `Prepaid Sale: ${deposit.customer}`
            });
            
            // Prepare last receipt for printing
            setLastReceipt({
                type: 'prepaid-sale',
                headerTitle: 'Prepaid Sale Receipt',
                reference: saleTransaction.id,
                date: saleTransaction.date,
                partyLabel: 'Customer',
                partyName: saleTransaction.customer,
                items: saleTransaction.items.map(it => ({ name: it.name, quantity: it.quantity, price: it.unitPrice, discount: 0, tax: 0, total: it.total })),
                totals: {
                    subtotal: saleTransaction.items.reduce((s,i)=>s+i.total,0),
                    discount: 0,
                    tax: 0,
                    grandTotal: saleTransaction.totalAmount,
                    paid: saleTransaction.depositAmount + (saleTransaction.balanceDue || 0),
                    balance: 0
                },
                preparedBy: currentUser.fullName,
                paymentMethod: balancePaymentMethod
            });
            
            refreshItemsTable();
            updateNotificationCount();
            clearPrepaidForm();
            showNotification('Prepaid sale completed successfully! Receipt ready to print.', 'success');
        }
        
        function clearPrepaidForm() {
            document.getElementById('prepaidCustomer').value = '';
            document.getElementById('customerDepositDetails').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-search" style="font-size: 48px; color: #1a237e; margin-bottom: 20px;"></i>
                    <h4 style="color: #1a237e; margin-bottom: 10px;">Enter Customer Name</h4>
                    <p style="color: #666;">Type the customer name to load their deposit details.</p>
                </div>
            `;
            document.getElementById('completeSaleBtn').disabled = true;
        }
        
        // Auto-save configuration changes
        setInterval(() => {
            localStorage.setItem('salesManagerConfig', JSON.stringify(systemConfig));
        }, 30000); // Save every 30 seconds

        // Professional Receipt Generator
        function setLastReceipt(payload) {
            lastReceipt = {
                ...payload,
                company: {
                    name: systemConfig?.companyName || 'Your Company',
                    address: systemConfig?.companyAddress || '',
                    phone: systemConfig?.companyPhone || '',
                    email: systemConfig?.companyEmail || ''
                },
                developers: (systemConfig?.developers && Array.isArray(systemConfig.developers) ? systemConfig.developers : [
                    { name: 'Developed by: Your Dev Team', contact: '' }
                ])
            };
        }
        
        function generateReceiptHTML(data) {
            if (!data) return '<p>No receipt data available.</p>';
            const itemsRows = (data.items || []).map((it, idx) => `
                <tr>
                    <td>${idx+1}</td>
                    <td>${it.name}</td>
                    <td style="text-align:right;">${it.quantity}</td>
                    <td style="text-align:right;">${formatCurrency(it.price || 0)}</td>
                    <td style="text-align:right;">${formatCurrency(it.discount || 0)}</td>
                    <td style="text-align:right;">${formatCurrency(it.tax || 0)}</td>
                    <td style="text-align:right;" class="font-bold">${formatCurrency(it.total || 0)}</td>
                </tr>
            `).join('');
            const devs = (data.developers || []).map(d => `${d.name}${d.contact? ' - '+d.contact: ''}`).join(' | ');
            const stylesheet = `
                <style>
                    body { font-family: Arial, sans-serif; color: #111; }
                    .receipt { width: 820px; margin: 0 auto; padding: 24px; }
                    .r-header { display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #1a237e; padding-bottom:10px; }
                    .r-header .company { color:#1a237e; }
                    .r-meta { margin-top: 8px; font-size: 12px; color: #444; }
                    .r-title { margin: 16px 0; color:#1a237e; }
                    table { width:100%; border-collapse: collapse; }
                    th, td { border: 1px solid #ddd; padding: 8px; font-size: 12px; }
                    th { background:#f3f6ff; color:#1a237e; text-align:left; }
                    .r-footer { margin-top:12px; font-size: 11px; color:#555; border-top:1px dashed #bbb; padding-top:8px; }
                    .totals { width: 320px; margin-left:auto; }
                    .totals td { border:none; }
                    .totals tr td:first-child { text-align: right; color:#333; }
                    .totals .grand td { font-weight: bold; border-top:1px solid #ccc; }
                    @media print {
                        @page { size: A4; margin: 12mm; }
                        .no-print { display: none !important; }
                    }
                </style>
            `;
            return `
                <!doctype html>
                <html>
                    <head>
                        <meta charset="utf-8">
                        <title>Receipt ${data.reference}</title>
                        ${stylesheet}
                    </head>
                    <body>
                        <div class="receipt">
                            <div class="r-header">
                                <div class="company">
                                    <div style="font-size:20px; font-weight:bold;">${data.company.name}</div>
                                    <div class="r-meta">${[data.company.address, data.company.phone, data.company.email].filter(Boolean).join('  ')}</div>
                                </div>
                                <div style="text-align:right;">
                                    <div class="r-title"><strong>${data.headerTitle || 'Receipt'}</strong></div>
                                    <div class="r-meta">Ref: ${data.reference}</div>
                                    <div class="r-meta">Date: ${data.date}</div>
                                </div>
                            </div>
                            <div style="margin: 14px 0;">
                                <strong>${data.partyLabel || 'Party'}:</strong> ${data.partyName || ''}
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Description</th>
                                        <th style="text-align:right;">Qty</th>
                                        <th style="text-align:right;">Unit Price</th>
                                        <th style="text-align:right;">Discount</th>
                                        <th style="text-align:right;">Tax</th>
                                        <th style="text-align:right;">Total</th>
                                    </tr>
                                </thead>
                                <tbody>${itemsRows}</tbody>
                            </table>
                            <table class="totals" style="margin-top:10px;">
                                <tr><td>Subtotal:</td><td style="text-align:right;">${formatCurrency(data.totals?.subtotal || 0)}</td></tr>
                                <tr><td>Discount:</td><td style="text-align:right;">${formatCurrency(data.totals?.discount || 0)}</td></tr>
                                <tr><td>Tax:</td><td style="text-align:right;">${formatCurrency(data.totals?.tax || 0)}</td></tr>
                                <tr class="grand"><td>Grand Total:</td><td style="text-align:right;">${formatCurrency(data.totals?.grandTotal || 0)}</td></tr>
                                <tr><td>Paid:</td><td style="text-align:right;">${formatCurrency(data.totals?.paid || 0)}</td></tr>
                                <tr><td>Balance:</td><td style="text-align:right;">${formatCurrency(data.totals?.balance || 0)}</td></tr>
                                <tr><td>Payment Method:</td><td style="text-align:right;">${data.paymentMethod || ''}</td></tr>
                                <tr><td>Prepared By:</td><td style="text-align:right;">${data.preparedBy || ''}</td></tr>
                            </table>
                            <div class="r-footer">
                                ${devs}
                            </div>
                        </div>
                        <script>
                            window.onload = () => { window.print(); setTimeout(()=>window.close(), 250); };
                        <\/script>
                    </body>
                </html>
            `;
        }
        
        function printLastReceipt() {
            if (!lastReceipt) {
                showNotification('No receipt available. Please save a transaction first.', 'warning');
                return;
            }
            const w = window.open('', '_blank');
            w.document.open();
            w.document.write(generateReceiptHTML(lastReceipt));
            w.document.close();
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                showNotification('Auto-save is enabled', 'info');
            }
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                if (lastReceipt) { printLastReceipt(); } else { printPage(); }
            }
        });
    </script>
</body>
</html>
