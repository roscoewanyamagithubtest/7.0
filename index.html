<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SalesManager 7.0 - Enhanced Professional Business Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Enhanced Styles - Professional Blue Theme with UGX support */
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
        }
        a { color: inherit; }
        .app-hidden { display: none; }
        .header { background: linear-gradient(135deg, #1a237e 0%, #283593 100%); box-shadow: 0 4px 20px rgba(0,0,0,.3); }
        .header-content { max-width: 1400px; margin: 0 auto; padding: 14px 24px; display: flex; align-items: center; justify-content: space-between; }
        .logo-section h1 { margin: 0 0 4px; font-size: 22px; font-weight: 700; }
        .company-info { font-size: 13px; opacity: .9; }
        .user-info { display: flex; gap: 14px; align-items: center; }
        .notifications { position: relative; cursor: pointer; }
        .notification-count { position: absolute; top: -8px; right: -8px; background: #ff6b6b; color: white; border-radius: 20px; padding: 2px 6px; font-size: 11px; font-weight: 700; }
        .logout-btn { background: rgba(255,255,255,.12); border: 1px solid rgba(255,255,255,.3); color: #fff; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .nav-bar { background: rgba(255,255,255,.08); border-bottom: 1px solid rgba(255,255,255,.2); backdrop-filter: blur(8px); }
        .nav-list { list-style: none; margin: 0 auto; padding: 0 24px; max-width: 1400px; display: flex; overflow-x: auto; }
        .nav-item { display: block; padding: 14px 18px; color: rgba(255,255,255,.92); text-decoration: none; border-bottom: 3px solid transparent; }
        .nav-item.active { border-bottom-color: #ffd700; color: #fff; background: rgba(255,255,255,.08); }
        .main-content { max-width: 1400px; margin: 0 auto; padding: 22px; }
        .content-section { display: none; animation: fade .25s ease; }
        .content-section.active { display: block; }
        @keyframes fade { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: translateY(0);} }
        .card { background: rgba(255,255,255,.96); color: #222; border-radius: 12px; border: 1px solid rgba(255,255,255,.3); box-shadow: 0 8px 28px rgba(0,0,0,.28); padding: 18px; margin-bottom: 18px; }
        .card-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 10px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; }
        .dashboard-card { background: linear-gradient(135deg, #1a237e 0%, #283593 100%); color: #fff; border-radius: 12px; padding: 16px; display: flex; gap: 12px; align-items: center; }
        .dashboard-card .card-icon { font-size: 30px; opacity: .9; }
        .dashboard-card .card-value { font-size: 26px; font-weight: 800; margin-top: 4px; }
        .dashboard-card .card-change { font-size: 12px; opacity: .9; }
        .quick-actions { margin-top: 16px; }
        .action-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; }
        .action-btn { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.3); color: #fff; padding: 12px; border-radius: 10px; cursor: pointer; }
        .btn { border: none; border-radius: 8px; padding: 10px 14px; cursor: pointer; display: inline-flex; gap: 8px; align-items: center; }
        .btn-primary { background: linear-gradient(135deg, #1a237e, #3949ab); color: #fff; }
        .btn-success { background: linear-gradient(135deg, #2e7d32, #43a047); color: #fff; }
        .btn-warning { background: linear-gradient(135deg, #f57c00, #ffa000); color: #fff; }
        .btn-info { background: linear-gradient(135deg, #00838f, #00acc1); color: #fff; }
        .btn-secondary { background: #eceff1; color: #263238; }
        .btn-sm { padding: 6px 10px; font-size: 12px; }
        .sales-header, .header-actions { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .transaction-controls, .inventory-filters, .customer-filters, .report-filters { display: flex; gap: 12px; flex-wrap: wrap; margin: 10px 0; }
        .control-group, .filter-group { display: flex; gap: 8px; align-items: center; }
        input, select, textarea { padding: 10px; border-radius: 8px; border: 2px solid #e1e8ed; font-size: 14px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #1a237e; box-shadow: 0 0 0 3px rgba(26,35,126,.1); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; margin-bottom: 12px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full-width { grid-column: 1/-1; }
        .form-actions { display: flex; gap: 10px; margin-top: 20px; }
        .table-container { border-radius: 12px; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,.18); }
        table { width: 100%; border-collapse: collapse; background: #fff; }
        th { background: linear-gradient(135deg, #1a237e, #283593); color: #fff; padding: 12px; text-align: left; font-size: 13px; }
        td { padding: 10px 12px; border-bottom: 1px solid #eceff1; font-size: 13px; }
        tr.no-records td { text-align: center; color: #6c757d; padding: 26px; font-style: italic; }
        .sales-container { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
        .sales-items { background: #fff; border-radius: 12px; padding: 12px; min-height: 280px; color: #222; }
        .sales-right { background: #fff; border-radius: 12px; padding: 12px; display: flex; flex-direction: column; gap: 12px; color: #222; }
        .sales-categories { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
        .category-btn { background: #e3f2fd; border: 1px solid #90caf9; color: #0d47a1; padding: 6px 10px; border-radius: 20px; cursor: pointer; }
        .category-btn.active { background: #bbdefb; }
        .cart-items { flex: 1; overflow: auto; border: 1px dashed #cfd8dc; border-radius: 8px; padding: 10px; }
        .cart-item { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eceff1; padding: 8px 0; }
        .cart-summary { background: #f7f9fc; border: 1px solid #e3e8f0; border-radius: 10px; padding: 10px; }
        .summary-row { display: flex; align-items: center; justify-content: space-between; margin: 4px 0; }
        .summary-row.total { font-weight: 800; font-size: 16px; color: #1a237e; }
        .payment-section { display: grid; gap: 10px; }
        .footer { background: rgba(0,0,0,.18); border-top: 1px solid rgba(255,255,255,.14); padding: 16px; }
        .footer-content { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; }
        .badge.admin { background: #3949ab; color: #fff; }
        .badge.active { background: #2e7d32; color: #fff; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { width: 460px; max-width: 92%; background: rgba(255,255,255,.96); border-radius: 12px; padding: 28px; box-shadow: 0 18px 36px rgba(0,0,0,.3); text-align: center; color: #222; }
        .company-logo { font-size: 48px; color: #1a237e; margin-bottom: 8px; }
        .login-btn { width: 100%; padding: 12px; border-radius: 8px; border: 0; color: #fff; background: linear-gradient(135deg, #1a237e, #283593); cursor: pointer; margin-top: 6px; }
        .notification-container { position: fixed; top: 16px; right: 16px; display: grid; gap: 10px; z-index: 1100; }
        .notification { padding: 12px 14px; border-radius: 10px; color: #fff; font-weight: 600; box-shadow: 0 10px 20px rgba(0,0,0,.18); display: flex; gap: 10px; align-items: center; }
        .notification.success { background: #2e7d32; }
        .notification.error { background: #c62828; }
        .notification.info { background: #0277bd; }
        .notification.warning { background: #ef6c00; }
        .currency-selector { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; }
        .currency-selector select { padding: 6px; border-radius: 6px; }
        .accounting-modules { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px; }
        .module-card { background: rgba(255,255,255,.1); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .module-card:hover { background: rgba(255,255,255,.2); }
        .module-card i { font-size: 48px; margin-bottom: 12px; }
        .report-categories { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .category-card { background: rgba(255,255,255,.1); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .category-card:hover { background: rgba(255,255,255,.2); }
        .category-card i { font-size: 48px; margin-bottom: 12px; }
        .settings-tabs { display: flex; gap: 2px; margin-bottom: 20px; }
        .tab-btn { background: rgba(255,255,255,.1); border: none; color: #fff; padding: 12px 20px; border-radius: 8px 8px 0 0; cursor: pointer; }
        .tab-btn.active { background: rgba(255,255,255,.96); color: #222; }
        .settings-tab { display: none; }
        .settings-tab.active { display: block; }
        @media (max-width: 980px) { .sales-container { grid-template-columns: 1fr; } .nav-list { padding: 0 12px; } }
        /* Print */
        @media print { .header, .nav-bar, .footer, .btn, .action-buttons, .notifications, .modal { display: none !important; } .card { box-shadow: none !important; border: 1px solid #ccc; } body { background: #fff !important; color: #000 !important; } }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="company-logo">
                <i class="fas fa-business-time"></i>
            </div>
            <h2>SalesManager 7.0</h2>
            <div class="company-display" id="loginCompanyDisplay">Enhanced Business Management System</div>
            <form class="login-form" onsubmit="login(event)">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" name="username" value="admin" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" value="admin123" required>
                </div>
                <div class="form-group">
                    <label for="branch">Select Branch:</label>
                    <select id="branch" name="branch" required>
                        <option value="">Choose Branch...</option>
                        <option value="MAIN BRANCH" selected>MAIN BRANCH</option>
                        <option value="KAMPALA">KAMPALA</option>
                        <option value="ENTEBBE">ENTEBBE</option>
                        <option value="JINJA">JINJA</option>
                        <option value="MBARARA">MBARARA</option>
                        <option value="GULU">GULU</option>
                        <option value="ARUA">ARUA</option>
                        <option value="MBALE">MBALE</option>
                    </select>
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="app-hidden">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <h1><i class="fas fa-business-time"></i> SalesManager 7.0</h1>
                    <div class="company-info">
                        <span class="company-name" id="companyDisplay">Enhanced Business Management System</span>
                        <span class="branch-name"> >> <span id="currentBranch">MAIN BRANCH</span></span>
                    </div>
                </div>
                <div class="user-info">
                    <div class="currency-selector">
                        <label>Currency:</label>
                        <select id="globalCurrency" onchange="changeCurrency()">
                            <option value="UGX">UGX - Ugandan Shilling</option>
                            <option value="USD">USD - US Dollar</option>
                            <option value="KES">KES - Kenyan Shilling</option>
                            <option value="TZS">TZS - Tanzanian Shilling</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="GBP">GBP - British Pound</option>
                        </select>
                    </div>
                    <div class="notifications" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-count" id="notificationCount">0</span>
                    </div>
                    <div class="user-details">
                        <span class="username" id="currentUser">ADMIN</span>
                        <span class="user-role" id="currentRole">Administrator</span>
                    </div>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-bar">
            <ul class="nav-list">
                <li><a href="#" data-section="dashboard" class="nav-item active">
                    <i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#" data-section="transactions" class="nav-item" data-permission="transactions">
                    <i class="fas fa-exchange-alt"></i> Transactions</a></li>
                <li><a href="#" data-section="sales" class="nav-item" data-permission="sales">
                    <i class="fas fa-shopping-cart"></i> Sales</a></li>
                <li><a href="#" data-section="inventory" class="nav-item" data-permission="inventory">
                    <i class="fas fa-boxes"></i> Inventory</a></li>
                <li><a href="#" data-section="customers" class="nav-item" data-permission="customers">
                    <i class="fas fa-users"></i> Customers</a></li>
                <li><a href="#" data-section="suppliers" class="nav-item" data-permission="suppliers">
                    <i class="fas fa-truck"></i> Suppliers</a></li>
                <li><a href="#" data-section="accounting" class="nav-item" data-permission="accounting">
                    <i class="fas fa-calculator"></i> Accounting</a></li>
                <li><a href="#" data-section="reports" class="nav-item" data-permission="reports">
                    <i class="fas fa-chart-bar"></i> Reports</a></li>
                <li><a href="#" data-section="settings" class="nav-item" data-permission="settings">
                    <i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="dashboard-grid">
                    <div class="dashboard-card sales-card">
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="card-content">
                            <h3>Today's Sales</h3>
                            <div class="card-value" id="todaySales">UGX 0</div>
                            <div class="card-change positive" id="salesChange">+0%</div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card inventory-card">
                        <div class="card-icon">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <div class="card-content">
                            <h3>Total Items</h3>
                            <div class="card-value" id="totalItems">0</div>
                            <div class="card-info" id="lowStockAlert">Low Stock: 0</div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card customers-card">
                        <div class="card-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="card-content">
                            <h3>Active Customers</h3>
                            <div class="card-value" id="activeCustomers">0</div>
                            <div class="card-info">This Month</div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card profit-card">
                        <div class="card-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="card-content">
                            <h3>Monthly Profit</h3>
                            <div class="card-value" id="monthlyProfit">UGX 0</div>
                            <div class="card-change" id="profitChange">+0%</div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-clock"></i> Recent Activity</h3>
                        <button class="btn btn-primary" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="activity-list" id="recentActivity">
                        <div class="activity-item">
                            <i class="fas fa-info-circle"></i>
                            <span>Welcome to SalesManager 7.0! Start by adding your first inventory items.</span>
                            <span class="activity-time">Just now</span>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3>Quick Actions</h3>
                    <div class="action-buttons">
                        <button class="action-btn" onclick="quickSale()">
                            <i class="fas fa-cash-register"></i>
                            <span>Quick Sale</span>
                        </button>
                        <button class="action-btn" onclick="addInventory()">
                            <i class="fas fa-plus-circle"></i>
                            <span>Add Item</span>
                        </button>
                        <button class="action-btn" onclick="newCustomer()">
                            <i class="fas fa-user-plus"></i>
                            <span>New Customer</span>
                        </button>
                        <button class="action-btn" onclick="recordExpense()">
                            <i class="fas fa-receipt"></i>
                            <span>Record Expense</span>
                        </button>
                        <button class="action-btn" onclick="receiveDeposit()">
                            <i class="fas fa-hand-holding-usd"></i>
                            <span>Receive Deposit</span>
                        </button>
                        <button class="action-btn print-allowed" onclick="printDashboard()">
                            <i class="fas fa-print"></i>
                            <span>Print Summary</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Transactions Section -->
            <section id="transactions" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-exchange-alt"></i> Transaction Management</h2>
                        <div class="header-actions">
                            <button class="btn btn-success" onclick="newTransaction()">
                                <i class="fas fa-plus"></i> New Transaction
                            </button>
                            <button class="btn btn-info print-allowed" onclick="printTransactions()">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                    
                    <div class="transaction-controls">
                        <div class="control-group">
                            <label>Transaction Type:</label>
                            <select id="transactionType" onchange="loadTransactionModule()">
                                <option value="">Select Transaction Type...</option>
                                <optgroup label="Sales Transactions">
                                    <option value="sales-invoice">Sales Invoice</option>
                                    <option value="sales-return">Sales Return</option>
                                    <option value="sales-quote">Sales Quotation</option>
                                    <option value="sales-order">Sales Order</option>
                                    <option value="receive-deposit">Receive Deposit</option>
                                </optgroup>
                                <optgroup label="Purchase Transactions">
                                    <option value="purchase-order">Purchase Order</option>
                                    <option value="purchase-invoice">Purchase Invoice</option>
                                    <option value="purchase-return">Purchase Return</option>
                                </optgroup>
                                <optgroup label="Payment Transactions">
                                    <option value="cash-receipt">Cash Receipt</option>
                                    <option value="cash-payment">Cash Payment</option>
                                    <option value="bank-deposit">Bank Deposit</option>
                                    <option value="bank-withdrawal">Bank Withdrawal</option>
                                    <option value="expense">Expense</option>
                                </optgroup>
                                <optgroup label="Inventory Transactions">
                                    <option value="stock-adjustment">Stock Adjustment</option>
                                    <option value="stock-transfer">Stock Transfer</option>
                                    <option value="stock-take">Stock Take</option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label>Date Range:</label>
                            <input type="date" id="transactionFromDate" onchange="filterTransactions()">
                            <input type="date" id="transactionToDate" onchange="filterTransactions()">
                        </div>
                        
                        <div class="control-group">
                            <label>Status:</label>
                            <select id="transactionStatus" onchange="filterTransactions()">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="draft">Draft</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="transactionModule">
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <h3>Select Transaction Type</h3>
                            <p>Choose a transaction type from the dropdown above to get started.</p>
                        </div>
                    </div>
                    
                    <!-- Transaction History Table -->
                    <div class="table-container">
                        <table id="transactionsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Reference</th>
                                    <th>Party</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                                <tr class="no-records">
                                    <td colspan="7">No transactions found. Create your first transaction above.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Professional Sales Section -->
            <section id="sales" class="content-section">
                <div class="sales-header">
                    <h2><i class="fas fa-shopping-cart"></i> Professional Sales Management</h2>
                    <div class="sales-actions">
                        <button class="btn btn-primary" onclick="newSale()">
                            <i class="fas fa-plus"></i> New Sale
                        </button>
                        <button class="btn btn-info print-allowed" onclick="printSales()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
                
                <!-- Professional Sales Interface -->
                <div id="salesInterface" class="sales-container" style="display: none;">
                    <div class="sales-items">
                        <div class="pos-search">
                            <input type="text" id="itemSearch" placeholder="Search items by code or name..." onkeyup="searchItems()">
                            <button class="btn btn-primary" onclick="searchItems()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        
                        <div class="sales-categories">
                            <button class="category-btn active" onclick="filterByCategory('all')">All Items</button>
                            <button class="category-btn" onclick="filterByCategory('electronics')">Electronics</button>
                            <button class="category-btn" onclick="filterByCategory('clothing')">Clothing</button>
                            <button class="category-btn" onclick="filterByCategory('food')">Food & Beverage</button>
                            <button class="category-btn" onclick="filterByCategory('furniture')">Furniture</button>
                            <button class="category-btn" onclick="filterByCategory('other')">Other</button>
                        </div>
                        
                        <div class="pos-items" id="salesItems">
                            <!-- Items will be loaded here dynamically -->
                        </div>
                    </div>
                    
                    <div class="sales-right">
                        <div class="cart-header">
                            <h3>Sales Cart</h3>
                            <div>
                                <button class="btn btn-warning btn-sm" onclick="clearCart()">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                            </div>
                        </div>

                        <!-- Customer Selection -->
                        <div class="customer-selection">
                            <label>Customer:</label>
                            <select id="saleCustomer">
                                <option value="">Walk-in Customer</option>
                                <!-- Will be populated with customers -->
                            </select>
                        </div>
                        
                        <div class="cart-items" id="cartItems">
                            <div class="empty-cart">
                                <i class="fas fa-shopping-cart"></i>
                                <p>Cart is empty</p>
                            </div>
                        </div>
                        
                        <div class="cart-summary">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="cartSubtotal">UGX 0</span>
                            </div>
                            <div class="summary-row">
                                <span>Tax (<span id="taxPercent">18</span>%):</span>
                                <span id="cartTax">UGX 0</span>
                            </div>
                            <div class="summary-row">
                                <span>Discount:</span>
                                <span id="cartDiscount">UGX 0</span>
                            </div>
                            <div class="summary-row total">
                                <span>Total:</span>
                                <span id="cartTotal">UGX 0</span>
                            </div>
                        </div>
                        
                        <div class="payment-section">
                            <div class="payment-method">
                                <label>Payment Method:</label>
                                <select id="paymentMethod">
                                    <option value="cash">Cash</option>
                                    <option value="card">Credit/Debit Card</option>
                                    <option value="mobile">Mobile Money</option>
                                    <option value="bank">Bank Transfer</option>
                                    <option value="credit">Credit Sale</option>
                                </select>
                            </div>
                            
                            <div class="payment-amount">
                                <label>Amount Paid:</label>
                                <input type="number" id="amountPaid" step="0.01" onchange="calculateChange()">
                            </div>
                            
                            <div class="change-amount">
                                <span>Change: </span>
                                <span id="changeAmount">UGX 0</span>
                            </div>
                            
                            <div class="checkout-actions">
                                <button class="btn btn-success" onclick="processPayment()">
                                    <i class="fas fa-credit-card"></i> Process Payment
                                </button>
                                <button class="btn btn-info print-allowed" onclick="printReceipt()">
                                    <i class="fas fa-print"></i> Print Receipt
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sales List -->
                <div id="salesList" class="card">
                    <div class="card-header">
                        <h3>Recent Sales</h3>
                        <div class="sales-filters">
                            <input type="date" id="salesFromDate" onchange="filterSales()">
                            <input type="date" id="salesToDate" onchange="filterSales()">
                            <select id="salesStatusFilter" onchange="filterSales()">
                                <option value="">All Status</option>
                                <option value="completed">Completed</option>
                                <option value="pending">Pending</option>
                                <option value="refunded">Refunded</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Invoice #</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Unit Price</th>
                                    <th>Quantity</th>
                                    <th>Amount</th>
                                    <th>Total</th>
                                    <th>Payment</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                                <tr class="no-records">
                                    <td colspan="11">No sales records found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Inventory Section -->
            <section id="inventory" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-boxes"></i> Inventory Management</h2>
                        <div class="header-actions">
                            <button class="btn btn-success" onclick="addNewItem()">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                            <button class="btn btn-warning" onclick="stockAdjustment()">
                                <i class="fas fa-edit"></i> Stock Adjustment
                            </button>
                            <button class="btn btn-info" onclick="importItems()">
                                <i class="fas fa-upload"></i> Import Items
                            </button>
                            <button class="btn btn-primary" onclick="exportInventory()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-info print-allowed" onclick="printInventory()">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                    
                    <!-- Inventory Form -->
                    <div id="inventoryForm" class="form-section" style="display: none;">
                        <form onsubmit="saveInventoryItem(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Item Code:</label>
                                    <input type="text" id="itemCode" required>
                                </div>
                                <div class="form-group">
                                    <label>Item Name:</label>
                                    <input type="text" id="itemName" required>
                                </div>
                                <div class="form-group">
                                    <label>Category:</label>
                                    <select id="itemCategory" required>
                                        <option value="">Select Category</option>
                                        <option value="electronics">Electronics</option>
                                        <option value="clothing">Clothing</option>
                                        <option value="food">Food & Beverage</option>
                                        <option value="furniture">Furniture</option>
                                        <option value="automotive">Automotive</option>
                                        <option value="books">Books & Media</option>
                                        <option value="health">Health & Beauty</option>
                                        <option value="sports">Sports & Recreation</option>
                                        <option value="toys">Toys & Games</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Brand:</label>
                                    <input type="text" id="itemBrand">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Cost Price:</label>
                                    <input type="number" id="costPrice" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label>Selling Price:</label>
                                    <input type="number" id="sellingPrice" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label>Unit:</label>
                                    <select id="itemUnit" required>
                                        <option value="pcs">Pieces</option>
                                        <option value="kg">Kilograms</option>
                                        <option value="lbs">Pounds</option>
                                        <option value="liters">Liters</option>
                                        <option value="meters">Meters</option>
                                        <option value="boxes">Boxes</option>
                                        <option value="sets">Sets</option>
                                        <option value="dozens">Dozens</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Initial Stock:</label>
                                    <input type="number" id="initialStock" min="0" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Minimum Stock Level:</label>
                                    <input type="number" id="minStockLevel" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label>Maximum Stock Level:</label>
                                    <input type="number" id="maxStockLevel" min="0">
                                </div>
                                <div class="form-group">
                                    <label>Reorder Point:</label>
                                    <input type="number" id="reorderPoint" min="0">
                                </div>
                                <div class="form-group">
                                    <label>Location/Shelf:</label>
                                    <input type="text" id="itemLocation" placeholder="A1-B2">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label>Description:</label>
                                    <textarea id="itemDescription" rows="3"></textarea>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> Save Item
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="cancelItemForm()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button type="button" class="btn btn-warning" onclick="clearItemForm()">
                                    <i class="fas fa-broom"></i> Clear
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Inventory Filters -->
                    <div class="inventory-filters">
                        <div class="filter-group">
                            <input type="text" id="inventorySearch" placeholder="Search items..." onkeyup="filterInventory()">
                        </div>
                        <div class="filter-group">
                            <select id="categoryFilter" onchange="filterInventory()">
                                <option value="">All Categories</option>
                                <option value="electronics">Electronics</option>
                                <option value="clothing">Clothing</option>
                                <option value="food">Food & Beverage</option>
                                <option value="furniture">Furniture</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="stockFilter" onchange="filterInventory()">
                                <option value="">All Stock Levels</option>
                                <option value="in-stock">In Stock</option>
                                <option value="low-stock">Low Stock</option>
                                <option value="out-of-stock">Out of Stock</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="statusFilter" onchange="filterInventory()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="discontinued">Discontinued</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Inventory Table -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Stock</th>
                                    <th>Cost Price</th>
                                    <th>Selling Price</th>
                                    <th>Margin</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                                <tr class="no-records">
                                    <td colspan="9">No inventory items found. Add your first item above.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Customers Section -->
            <section id="customers" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-users"></i> Customer Management</h2>
                        <div class="header-actions">
                            <button class="btn btn-success" onclick="addNewCustomer()">
                                <i class="fas fa-user-plus"></i> Add Customer
                            </button>
                            <button class="btn btn-info" onclick="importCustomers()">
                                <i class="fas fa-upload"></i> Import
                            </button>
                            <button class="btn btn-primary" onclick="exportCustomers()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-info print-allowed" onclick="printCustomers()">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                    
                    <!-- Customer Form -->
                    <div id="customerForm" class="form-section" style="display: none;">
                        <form onsubmit="saveCustomer(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Customer ID:</label>
                                    <input type="text" id="customerId" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Customer Type:</label>
                                    <select id="customerType" required>
                                        <option value="individual">Individual</option>
                                        <option value="business">Business</option>
                                        <option value="wholesale">Wholesale</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>First Name:</label>
                                    <input type="text" id="firstName" required>
                                </div>
                                <div class="form-group">
                                    <label>Last Name:</label>
                                    <input type="text" id="lastName" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Company Name:</label>
                                    <input type="text" id="companyName">
                                </div>
                                <div class="form-group">
                                    <label>Email:</label>
                                    <input type="email" id="customerEmail">
                                </div>
                                <div class="form-group">
                                    <label>Phone:</label>
                                    <input type="tel" id="customerPhone" required>
                                </div>
                                <div class="form-group">
                                    <label>Address:</label>
                                    <input type="text" id="customerAddress">
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> Save Customer
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="cancelCustomerForm()">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button type="button" class="btn btn-warning" onclick="clearCustomerForm()">
                                    <i class="fas fa-broom"></i> Clear
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Customers Table -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Total Purchases</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customersTableBody">
                                <tr class="no-records">
                                    <td colspan="7">No customers found. Add your first customer above.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Suppliers Section -->
            <section id="suppliers" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-truck"></i> Supplier Management</h2>
                        <div class="header-actions">
                            <button class="btn btn-success" onclick="addNewSupplier()">
                                <i class="fas fa-plus"></i> Add Supplier
                            </button>
                            <button class="btn btn-info print-allowed" onclick="printSuppliers()">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Company Name</th>
                                    <th>Contact Person</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Total Purchases</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="suppliersTableBody">
                                <tr class="no-records">
                                    <td colspan="7">No suppliers found. Add your first supplier above.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Professional Accounting Section -->
            <section id="accounting" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-calculator"></i> Professional Books of Accounts</h2>
                    </div>
                    
                    <div class="accounting-dashboard">
                        <div class="dashboard-grid">
                            <div class="dashboard-card">
                                <div class="card-icon"><i class="fas fa-money-bill-wave"></i></div>
                                <div class="card-content">
                                    <h3>Total Revenue</h3>
                                    <div class="card-value" id="totalRevenue">UGX 0</div>
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-icon"><i class="fas fa-shopping-cart"></i></div>
                                <div class="card-content">
                                    <h3>Cost of Goods Sold</h3>
                                    <div class="card-value" id="totalCOGS">UGX 0</div>
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-icon"><i class="fas fa-receipt"></i></div>
                                <div class="card-content">
                                    <h3>Total Expenses</h3>
                                    <div class="card-value" id="totalExpenses">UGX 0</div>
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-icon"><i class="fas fa-chart-line"></i></div>
                                <div class="card-content">
                                    <h3>Net Profit</h3>
                                    <div class="card-value" id="netProfit">UGX 0</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accounting-modules">
                            <div class="module-card" onclick="openAccountingModule('chart-of-accounts')">
                                <i class="fas fa-list"></i>
                                <h3>Chart of Accounts</h3>
                                <p>Manage your account structure</p>
                            </div>
                            
                            <div class="module-card" onclick="openAccountingModule('general-ledger')">
                                <i class="fas fa-book"></i>
                                <h3>General Ledger</h3>
                                <p>View all account transactions</p>
                            </div>
                            
                            <div class="module-card" onclick="openAccountingModule('trial-balance')">
                                <i class="fas fa-balance-scale"></i>
                                <h3>Trial Balance</h3>
                                <p>Verify account balances</p>
                            </div>
                            
                            <div class="module-card" onclick="openAccountingModule('balance-sheet')">
                                <i class="fas fa-clipboard-list"></i>
                                <h3>Balance Sheet</h3>
                                <p>Financial position statement</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Accounting Module Content -->
                    <div id="accountingModuleContent" class="card" style="display: none;">
                        <div class="card-header">
                            <h3 id="accountingModuleTitle">Accounting Module</h3>
                            <button class="btn btn-secondary" onclick="closeAccountingModule()">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                        <div id="accountingModuleBody">
                            <!-- Module content will be loaded here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Enhanced Reports Section -->
            <section id="reports" class="content-section">
                <div class="reports-dashboard">
                    <div class="report-categories">
                        <div class="category-card" onclick="loadReportCategory('sales')">
                            <i class="fas fa-chart-bar"></i>
                            <h3>Sales Reports</h3>
                            <p>Sales performance and analysis</p>
                        </div>
                        
                        <div class="category-card" onclick="loadReportCategory('inventory')">
                            <i class="fas fa-boxes"></i>
                            <h3>Inventory Reports</h3>
                            <p>Stock levels and movements</p>
                        </div>
                        
                        <div class="category-card" onclick="loadReportCategory('profit-loss')">
                            <i class="fas fa-chart-line"></i>
                            <h3>Profit & Loss</h3>
                            <p>Revenue, COGS, Expenses, Net Profit</p>
                        </div>
                        
                        <div class="category-card" onclick="loadReportCategory('financial')">
                            <i class="fas fa-calculator"></i>
                            <h3>Financial Reports</h3>
                            <p>Balance sheet, cash flow</p>
                        </div>
                        
                        <div class="category-card" onclick="loadReportCategory('customer')">
                            <i class="fas fa-users"></i>
                            <h3>Customer Reports</h3>
                            <p>Customer analysis and metrics</p>
                        </div>
                    </div>
                    
                    <!-- Report Content -->
                    <div id="reportContent" class="card" style="display: none;">
                        <div class="card-header">
                            <h3 id="reportTitle">Report</h3>
                            <div class="report-actions">
                                <button class="btn btn-primary" onclick="generateReport()">
                                    <i class="fas fa-play"></i> Generate
                                </button>
                                <button class="btn btn-success" onclick="exportReport()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <button class="btn btn-info print-allowed" onclick="printReport()">
                                    <i class="fas fa-print"></i> Print
                                </button>
                                <button class="btn btn-secondary" onclick="closeReport()">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        </div>
                        
                        <div class="report-filters">
                            <div class="filter-group">
                                <label>From Date:</label>
                                <input type="date" id="reportFromDate">
                            </div>
                            <div class="filter-group">
                                <label>To Date:</label>
                                <input type="date" id="reportToDate">
                            </div>
                            <div class="filter-group" id="reportSpecificFilters">
                                <!-- Specific filters will be added based on report type -->
                            </div>
                        </div>
                        
                        <div id="reportBody">
                            <!-- Report content will be generated here -->
                        </div>
                    </div>
                </div>
            </section>

           <section id="settings" class="content-section">
  <div class="settings-nav">
    <div class="settings-tabs">
      <button class="tab-btn active" onclick="showSettingsTab('company')">
        <i class="fas fa-building"></i> Company
      </button>
      <button class="tab-btn" onclick="showSettingsTab('users')">
        <i class="fas fa-users-cog"></i> Users
      </button>
      <button class="tab-btn" onclick="showSettingsTab('permissions')">
        <i class="fas fa-shield-alt"></i> Permissions
      </button>
      <button class="tab-btn" onclick="showSettingsTab('system')">
        <i class="fas fa-cogs"></i> System
      </button>
      <button class="tab-btn" onclick="showSettingsTab('backup')">
        <i class="fas fa-database"></i> Backup
      </button>
    </div>
  </div>

  <!-- Company -->
  <div id="company-settings" class="settings-tab active">
    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-building"></i> Company Information</h3>
      </div>
      <form onsubmit="saveCompanySettings(event)">
        <div class="form-row">
          <div class="form-group">
            <label>Company Name:</label>
            <input type="text" id="companyName" value="Enhanced Business Management System" required>
          </div>
          <div class="form-group">
            <label>Business Registration No:</label>
            <input type="text" id="businessRegNo">
          </div>
          <div class="form-group">
            <label>Tax ID Number:</label>
            <input type="text" id="taxIdNumber">
          </div>
          <div class="form-group">
            <label>Business Type:</label>
            <select id="businessType">
              <option value="retail" selected>Retail</option>
              <option value="wholesale">Wholesale</option>
              <option value="manufacturing">Manufacturing</option>
              <option value="service">Service</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Phone:</label>
            <input type="tel" id="companyPhone">
          </div>
          <div class="form-group">
            <label>Email:</label>
            <input type="email" id="companyEmail">
          </div>
          <div class="form-group">
            <label>Website:</label>
            <input type="url" id="companyWebsite">
          </div>
          <div class="form-group">
            <label>Currency:</label>
            <select id="companyCurrency">
              <option value="UGX" selected>UGX - Ugandan Shilling</option>
              <option value="USD">USD - US Dollar</option>
              <option value="KES">KES - Kenyan Shilling</option>
              <option value="TZS">TZS - Tanzanian Shilling</option>
              <option value="EUR">EUR - Euro</option>
              <option value="GBP">GBP - British Pound</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label>Address:</label>
            <textarea id="companyAddress" rows="3"></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>
              <input type="checkbox" id="enableTax"> Enable Tax
            </label>
          </div>
          <div class="form-group">
            <label>Tax Rate (%):</label>
            <input type="number" id="taxRate" step="0.01" value="18">
          </div>
          <div class="form-group">
            <label>Fiscal Year Start:</label>
            <select id="fiscalYearStart">
              <option value="01" selected>January</option>
              <option value="07">July</option>
              <option value="04">April</option>
            </select>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save"></i> Save Company Settings
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Users -->
  <div id="users-settings" class="settings-tab">
    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-users-cog"></i> User Management</h3>
        <button class="btn btn-success" onclick="openUserForm()">
          <i class="fas fa-user-plus"></i> Add User
        </button>
      </div>

      <!-- Add/Edit User Modal -->
      <div id="userModal" class="modal" style="display:none;">
        <div class="modal-content">
          <h3 id="userModalTitle">Add User</h3>
          <form onsubmit="saveUser(event)">
            <div class="form-row">
              <div class="form-group">
                <label>Username:</label>
                <input type="text" id="user_username" required>
              </div>
              <div class="form-group">
                <label>Full Name:</label>
                <input type="text" id="user_fullName" required>
              </div>
              <div class="form-group">
                <label>Email:</label>
                <input type="email" id="user_email">
              </div>
              <div class="form-group">
                <label>Role:</label>
                <select id="user_role" required>
                  <option value="admin">Administrator</option>
                  <option value="manager">Manager</option>
                  <option value="cashier">Cashier</option>
                  <option value="staff">Staff</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Password:</label>
                <input type="password" id="user_password" required>
              </div>
              <div class="form-group">
                <label>Confirm Password:</label>
                <input type="password" id="user_confirm" required>
              </div>
              <div class="form-group">
                <label>Status:</label>
                <select id="user_status">
                  <option value="active" selected>Active</option>
                  <option value="inactive">Inactive</option>
                </select>
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Save</button>
              <button type="button" class="btn btn-secondary" onclick="closeUserForm()"><i class="fas fa-times"></i> Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Users Table -->
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Username</th>
              <th>Full Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Last Login</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr>
              <td>admin</td>
              <td>System Administrator</td>
              <td>admin@system.com</td>
              <td><span class="badge admin">Administrator</span></td>
              <td><span class="badge active">Active</span></td>
              <td>Just now</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="editUser('admin')"><i class="fas fa-edit"></i></button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Permissions -->
  <div id="permissions-settings" class="settings-tab">
    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-shield-alt"></i> User Permissions</h3>
        <div class="permission-info">
          <i class="fas fa-info-circle"></i>
          <span>Admin has full access. Printing is available to all users.</span>
        </div>
      </div>

      <div class="permissions-grid">
        <div class="permission-section">
          <h4>Dashboard & Overview</h4>
          <label class="permission-item">
            <input type="checkbox" id="perm-dashboard-view" checked disabled>
            <span>View Dashboard</span>
            <small>Access to main dashboard (Always enabled)</small>
          </label>
        </div>

        <div class="permission-section">
          <h4>Transactions</h4>
          <label><input type="checkbox" id="perm-transactions-view"> View Transactions</label>
          <label><input type="checkbox" id="perm-transactions-create"> Create Transactions</label>
          <label><input type="checkbox" id="perm-transactions-edit"> Edit Transactions</label>
          <label><input type="checkbox" id="perm-transactions-delete"> Delete Transactions</label>
        </div>

        <div class="permission-section">
          <h4>Sales</h4>
          <label><input type="checkbox" id="perm-sales-view"> View Sales</label>
          <label><input type="checkbox" id="perm-sales-create"> Create Sales</label>
        </div>

        <div class="permission-section">
          <h4>Inventory Management</h4>
          <label><input type="checkbox" id="perm-inventory-view"> View Inventory</label>
          <label><input type="checkbox" id="perm-inventory-create"> Add Items</label>
          <label><input type="checkbox" id="perm-inventory-edit"> Edit Items</label>
          <label><input type="checkbox" id="perm-inventory-delete"> Delete Items</label>
        </div>

        <div class="permission-section">
          <h4>Customer Management</h4>
          <label><input type="checkbox" id="perm-customers-view"> View Customers</label>
          <label><input type="checkbox" id="perm-customers-create"> Add Customers</label>
          <label><input type="checkbox" id="perm-customers-edit"> Edit Customers</label>
        </div>

        <div class="permission-section">
          <h4>Supplier Management</h4>
          <label><input type="checkbox" id="perm-suppliers-view"> View Suppliers</label>
          <label><input type="checkbox" id="perm-suppliers-create"> Add Suppliers</label>
          <label><input type="checkbox" id="perm-suppliers-edit"> Edit Suppliers</label>
        </div>

        <div class="permission-section">
          <h4>Accounting</h4>
          <label><input type="checkbox" id="perm-accounting-view"> View Accounting</label>
          <label><input type="checkbox" id="perm-accounting-create"> Create Entries</label>
          <label><input type="checkbox" id="perm-accounting-edit"> Edit Entries</label>
        </div>

        <div class="permission-section">
          <h4>Reports</h4>
          <label><input type="checkbox" id="perm-reports-view"> View Reports</label>
          <label><input type="checkbox" id="perm-reports-export"> Export Reports</label>
        </div>

        <div class="permission-section">
          <h4>System Settings</h4>
          <label><input type="checkbox" id="perm-settings-access"> Access Settings</label>
          <label><input type="checkbox" id="perm-settings-modify"> Modify Settings</label>
        </div>

        <div class="permission-section">
          <h4>Printing (Available to All Users)</h4>
          <label class="permission-item">
            <input type="checkbox" checked disabled>
            <span>Print Documents</span>
            <small>All users can print documents and receipts</small>
          </label>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn btn-success" onclick="savePermissions()">
          <i class="fas fa-save"></i> Save Permissions
        </button>
        <button class="btn btn-primary" onclick="setDefaultPermissions()">
          <i class="fas fa-undo"></i> Reset to Default
        </button>
      </div>
    </div>
  </div>

  <!-- System -->
  <div id="system-settings" class="settings-tab">
    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-cogs"></i> System Configuration</h3>
      </div>

      <form onsubmit="saveSystemSettings(event)">
        <div class="settings-section">
          <h4>General Settings</h4>
          <div class="form-row">
            <div class="form-group">
              <label>System Theme:</label>
              <select id="systemTheme">
                <option value="blue">Professional Blue</option>
                <option value="dark" selected>Dark Mode</option>
                <option value="green">Nature Green</option>
              </select>
            </div>
            <div class="form-group">
              <label>Date Format:</label>
              <select id="dateFormat">
                <option value="DD/MM/YYYY" selected>DD/MM/YYYY</option>
                <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                <option value="YYYY-MM-DD">YYYY-MM-DD</option>
              </select>
            </div>
            <div class="form-group">
              <label>Time Format:</label>
              <select id="timeFormat">
                <option value="24" selected>24 Hour</option>
                <option value="12">12 Hour</option>
              </select>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h4>Business Settings</h4>
          <div class="form-row">
            <div class="form-group">
              <label><input type="checkbox" id="autoSave" checked> Auto Save Changes</label>
            </div>
            <div class="form-group">
              <label><input type="checkbox" id="lowStockAlerts" checked> Low Stock Alerts</label>
            </div>
            <div class="form-group">
              <label><input type="checkbox" id="emailNotifications"> Email Notifications</label>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h4>Receipt Settings</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Receipt Header:</label>
              <input type="text" id="receiptHeader" value="Thank you for your business!">
            </div>
            <div class="form-group">
              <label>Receipt Footer:</label>
              <input type="text" id="receiptFooter" value="Visit us again soon!">
            </div>
            <div class="form-group">
              <label>Print Logo on Receipt:</label>
              <input type="checkbox" id="printLogo">
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save"></i> Save System Settings
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Backup -->
  <div id="backup-settings" class="settings-tab">
    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-database"></i> Data Backup & Export</h3>
      </div>

      <div class="backup-section">
        <h4>Manual Backup</h4>
        <p>Create a backup of all your data including inventory, customers, sales, and settings.</p>
        <div class="backup-actions">
          <button class="btn btn-success" onclick="createBackup()">
            <i class="fas fa-download"></i> Create Full Backup
          </button>
          <label class="btn btn-primary" style="cursor:pointer;">
            <i class="fas fa-upload"></i> Restore from Backup
            <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="restoreBackup(event)">
          </label>
        </div>
      </div>

      <div class="export-section">
        <h4>Data Export</h4>
        <p>Export specific data to CSV files for external use.</p>
        <div class="export-options">
          <button class="btn btn-info" onclick="exportData('inventory')"><i class="fas fa-boxes"></i> Export Inventory</button>
          <button class="btn btn-info" onclick="exportData('customers')"><i class="fas fa-users"></i> Export Customers</button>
          <button class="btn btn-info" onclick="exportData('sales')"><i class="fas fa-shopping-cart"></i> Export Sales</button>
          <button class="btn btn-info" onclick="exportData('transactions')"><i class="fas fa-exchange-alt"></i> Export Transactions</button>
        </div>
      </div>

      <div class="import-section">
        <h4>Data Import</h4>
        <p>Import data from CSV files. Make sure your files follow the required format.</p>
        <div class="import-options">
          <div class="import-item">
            <label>Import Inventory:</label>
            <input type="file" id="inventoryFile" accept=".csv">
            <button class="btn btn-primary" onclick="importData('inventory')"><i class="fas fa-upload"></i> Import</button>
          </div>
          <div class="import-item" style="margin-top:8px;">
            <label>Import Customers:</label>
            <input type="file" id="customersFile" accept=".csv">
            <button class="btn btn-primary" onclick="importData('customers')"><i class="fas fa-upload"></i> Import</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-left">
                    <p>&copy; 2024 SalesManager 7.0 - Enhanced Business Management System</p>
                </div>
                <div class="footer-right">
                    <p>Current Currency: <span id="footerCurrency">UGX</span> | Version: 7.0.1</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>
    

    <!-- Enhanced JavaScript with all requested features -->
    <script>
    // Enhanced Script - Core App State and Helpers with UGX default
    const notify = (msg, type = 'info') => {
        const c = document.getElementById('notificationContainer');
        const n = document.createElement('div');
        n.className = `notification ${type}`;
        n.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':type==='warning'?'exclamation-triangle':'info-circle'}"></i> ${msg}`;
        c.appendChild(n);
        setTimeout(()=> n.remove(), 3500);
    };

    // Global State with UGX default and new features
    const state = {
        config: { companyName: 'Enhanced Business Management System', currency: 'UGX', enableTax: true, taxRate: 18 },
        currentUser: null,
        permissions: {},
        items: [],
        customers: [],
        suppliers: [],
        transactions: [],
        sales: [],
        expenses: [],
        deposits: [],
        cart: [],
        receiptCounter: 1000
    };

    // Enhanced Currency Utility with UGX support
    const fmt = (n, curr = state.config.currency) => {
        const num = Number(n||0);
        if(curr === 'UGX') {
            return `UGX ${num.toLocaleString('en-UG', {minimumFractionDigits:0, maximumFractionDigits:0})}`;
        }
        return `${curr} ${num.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
    };

    // App Init with UGX default
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('loginCompanyDisplay').textContent = state.config.companyName;
        // Set UGX as default in global currency selector
        const gc = document.getElementById('globalCurrency');
        if(gc) gc.value = 'UGX';
        const cc = document.getElementById('companyCurrency');
        if(cc) cc.value = 'UGX';
        initNavigation();
        initDefaults();
    });

    function initDefaults(){
        const today = new Date().toISOString().split('T')[0];
        ['transactionFromDate','transactionToDate','salesFromDate','salesToDate','reportFromDate','reportToDate'].forEach(id=>{
            const el = document.getElementById(id); if(el) el.value = today;
        });
        // Seed demo items with UGX prices
        state.items = [
            {id:'ITM-1', code:'EL-001', name:'LED TV 42"', category:'electronics', cost:800000, price:1200000, stock:10, unit:'pcs', min:2, status:'active'},
            {id:'ITM-2', code:'FD-010', name:'Premium Coffee 1kg', category:'food', cost:25000, price:45000, stock:25, unit:'kg', min:5, status:'active'},
            {id:'ITM-3', code:'CL-220', name:'Denim Jacket', category:'clothing', cost:75000, price:150000, stock:8, unit:'pcs', min:3, status:'active'}
        ];
        // Seed demo customers
        state.customers = [
            {id:'CUS-1', type:'individual', firstName:'John', lastName:'Doe', email:'john@email.com', phone:'+256701234567', totalPurchases:0},
            {id:'CUS-2', type:'business', firstName:'Jane', lastName:'Smith', email:'jane@business.com', phone:'+256707654321', totalPurchases:0}
        ];
        refreshInventoryTable();
        refreshCustomersTable();
        refreshDashboard();
        updateTaxDisplay();
    }

    // Currency change function
    function changeCurrency(){
        const newCurr = document.getElementById('globalCurrency').value;
        state.config.currency = newCurr;
        document.getElementById('footerCurrency').textContent = newCurr;
        // Refresh all displays
        refreshDashboard();
        refreshInventoryTable();
        updateCartSummary();
        recalcAccounting();
        notify(`Currency changed to ${newCurr}`, 'success');
    }

    function updateTaxDisplay(){
        const taxEl = document.getElementById('taxPercent');
        if(taxEl) taxEl.textContent = state.config.taxRate;
    }

    // Authentication
    function login(ev){
        ev.preventDefault();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const branch = document.getElementById('branch').value;
        if(!username || !password || !branch) return notify('Please fill in all login fields','error');
        // Simple: admin only demo
        if(username==='admin' && password==='admin123'){
            state.currentUser = { username, fullName:'System Administrator', role:'admin'};
            document.getElementById('currentUser').textContent = 'SYSTEM ADMINISTRATOR';
            document.getElementById('currentRole').textContent = 'Administrator';
            document.getElementById('currentBranch').textContent = branch;
            document.getElementById('companyDisplay').textContent = state.config.companyName;
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('app').classList.remove('app-hidden');
            notify('Login successful - Welcome to SalesManager 7.0!','success');
        } else {
            notify('Invalid credentials','error');
        }
    }

    function logout(){
        state.currentUser = null;
        document.getElementById('app').classList.add('app-hidden');
        document.getElementById('loginModal').style.display = 'flex';
        notify('Logged out','info');
    }

    // Enhanced Permissions
    function can(action){
        if(!state.currentUser) return false;
        if(action==='print') return true; // printing allowed to all users
        return state.currentUser.role==='admin';
    }

    // Navigation
    function initNavigation(){
        const items = document.querySelectorAll('.nav-item');
        items.forEach(a => a.addEventListener('click', (e)=>{
            e.preventDefault();
            const section = a.getAttribute('data-section');
            // Check permission if gated
            const perm = a.getAttribute('data-permission');
            if(perm && !can('access')){ return notify('Access denied. Admin only.', 'error'); }
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            a.classList.add('active');
            document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            if(section==='accounting') recalcAccounting();
            if(section==='sales') populateCustomerDropdown();
        }));
    }

    // Enhanced Dashboard
    function refreshDashboard(){
        const today = new Date().toISOString().split('T')[0];
        const todayTotal = state.sales.filter(s=>s.date===today).reduce((sum,s)=>sum+(s.total||0),0);
        document.getElementById('todaySales').textContent = fmt(todayTotal);
        
        const totalRev = state.sales.reduce((s,sl)=> s + (sl.total||0), 0);
        document.getElementById('monthlyProfit').textContent = fmt(totalRev);
        
        document.getElementById('totalItems').textContent = state.items.length;
        const low = state.items.filter(i=>i.stock<= (i.min||0)).length;
        const lowEl = document.getElementById('lowStockAlert'); 
        if(lowEl) lowEl.textContent = `Low Stock: ${low}`;
        document.getElementById('notificationCount').textContent = String(low);
        
        document.getElementById('activeCustomers').textContent = state.customers.length;
    }

    function showNotifications(){ 
        const low = state.items.filter(i=>i.stock<= (i.min||0));
        if(low.length > 0){
            notify(`${low.length} items are running low on stock`, 'warning');
        } else {
            notify('No new notifications','info'); 
        }
    }

    function quickSale(){ document.querySelector('[data-section="sales"]').click(); newSale(); }
    function addInventory(){ document.querySelector('[data-section="inventory"]').click(); addNewItem(); }
    function newCustomer(){ document.querySelector('[data-section="customers"]').click(); addNewCustomer(); }
    function recordExpense(){ document.querySelector('[data-section="transactions"]').click(); document.getElementById('transactionType').value = 'expense'; loadTransactionModule(); }
    function receiveDeposit(){ document.querySelector('[data-section="transactions"]').click(); document.getElementById('transactionType').value = 'receive-deposit'; loadTransactionModule(); }
    function printDashboard(){ window.print(); }

    // Enhanced Transactions with Expenses and Deposits
    function newTransaction(){ 
        if(!can('create')) return notify('Admin only','error'); 
        const sel = document.getElementById('transactionType'); 
        if(sel && !sel.value) { 
            notify('Please select a transaction type','warning'); 
            return; 
        } 
        loadTransactionModule(); 
    }
    
    function printTransactions(){ window.print(); }
    
    function loadTransactionModule(){
        const t = document.getElementById('transactionType').value;
        const c = document.getElementById('transactionModule');
        if(!t){ 
            c.innerHTML = `<div class="empty-state"><i class='fas fa-clipboard-list'></i><h3>Select Transaction Type</h3><p>Choose a transaction type from the dropdown above to get started.</p></div>`; 
            return; 
        }
        if(t==='receive-deposit') return renderReceiveDeposit(c);
        if(t==='expense') return renderExpenseForm(c);
        c.innerHTML = `<div class='card'><h3>${titleize(t)}</h3><p>Module functionality will be implemented here.</p></div>`;
    }

    // Receive Deposit Form
    function renderReceiveDeposit(container){
        container.innerHTML = `
        <form onsubmit="saveDeposit(event)" class="card">
            <h3><i class="fas fa-hand-holding-usd"></i> Receive Deposit</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Customer Name *</label>
                    <input type="text" id="depCustomer" required>
                </div>
                <div class="form-group">
                    <label>Item / Order Reference *</label>
                    <input type="text" id="depItem" placeholder="Item code or Order #" required>
                </div>
                <div class="form-group">
                    <label>Deposit Amount *</label>
                    <input type="number" id="depAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Total Order Amount</label>
                    <input type="number" id="depTotal" step="0.01" placeholder="Full order amount">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label>Notes</label>
                    <textarea id="depNotes" rows="2" placeholder="Additional notes about the deposit"></textarea>
                </div>
            </div>
            <div id="depositSummary" style="margin: 15px 0; padding: 15px; background: #f5f5f5; border-radius: 8px; display: none;">
                <h4>Deposit Summary</h4>
                <div><strong>Customer:</strong> <span id="sumCustomer"></span></div>
                <div><strong>Item:</strong> <span id="sumItem"></span></div>
                <div><strong>Deposit Amount:</strong> <span id="sumAmount"></span></div>
                <div><strong>Remaining Balance:</strong> <span id="sumRemaining"></span></div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Receive Deposit</button>
                <button type="button" class="btn btn-info print-allowed" onclick="printDepositReceipt()"><i class="fas fa-print"></i> Print Receipt</button>
            </div>
        </form>`;

        // Add real-time calculation
        ['depAmount', 'depTotal'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('input', updateDepositSummary);
        });
        ['depCustomer', 'depItem'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('input', updateDepositSummary);
        });
    }

    function updateDepositSummary(){
        const customer = document.getElementById('depCustomer').value.trim();
        const item = document.getElementById('depItem').value.trim();
        const amount = Number(document.getElementById('depAmount').value || 0);
        const total = Number(document.getElementById('depTotal').value || 0);
        
        if(customer || item || amount > 0){
            document.getElementById('depositSummary').style.display = 'block';
            document.getElementById('sumCustomer').textContent = customer || 'Not specified';
            document.getElementById('sumItem').textContent = item || 'Not specified';
            document.getElementById('sumAmount').textContent = fmt(amount);
            const remaining = total > amount ? total - amount : 0;
            document.getElementById('sumRemaining').textContent = fmt(remaining);
        } else {
            document.getElementById('depositSummary').style.display = 'none';
        }
    }

    function saveDeposit(ev){ 
        ev.preventDefault(); 
        if(!can('create')) return notify('Admin only','error');
        const customer = document.getElementById('depCustomer').value.trim();
        const item = document.getElementById('depItem').value.trim();
        const amount = Number(document.getElementById('depAmount').value||0);
        const total = Number(document.getElementById('depTotal').value||0);
        if(!customer || !item || amount<=0) return notify('Please fill in all required fields','error');
        const remaining = total>0 ? Math.max(0, total - amount) : 0;
        const dep = { 
            id:`DEP-${Date.now()}`, 
            date:new Date().toISOString().split('T')[0], 
            customer, 
            item, 
            amount, 
            total, 
            remaining, 
            notes: document.getElementById('depNotes').value||'' 
        };
        state.deposits.push(dep);
        state.transactions.push({
            id:dep.id, 
            type:'deposit', 
            date:dep.date, 
            party:customer, 
            amount:amount, 
            status:'completed'
        });
        refreshTransactionsTable();
        recalcAccounting();
        lastReceipt = buildDepositReceipt(dep);
        notify(`Deposit of ${fmt(amount)} received from ${customer}`, 'success');
    }

    function printDepositReceipt(){ 
        if(!lastReceipt) return notify('No recent receipt to print', 'warning');
        window.print(); 
    }

    // Expense Form
    function renderExpenseForm(container){
        container.innerHTML = `
        <form onsubmit="saveExpense(event)" class="card">
            <h3><i class="fas fa-receipt"></i> Record Expense</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Expense Category *</label>
                    <select id="expCategory" required>
                        <option value="">Select Category</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Rent">Rent</option>
                        <option value="Salaries">Salaries & Wages</option>
                        <option value="Transport">Transport</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Marketing">Marketing & Advertising</option>
                        <option value="Office Supplies">Office Supplies</option>
                        <option value="Professional Services">Professional Services</option>
                        <option value="Insurance">Insurance</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Vendor / Payee *</label>
                    <input type="text" id="expVendor" required>
                </div>
                <div class="form-group">
                    <label>Amount *</label>
                    <input type="number" id="expAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="expDate" value="${new Date().toISOString().split('T')[0]}" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group full-width">
                    <label>Description</label>
                    <textarea id="expDesc" rows="2" placeholder="Describe the expense"></textarea>
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Record Expense</button>
            </div>
        </form>`;
    }

    function saveExpense(ev){ 
        ev.preventDefault(); 
        if(!can('create')) return notify('Admin only','error');
        const amount = Number(document.getElementById('expAmount').value||0);
        const category = document.getElementById('expCategory').value;
        const vendor = document.getElementById('expVendor').value.trim();
        const date = document.getElementById('expDate').value;
        if(!category || !vendor || amount<=0) return notify('Please fill in all required fields','error');
        const exp = { 
            id:`EXP-${Date.now()}`, 
            category, 
            vendor, 
            amount, 
            date, 
            description: document.getElementById('expDesc').value||'' 
        };
        state.expenses.push(exp);
        state.transactions.push({
            id:exp.id, 
            type:'expense', 
            date:exp.date, 
            party:exp.vendor, 
            amount:-amount, 
            status:'completed'
        });
        refreshTransactionsTable();
        recalcAccounting();
        notify(`Expense of ${fmt(amount)} recorded for ${category}`, 'success');
    }

    function refreshTransactionsTable(){
        const tbody = document.getElementById('transactionsTableBody');
        if(!tbody) return;
        if(state.transactions.length===0){ 
            tbody.innerHTML = '<tr class="no-records"><td colspan="7">No transactions found. Create your first transaction above.</td></tr>'; 
            return; 
        }
        tbody.innerHTML = state.transactions.map(t=>`<tr>
            <td>${t.date}</td>
            <td>${titleize(t.type)}</td>
            <td>${t.id}</td>
            <td>${t.party||'-'}</td>
            <td class="${t.amount < 0 ? 'text-danger' : 'text-success'}">${fmt(Math.abs(t.amount))}</td>
            <td><span class="badge ${t.status === 'completed' ? 'active' : 'secondary'}">${t.status||'completed'}</span></td>
            <td><button class='btn btn-info btn-sm print-allowed' onclick="window.print()"><i class='fas fa-print'></i></button></td>
        </tr>`).join('');
    }

    function filterTransactions(){ 
        // Enhanced filtering can be implemented later
        refreshTransactionsTable();
    }

    // Professional Sales System
    function newSale(){ 
        if(!can('create')) return notify('Admin only','error');
        document.getElementById('salesInterface').style.display='grid';
        populateCustomerDropdown();
        renderSalesItems(state.items);
        renderCart();
    }

    function populateCustomerDropdown(){
        const sel = document.getElementById('saleCustomer');
        if(sel){
            sel.innerHTML = '<option value="">Walk-in Customer</option>' + 
                state.customers.map(c => `<option value="${c.id}">${c.firstName} ${c.lastName}</option>`).join('');
        }
    }

    function printSales(){ window.print(); }

    function searchItems(){
        const q = (document.getElementById('itemSearch').value||'').toLowerCase();
        const filtered = state.items.filter(i=> [i.code,i.name,i.category].some(v=>String(v).toLowerCase().includes(q)));
        renderSalesItems(filtered);
    }

    function filterByCategory(cat){
        document.querySelectorAll('.category-btn').forEach(b=>b.classList.remove('active'));
        event.target.classList.add('active');
        renderSalesItems(cat==='all'? state.items : state.items.filter(i=>i.category===cat));
    }

    function renderSalesItems(list){
        const c = document.getElementById('salesItems'); c.innerHTML='';
        if(list.length===0){ c.innerHTML = '<p style="color:#666">No items found</p>'; return; }
        const grid = document.createElement('div'); 
        grid.style.display='grid'; 
        grid.style.gridTemplateColumns='repeat(auto-fill,minmax(200px,1fr))'; 
        grid.style.gap='12px';
        list.forEach(item=>{
            const d = document.createElement('div');
            d.style.border='2px solid #e1e8ed'; 
            d.style.borderRadius='10px'; 
            d.style.padding='12px'; 
            d.style.cursor='pointer';
            d.innerHTML = `
                <div style="font-weight:700; color:#1a237e; margin-bottom: 8px;">${item.name}</div>
                <div style="color:#607d8b; font-size: 12px;">Code: ${item.code}</div>
                <div style="color:#607d8b; font-size: 12px;">Stock: ${item.stock} ${item.unit||'pcs'}</div>
                <div style="color:#2e7d32; font-weight:800; margin:8px 0; font-size: 16px;">${fmt(item.price)}</div>
                <button class="btn btn-primary btn-sm" style="width: 100%;"><i class="fas fa-plus"></i> Add to Cart</button>`;
            d.querySelector('button').onclick = ()=> addToCart(item.id);
            grid.appendChild(d);
        });
        c.appendChild(grid);
    }

    function addToCart(id){
        const item = state.items.find(i=>i.id===id); if(!item) return;
        if(item.stock<=0) return notify('Out of stock','warning');
        const existing = state.cart.find(c=>c.id===id);
        if(existing){ 
            if(existing.qty < item.stock){ 
                existing.qty++; 
                existing.total=existing.qty*existing.price; 
            } else {
                notify('Insufficient stock','warning');
                return;
            }
        }
        else { 
            state.cart.push({ 
                id, 
                name:item.name, 
                code: item.code,
                price:item.price, 
                qty:1, 
                total:item.price,
                unit: item.unit || 'pcs'
            }); 
        }
        renderCart();
        notify(`${item.name} added to cart`, 'success');
    }

    function renderCart(){
        const c = document.getElementById('cartItems'); c.innerHTML='';
        if(state.cart.length===0){ 
            c.innerHTML = `<div class="empty-cart"><i class="fas fa-shopping-cart"></i><p>Cart is empty</p></div>`; 
            updateCartSummary(); 
            return; 
        }
        state.cart.forEach((ci, idx)=>{
            const row = document.createElement('div'); row.className='cart-item';
            row.innerHTML = `
                <div>
                    <strong>${ci.name}</strong>
                    <div style="color:#607d8b; font-size: 12px;">Code: ${ci.code} | Unit: ${ci.unit}</div>
                    <div style="color:#607d8b">${fmt(ci.price)}  ${ci.qty}</div>
                </div>
                <div style="display:flex;gap:6px;align-items:center;">
                    <button class="btn btn-warning btn-sm"><i class="fas fa-minus"></i></button>
                    <div style="min-width:100px;text-align:right;font-weight:700">${fmt(ci.total)}</div>
                    <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i></button>
                    <button class="btn btn-secondary btn-sm"><i class="fas fa-trash"></i></button>
                </div>`;
            const buttons = row.children[1].children;
            buttons[0].onclick = ()=> { // Decrease
                if(ci.qty>1){ 
                    ci.qty--; 
                    ci.total=ci.qty*ci.price;
                } else { 
                    state.cart.splice(idx,1);
                } 
                renderCart(); 
            };
            buttons[2].onclick = ()=> { // Increase
                const item=state.items.find(i=>i.id===ci.id); 
                if(ci.qty<item.stock){ 
                    ci.qty++; 
                    ci.total=ci.qty*ci.price; 
                    renderCart(); 
                } else {
                    notify('Insufficient stock', 'warning');
                }
            };
            buttons[3].onclick = ()=> { // Remove
                state.cart.splice(idx,1); 
                renderCart(); 
            };
            c.appendChild(row);
        });
        updateCartSummary();
    }

    function updateCartSummary(){
        const sub = state.cart.reduce((s,c)=>s+c.total,0);
        const tax = state.config.enableTax? sub * (state.config.taxRate/100) : 0;
        const disc = 0;
        const tot = sub + tax - disc;
        document.getElementById('cartSubtotal').textContent = fmt(sub);
        document.getElementById('cartTax').textContent = fmt(tax);
        document.getElementById('cartDiscount').textContent = fmt(disc);
        document.getElementById('cartTotal').textContent = fmt(tot);
        return {sub, tax, disc, tot};
    }

    function clearCart(){ 
        state.cart = []; 
        renderCart(); 
        notify('Cart cleared','info'); 
    }

    function calculateChange(){ 
        const { tot } = updateCartSummary(); 
        const paid = Number(document.getElementById('amountPaid').value||0); 
        const change = Math.max(0, paid-tot); 
        document.getElementById('changeAmount').textContent = fmt(change); 
    }

    function processPayment(){
        if(!can('create')) return notify('Admin only','error');
        if(state.cart.length===0) return notify('Cart is empty','warning');
        const {sub,tax,disc,tot} = updateCartSummary();
        const customerId = document.getElementById('saleCustomer').value;
        const customerName = customerId ? 
            state.customers.find(c => c.id === customerId)?.firstName + ' ' + state.customers.find(c => c.id === customerId)?.lastName :
            'Walk-in Customer';
        
        const sale = { 
            id:`SAL-${Date.now()}`, 
            date:new Date().toISOString().split('T')[0], 
            customer: customerName,
            customerId: customerId || null,
            items: JSON.parse(JSON.stringify(state.cart)), 
            subtotal: sub, 
            tax, 
            discount: disc, 
            total: tot, 
            status:'completed', 
            payment: document.getElementById('paymentMethod').value 
        };
        
        state.sales.push(sale); 
        state.transactions.push({
            id:sale.id,
            type:'sale',
            date:sale.date,
            party:customerName,
            amount:tot,
            status:'completed'
        });
        
        // Reduce stock and update customer purchases
        sale.items.forEach(ci=>{ 
            const it = state.items.find(i=>i.id===ci.id); 
            if(it) it.stock = Math.max(0, it.stock - ci.qty); 
        });
        
        if(customerId){
            const customer = state.customers.find(c => c.id === customerId);
            if(customer) customer.totalPurchases = (customer.totalPurchases || 0) + tot;
        }
        
        state.cart = []; 
        renderCart(); 
        refreshInventoryTable(); 
        refreshCustomersTable();
        refreshTransactionsTable();
        refreshSalesTable();
        refreshDashboard();
        recalcAccounting();
        
        lastReceipt = buildReceiptDataFromSale(sale);
        notify(`Sale of ${fmt(tot)} completed successfully!`,'success');
    }

    function refreshSalesTable(){
        const tbody = document.getElementById('salesTableBody');
        if(!tbody) return;
        if(state.sales.length===0){ 
            tbody.innerHTML = '<tr class="no-records"><td colspan="11">No sales records found.</td></tr>'; 
            return; 
        }
        let rows = '';
        state.sales.forEach(sale => {
            sale.items.forEach((item, itemIndex) => {
                if(itemIndex === 0){
                    // First item shows sale info
                    rows += `<tr>
                        <td rowspan="${sale.items.length}">${sale.date}</td>
                        <td rowspan="${sale.items.length}">${sale.id}</td>
                        <td rowspan="${sale.items.length}">${sale.customer}</td>
                        <td>${item.name} (${item.code})</td>
                        <td>${fmt(item.price)}</td>
                        <td>${item.qty} ${item.unit}</td>
                        <td>${fmt(item.total)}</td>
                        <td rowspan="${sale.items.length}">${fmt(sale.total)}</td>
                        <td rowspan="${sale.items.length}">${sale.payment}</td>
                        <td rowspan="${sale.items.length}"><span class="badge active">${sale.status}</span></td>
                        <td rowspan="${sale.items.length}"><button class='btn btn-info btn-sm print-allowed' onclick="window.print()"><i class='fas fa-print'></i></button></td>
                    </tr>`;
                } else {
                    // Additional items just show item details
                    rows += `<tr>
                        <td>${item.name} (${item.code})</td>
                        <td>${fmt(item.price)}</td>
                        <td>${item.qty} ${item.unit}</td>
                        <td>${fmt(item.total)}</td>
                    </tr>`;
                }
            });
        });
        tbody.innerHTML = rows;
    }

    function printReceipt(){ 
        if(!lastReceipt) return notify('No recent receipt to print', 'warning');
        window.print(); 
    }
    function filterSales(){ refreshSalesTable(); }

    // Inventory Management
    function addNewItem(){ 
        if(!can('create')) return notify('Admin only','error'); 
        document.getElementById('inventoryForm').style.display='block'; 
    }
    function stockAdjustment(){ if(!can('edit')) return notify('Admin only','error'); notify('Stock adjustment feature coming soon','info'); }
    function importItems(){ if(!can('create')) return notify('Admin only','error'); notify('Import wizard not implemented in demo','info'); }
    function exportInventory(){
        const header = 'Code,Name,Category,Stock,Cost Price,Selling Price,Unit\n';
        const rows = state.items.map(i=>[i.code,i.name,i.category,i.stock,i.cost,i.price,i.unit||'pcs'].join(',')).join('\n');
        downloadCSV('inventory_export.csv', header+rows);
        notify('Inventory exported','success');
    }
    function printInventory(){ window.print(); }

    function saveInventoryItem(ev){ 
        ev.preventDefault(); 
        if(!can('create')) return notify('Admin only','error');
        const get = id => document.getElementById(id).value;
        const item = {
            id:`ITM-${Date.now()}`,
            code:get('itemCode'), 
            name:get('itemName'), 
            category:get('itemCategory'), 
            brand:get('itemBrand'), 
            cost:Number(get('costPrice')||0), 
            price:Number(get('sellingPrice')||0), 
            unit:get('itemUnit'), 
            stock:Number(get('initialStock')||0), 
            min:Number(get('minStockLevel')||0), 
            status:'active',
            location: get('itemLocation'),
            description: get('itemDescription')
        };
        if(!item.code || !item.name || !item.category || item.cost < 0 || item.price < 0) return notify('Please fill required fields with valid values','error');
        if(item.price <= item.cost) {
            if(!confirm('Selling price is not higher than cost price. This will result in no profit. Continue?')) return;
        }
        state.items.push(item); 
        refreshInventoryTable(); 
        document.getElementById('inventoryForm').style.display='none'; 
        ev.target.reset(); 
        refreshDashboard(); 
        recalcAccounting();
        notify(`Item "${item.name}" added successfully`,'success');
    }

    function cancelItemForm(){ document.getElementById('inventoryForm').style.display='none'; }
    function clearItemForm(){ const form = document.querySelector('#inventoryForm form'); form && form.reset(); }

    function filterInventory(){ 
        const q=(document.getElementById('inventorySearch').value||'').toLowerCase(); 
        const cat=document.getElementById('categoryFilter').value; 
        const stock=document.getElementById('stockFilter').value; 
        const status=document.getElementById('statusFilter').value; 
        let list=[...state.items]; 
        if(q) list=list.filter(i=>[i.code,i.name,i.category].some(v=>String(v).toLowerCase().includes(q))); 
        if(cat) list=list.filter(i=>i.category===cat); 
        if(status) list=list.filter(i=>i.status===status); 
        if(stock==='in-stock') list=list.filter(i=>i.stock>0); 
        if(stock==='low-stock') list=list.filter(i=>i.stock<= (i.min||0) && i.stock>0); 
        if(stock==='out-of-stock') list=list.filter(i=>i.stock===0); 
        refreshInventoryTable(list);
    }

    function refreshInventoryTable(list){ 
        const data = list||state.items; 
        const tbody = document.getElementById('inventoryTableBody'); 
        if(!tbody) return; 
        if(!data.length){ 
            tbody.innerHTML = '<tr class="no-records"><td colspan="9">No inventory items found. Add your first item above.</td></tr>'; 
            return; 
        } 
        tbody.innerHTML = data.map(i=>{
            const margin = i.cost > 0 ? ((i.price-i.cost)/i.cost*100).toFixed(1) : '0';
            const stockStatus = i.stock <= (i.min||0) ? 'color: red; font-weight: bold;' : '';
            return `<tr>
                <td>${i.code}</td>
                <td>${i.name}</td>
                <td>${i.category}</td>
                <td style="${stockStatus}">${i.stock} ${i.unit||'pcs'}</td>
                <td>${fmt(i.cost)}</td>
                <td>${fmt(i.price)}</td>
                <td>${margin}%</td>
                <td><span class="badge ${i.status==='active'?'active':'secondary'}">${i.status}</span></td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="editItem('${i.id}')"><i class='fas fa-edit'></i></button>
                    <button class="btn btn-info btn-sm print-allowed" onclick="window.print()"><i class='fas fa-print'></i></button>
                </td>
            </tr>`;
        }).join(''); 
    }

    function editItem(id){ if(!can('edit')) return notify('Admin only','error'); notify('Edit item feature coming soon','info'); }

    // Customer Management
    function addNewCustomer(){ 
        if(!can('create')) return notify('Admin only','error'); 
        // Generate customer ID
        const customerId = `CUS-${Date.now()}`;
        document.getElementById('customerId').value = customerId;
        document.getElementById('customerForm').style.display='block'; 
    }

    function saveCustomer(ev){ 
        ev.preventDefault(); 
        if(!can('create')) return notify('Admin only','error'); 
        const customer = {
            id: document.getElementById('customerId').value,
            type: document.getElementById('customerType').value,
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            companyName: document.getElementById('companyName').value,
            email: document.getElementById('customerEmail').value,
            phone: document.getElementById('customerPhone').value,
            address: document.getElementById('customerAddress').value,
            totalPurchases: 0,
            dateAdded: new Date().toISOString().split('T')[0]
        };
        if(!customer.firstName || !customer.lastName || !customer.phone) {
            return notify('Please fill in required fields','error');
        }
        state.customers.push(customer);
        refreshCustomersTable();
        document.getElementById('customerForm').style.display='none'; 
        ev.target.reset(); 
        refreshDashboard();
        notify(`Customer "${customer.firstName} ${customer.lastName}" added successfully`,'success');
    }

    function refreshCustomersTable(){
        const tbody = document.getElementById('customersTableBody');
        if(!tbody) return;
        if(state.customers.length===0){ 
            tbody.innerHTML = '<tr class="no-records"><td colspan="7">No customers found. Add your first customer above.</td></tr>'; 
            return; 
        }
        tbody.innerHTML = state.customers.map(c=>`<tr>
            <td>${c.id}</td>
            <td>${c.firstName} ${c.lastName}</td>
            <td>${c.type}</td>
            <td>${c.email||'-'}</td>
            <td>${c.phone}</td>
            <td>${fmt(c.totalPurchases||0)}</td>
            <td>
                <button class="btn btn-primary btn-sm" onclick="editCustomer('${c.id}')"><i class='fas fa-edit'></i></button>
                <button class="btn btn-info btn-sm print-allowed" onclick="window.print()"><i class='fas fa-print'></i></button>
            </td>
        </tr>`).join('');
    }

    function cancelCustomerForm(){ document.getElementById('customerForm').style.display='none'; }
    function clearCustomerForm(){ const f=document.querySelector('#customerForm form'); f && f.reset(); }
    function importCustomers(){ if(!can('create')) return notify('Admin only','error'); notify('Import wizard coming soon','info'); }
    function exportCustomers(){ 
        const header = 'ID,First Name,Last Name,Type,Email,Phone,Total Purchases\n';
        const rows = state.customers.map(c=>[c.id,c.firstName,c.lastName,c.type,c.email||'',c.phone,c.totalPurchases||0].join(',')).join('\n');
        downloadCSV('customers_export.csv', header+rows); 
        notify('Customers exported','success'); 
    }
    function printCustomers(){ window.print(); }
    function filterCustomers(){ refreshCustomersTable(); }
    function editCustomer(id){ if(!can('edit')) return notify('Admin only','error'); notify('Edit customer feature coming soon','info'); }

    // Suppliers
    function addNewSupplier(){ if(!can('create')) return notify('Admin only','error'); notify('Add supplier feature coming soon','info'); }
    function printSuppliers(){ window.print(); }

    // Professional Accounting System with P&L Integration
    function recalcAccounting(){
        // Calculate comprehensive financial metrics
        const revenue = state.sales.reduce((s,sl)=> s + (sl.total||0), 0);
        
        // Calculate Cost of Goods Sold based on actual sales
        let cogs = 0;
        state.sales.forEach(sl=>{
            sl.items.forEach(it=>{
                const inv = state.items.find(i=>i.id===it.id);
                const cost = inv? inv.cost : 0;
                cogs += (it.qty||0) * cost;
            });
        });
        
        const expenses = state.expenses.reduce((s,e)=> s + (e.amount||0), 0);
        const grossProfit = revenue - cogs;
        const netProfit = grossProfit - expenses;
        
        // Update display
        document.getElementById('totalRevenue').textContent = fmt(revenue);
        document.getElementById('totalCOGS').textContent = fmt(cogs);
        document.getElementById('totalExpenses').textContent = fmt(expenses);
        document.getElementById('netProfit').textContent = fmt(netProfit);
        
        // Update dashboard profit
        document.getElementById('monthlyProfit').textContent = fmt(netProfit);
    }

    function openAccountingModule(k){ 
        document.getElementById('accountingModuleContent').style.display='block'; 
        document.getElementById('accountingModuleTitle').textContent = titleize(k); 
        let content = '';
        
        if(k === 'chart-of-accounts'){
            content = `
                <div class='card'>
                    <h3>Chart of Accounts</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr><th>Account Code</th><th>Account Name</th><th>Type</th><th>Balance</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>1000</td><td>Cash</td><td>Asset</td><td>${fmt(state.deposits.reduce((s,d)=>s+d.amount,0))}</td></tr>
                                <tr><td>1100</td><td>Inventory</td><td>Asset</td><td>${fmt(state.items.reduce((s,i)=>s+i.stock*i.cost,0))}</td></tr>
                                <tr><td>4000</td><td>Sales Revenue</td><td>Income</td><td>${fmt(state.sales.reduce((s,sl)=>s+sl.total,0))}</td></tr>
                                <tr><td>5000</td><td>Cost of Goods Sold</td><td>Expense</td><td>${fmt(state.sales.reduce((s,sl)=>s+sl.items.reduce((is,it)=>{const inv=state.items.find(i=>i.id===it.id);return is+(it.qty*(inv?inv.cost:0))},0),0))}</td></tr>
                                <tr><td>6000</td><td>Operating Expenses</td><td>Expense</td><td>${fmt(state.expenses.reduce((s,e)=>s+e.amount,0))}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
        } else if(k === 'general-ledger'){
            content = `
                <div class='card'>
                    <h3>General Ledger</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr><th>Date</th><th>Description</th><th>Reference</th><th>Debit</th><th>Credit</th><th>Balance</th></tr>
                            </thead>
                            <tbody>`;
            let balance = 0;
            state.transactions.forEach(t => {
                if(t.amount > 0){
                    balance += t.amount;
                    content += `<tr><td>${t.date}</td><td>${titleize(t.type)}</td><td>${t.id}</td><td>${fmt(t.amount)}</td><td>-</td><td>${fmt(balance)}</td></tr>`;
                } else {
                    balance += t.amount;
                    content += `<tr><td>${t.date}</td><td>${titleize(t.type)}</td><td>${t.id}</td><td>-</td><td>${fmt(Math.abs(t.amount))}</td><td>${fmt(balance)}</td></tr>`;
                }
            });
            content += `</tbody></table></div></div>`;
        } else {
            content = `<div class='card'><h3>${titleize(k)} Module</h3><p>This module is under development and will provide comprehensive ${titleize(k)} functionality.</p></div>`;
        }
        
        document.getElementById('accountingModuleBody').innerHTML = content;
    }
    
    function closeAccountingModule(){ document.getElementById('accountingModuleContent').style.display='none'; }

    // Enhanced Reports with Profit & Loss
    function loadReportCategory(cat){
        document.getElementById('reportContent').style.display='block';
        document.getElementById('reportTitle').textContent = `${titleize(cat)} Reports`;
        const specific = document.getElementById('reportSpecificFilters');
        specific.innerHTML = '';
        if(cat==='profit-loss'){
            specific.innerHTML = `
                <div class="filter-group">
                    <label>Group by:</label>
                    <select id="plGroup">
                        <option value="monthly">Monthly</option>
                        <option value="daily">Daily</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>`;
        }
        document.getElementById('reportBody').innerHTML='';
        document.getElementById('reportContent').dataset.report = cat;
    }

    function generateReport(){
        const type = document.getElementById('reportContent').dataset.report;
        if(type==='profit-loss') return generatePLReport();
        
        // Default reports
        let content = `<div class='card'><h3>Generated Report - ${titleize(type)}</h3>`;
        if(type === 'sales'){
            content += `
                <div><strong>Total Sales:</strong> ${fmt(state.sales.reduce((s,a)=>s+(a.total||0),0))}</div>
                <div><strong>Number of Sales:</strong> ${state.sales.length}</div>
                <div><strong>Average Sale:</strong> ${fmt(state.sales.length > 0 ? state.sales.reduce((s,a)=>s+(a.total||0),0) / state.sales.length : 0)}</div>`;
        } else if(type === 'inventory'){
            const totalValue = state.items.reduce((s,i)=>s+(i.stock*i.cost),0);
            const lowStock = state.items.filter(i=>i.stock<=(i.min||0)).length;
            content += `
                <div><strong>Total Items:</strong> ${state.items.length}</div>
                <div><strong>Total Inventory Value:</strong> ${fmt(totalValue)}</div>
                <div><strong>Low Stock Items:</strong> ${lowStock}</div>`;
        }
        content += '</div>';
        document.getElementById('reportBody').innerHTML = content;
        notify('Report generated','success');
    }

    function generatePLReport(){
        recalcAccounting();
        const from = document.getElementById('reportFromDate').value || '0000-01-01';
        const to = document.getElementById('reportToDate').value || '9999-12-31';
        const inRange = (d)=> d>=from && d<=to;
        
        const sales = state.sales.filter(s=> inRange(s.date));
        const revenue = sales.reduce((s,a)=> s + (a.total||0), 0);
        
        let cogs = 0; 
        sales.forEach(sl=> sl.items.forEach(it=>{
            const inv = state.items.find(i=>i.id===it.id); 
            cogs += (it.qty||0) * (inv?inv.cost:0); 
        }));
        
        const expenses = state.expenses.filter(e=> inRange(e.date)).reduce((s,e)=> s + (e.amount||0), 0);
        const gross = revenue - cogs; 
        const net = gross - expenses;
        
        // Expense breakdown
        const expensesByCategory = {};
        state.expenses.filter(e=> inRange(e.date)).forEach(e => {
            expensesByCategory[e.category] = (expensesByCategory[e.category] || 0) + e.amount;
        });
        
        let expenseBreakdown = '';
        Object.entries(expensesByCategory).forEach(([cat, amount]) => {
            expenseBreakdown += `<div style="margin-left: 20px;"> ${cat}: ${fmt(amount)}</div>`;
        });
        
        document.getElementById('reportBody').innerHTML = `
            <div class='card'>
                <h3>Profit & Loss Statement</h3>
                <div style="font-size: 14px; color: #666; margin-bottom: 20px;">Period: ${from} to ${to}</div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; color: #2e7d32;">REVENUE</div>
                    <div style="margin-left: 20px;">Sales Revenue: ${fmt(revenue)}</div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; color: #1976d2;">COST OF GOODS SOLD</div>
                    <div style="margin-left: 20px;">Cost of Goods Sold: ${fmt(cogs)}</div>
                </div>
                
                <div style="margin-bottom: 15px; padding-top: 10px; border-top: 2px solid #ddd;">
                    <div style="font-weight: bold;">GROSS PROFIT: ${fmt(gross)}</div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; color: #d32f2f;">OPERATING EXPENSES</div>
                    ${expenseBreakdown || '<div style="margin-left: 20px;">No expenses recorded</div>'}
                    <div style="margin-left: 20px; font-weight: bold; margin-top: 10px;">Total Expenses: ${fmt(expenses)}</div>
                </div>
                
                <div style="margin-bottom: 15px; padding-top: 15px; border-top: 3px solid #333;">
                    <div style="font-weight: bold; font-size: 18px; color: ${net >= 0 ? '#2e7d32' : '#d32f2f'};">
                        NET PROFIT: ${fmt(net)}
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 12px; color: #666;">
                    <div>Gross Profit Margin: ${revenue > 0 ? (gross/revenue*100).toFixed(2) : 0}%</div>
                    <div>Net Profit Margin: ${revenue > 0 ? (net/revenue*100).toFixed(2) : 0}%</div>
                </div>
            </div>`;
        notify('Profit & Loss statement generated','success');
    }

    function exportReport(){
        const type = document.getElementById('reportContent').dataset.report;
        if(type==='profit-loss'){
            // Export P&L as CSV
            const from = document.getElementById('reportFromDate').value || '0000-01-01';
            const to = document.getElementById('reportToDate').value || '9999-12-31';
            const inRange = (d)=> d>=from && d<=to;
            
            const sales = state.sales.filter(s=> inRange(s.date));
            const revenue = sales.reduce((s,a)=> s + (a.total||0), 0);
            
            let cogs = 0; 
            sales.forEach(sl=> sl.items.forEach(it=>{
                const inv = state.items.find(i=>i.id===it.id); 
                cogs += (it.qty||0) * (inv?inv.cost:0); 
            }));
            
            const expenses = state.expenses.filter(e=> inRange(e.date)).reduce((s,e)=> s + (e.amount||0), 0);
            const gross = revenue - cogs; 
            const net = gross - expenses;
            
            const csv = `Profit & Loss Statement,${from} to ${to}\n\nMetric,Amount\nRevenue,${revenue}\nCost of Goods Sold,${cogs}\nGross Profit,${gross}\nTotal Expenses,${expenses}\nNet Profit,${net}`;
            downloadCSV('profit_loss_statement.csv', csv);
            notify('P&L exported successfully','success');
            return;
        }
        
        // Default export
        downloadCSV(`${type}_report.csv`,'Metric,Value\nTotal Sales,'+ state.sales.reduce((s,a)=>s+(a.total||0),0));
        notify('Report exported','success');
    }

    function printReport(){ window.print(); }
    function closeReport(){ document.getElementById('reportContent').style.display='none'; }
// SETTINGS: state holders
if (!window.state) window.state = {};
state.users = state.users || [{ username: 'admin', fullName: 'System Administrator', email: 'admin@system.com', role: 'admin', status: 'active', lastLogin: new Date().toISOString() }];
state.permissions = state.permissions || {
  // Defaults for non-admin roles; admin checked at runtime
  'transactions-view': true, 'transactions-create': true, 'transactions-edit': true, 'transactions-delete': false,
  'sales-view': true, 'sales-create': true,
  'inventory-view': true, 'inventory-create': true, 'inventory-edit': true, 'inventory-delete': false,
  'customers-view': true, 'customers-create': true, 'customers-edit': true,
  'suppliers-view': true, 'suppliers-create': true, 'suppliers-edit': true,
  'accounting-view': true, 'accounting-create': true, 'accounting-edit': true,
  'reports-view': true, 'reports-export': true,
  'settings-access': true, 'settings-modify': true
};
state.system = state.system || { theme: 'dark', dateFormat: 'DD/MM/YYYY', timeFormat: '24', autoSave: true, lowStockAlerts: true, emailNotifications: false, receiptHeader: 'Thank you for your business!', receiptFooter: 'Visit us again soon!', printLogo: false };

// SETTINGS: UI helpers
function showSettingsTab(name) {
  document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(name + '-settings').classList.add('active');
}

function refreshUsersTable() {
  const tbody = document.getElementById('usersTableBody');
  if (!tbody) return;
  const rows = state.users.map(u => `
    <tr>
      <td>${u.username}</td>
      <td>${u.fullName}</td>
      <td>${u.email || '-'}</td>
      <td><span class="badge ${u.role==='admin'?'admin':'active'}">${u.role==='admin'?'Administrator':u.role}</span></td>
      <td><span class="badge ${u.status==='active'?'active':'secondary'}">${u.status==='active'?'Active':'Inactive'}</span></td>
      <td>${u.lastLogin ? new Date(u.lastLogin).toLocaleString() : '-'}</td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="editUser('${u.username}')"><i class="fas fa-edit"></i></button>
      </td>
    </tr>
  `).join('');
  tbody.innerHTML = rows;
}

// Company settings
function saveCompanySettings(ev) {
  ev.preventDefault();
  if (!state.config) state.config = {};
  state.config.companyName = document.getElementById('companyName').value || state.config.companyName || 'Company';
  state.config.currency = document.getElementById('companyCurrency').value || state.config.currency || 'UGX';
  state.config.enableTax = document.getElementById('enableTax').checked;
  state.config.taxRate = Number(document.getElementById('taxRate').value || 18);
  state.config.businessRegNo = document.getElementById('businessRegNo').value || '';
  state.config.taxIdNumber = document.getElementById('taxIdNumber').value || '';
  state.config.businessType = document.getElementById('businessType').value || 'retail';
  state.config.companyPhone = document.getElementById('companyPhone').value || '';
  state.config.companyEmail = document.getElementById('companyEmail').value || '';
  state.config.companyWebsite = document.getElementById('companyWebsite').value || '';
  state.config.companyAddress = document.getElementById('companyAddress').value || '';
  state.config.fiscalYearStart = document.getElementById('fiscalYearStart').value || '01';

  // Reflect immediately
  const companyDisplay = document.getElementById('companyDisplay');
  const loginCompanyDisplay = document.getElementById('loginCompanyDisplay');
  if (companyDisplay) companyDisplay.textContent = state.config.companyName;
  if (loginCompanyDisplay) loginCompanyDisplay.textContent = state.config.companyName;

  // If you have a global currency selector, sync it
  const gc = document.getElementById('globalCurrency');
  if (gc) gc.value = state.config.currency;

  // Recompute monetary UI
  if (typeof refreshInventoryTable === 'function') refreshInventoryTable();
  if (typeof updateCartSummary === 'function') updateCartSummary();
  if (typeof recalcAccounting === 'function') recalcAccounting();
  if (typeof refreshDashboard === 'function') refreshDashboard();

  notify('Company settings saved', 'success');
}

// Users CRUD
function openUserForm() {
  if (typeof can === 'function' && !can('create')) return notify('Admin only', 'error');
  document.getElementById('userModalTitle').textContent = 'Add User';
  ['user_username','user_fullName','user_email','user_password','user_confirm'].forEach(id => { const el = document.getElementById(id); if (el) el.value=''; });
  document.getElementById('user_role').value = 'staff';
  document.getElementById('user_status').value = 'active';
  document.getElementById('userModal').style.display = 'flex';
}
function closeUserForm(){ document.getElementById('userModal').style.display = 'none'; }

function saveUser(ev) {
  ev.preventDefault();
  if (typeof can === 'function' && !can('create')) return notify('Admin only', 'error');
  const username = document.getElementById('user_username').value.trim();
  const fullName = document.getElementById('user_fullName').value.trim();
  const email = document.getElementById('user_email').value.trim();
  const role = document.getElementById('user_role').value;
  const status = document.getElementById('user_status').value;
  const pw = document.getElementById('user_password').value;
  const cf = document.getElementById('user_confirm').value;
  if (!username || !fullName || !pw || !cf) return notify('Please fill required fields', 'error');
  if (pw !== cf) return notify('Passwords do not match', 'error');

  const existing = state.users.find(u => u.username === username);
  if (existing) {
    // Edit existing
    existing.fullName = fullName; existing.email = email; existing.role = role; existing.status = status;
    notify('User updated', 'success');
  } else {
    state.users.push({ username, fullName, email, role, status, lastLogin: null });
    notify('User added', 'success');
  }
  refreshUsersTable();
  closeUserForm();
}

function editUser(username) {
  if (typeof can === 'function' && !can('edit')) return notify('Admin only', 'error');
  const u = state.users.find(x => x.username === username);
  if (!u) return notify('User not found', 'error');
  document.getElementById('userModalTitle').textContent = 'Edit User';
  document.getElementById('user_username').value = u.username;
  document.getElementById('user_fullName').value = u.fullName;
  document.getElementById('user_email').value = u.email || '';
  document.getElementById('user_role').value = u.role;
  document.getElementById('user_status').value = u.status;
  // For security, do not prefill password fields
  document.getElementById('user_password').value = '';
  document.getElementById('user_confirm').value = '';
  document.getElementById('userModal').style.display = 'flex';
}

// Permissions
function savePermissions() {
  if (typeof can === 'function' && !can('edit')) return notify('Admin only', 'error');
  const ids = [
    'transactions-view','transactions-create','transactions-edit','transactions-delete',
    'sales-view','sales-create',
    'inventory-view','inventory-create','inventory-edit','inventory-delete',
    'customers-view','customers-create','customers-edit',
    'suppliers-view','suppliers-create','suppliers-edit',
    'accounting-view','accounting-create','accounting-edit',
    'reports-view','reports-export',
    'settings-access','settings-modify'
  ];
  ids.forEach(k => {
    const el = document.getElementById(`perm-${k}`);
    if (el) state.permissions[k] = !!el.checked;
  });
  notify('Permissions saved', 'success');
}

function setDefaultPermissions() {
  if (typeof can === 'function' && !can('edit')) return notify('Admin only', 'error');
  // Default: all enabled for simplicity; admin already has full access at runtime
  Object.keys(state.permissions).forEach(k => state.permissions[k] = true);
  Object.keys(state.permissions).forEach(k => {
    const el = document.getElementById(`perm-${k}`);
    if (el && !el.disabled) el.checked = true;
  });
  notify('Permissions reset to default', 'info');
}

// You can use this to enforce permissions in navigation/actions for non-admin users
function hasPermission(key) {
  // Admin: full access to all pages and functionalities
  if (state.currentUser && state.currentUser.role === 'admin') return true;
  if (key === 'print') return true; // printing available to all users
  return !!state.permissions[key];
}

// System settings
function saveSystemSettings(ev) {
  ev.preventDefault();
  state.system.theme = document.getElementById('systemTheme').value;
  state.system.dateFormat = document.getElementById('dateFormat').value;
  state.system.timeFormat = document.getElementById('timeFormat').value;
  state.system.autoSave = document.getElementById('autoSave').checked;
  state.system.lowStockAlerts = document.getElementById('lowStockAlerts').checked;
  state.system.emailNotifications = document.getElementById('emailNotifications').checked;
  state.system.receiptHeader = document.getElementById('receiptHeader').value;
  state.system.receiptFooter = document.getElementById('receiptFooter').value;
  state.system.printLogo = document.getElementById('printLogo').checked;

  applyTheme(state.system.theme);
  notify('System settings saved', 'success');
}

function applyTheme(theme) {
  const body = document.body;
  body.dataset.theme = theme; // allow CSS to target [data-theme="dark"]
  // Optional: simple background tweak
  if (theme === 'dark') {
    body.style.background = 'linear-gradient(135deg, #0d1117 0%, #1f2937 100%)';
  } else if (theme === 'green') {
    body.style.background = 'linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%)';
  } else {
    body.style.background = 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)';
  }
}

// Backup & Export/Import
function createBackup() {
  const data = {
    version: '7.0.1',
    timestamp: new Date().toISOString(),
    config: state.config,
    system: state.system,
    items: state.items,
    customers: state.customers,
    suppliers: state.suppliers,
    users: state.users,
    permissions: state.permissions,
    transactions: state.transactions,
    sales: state.sales,
    expenses: state.expenses,
    deposits: state.deposits
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  downloadBlob('salesmanager_backup.json', blob);
  notify('Backup created', 'success');
}

function restoreBackup(ev) {
  const file = ev.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      // Basic merge (non-destructive if fields missing)
      state.config = data.config || state.config;
      state.system = data.system || state.system;
      state.items = data.items || state.items;
      state.customers = data.customers || state.customers;
      state.suppliers = data.suppliers || state.suppliers;
      state.users = data.users || state.users;
      state.permissions = data.permissions || state.permissions;
      state.transactions = data.transactions || state.transactions;
      state.sales = data.sales || state.sales;
      state.expenses = data.expenses || state.expenses;
      state.deposits = data.deposits || state.deposits;

      // Refresh UI
      refreshUsersTable();
      if (typeof refreshInventoryTable === 'function') refreshInventoryTable();
      if (typeof refreshTransactionsTable === 'function') refreshTransactionsTable();
      if (typeof refreshSalesTable === 'function') refreshSalesTable();
      if (typeof recalcAccounting === 'function') recalcAccounting();
      if (typeof refreshDashboard === 'function') refreshDashboard();
      notify('Backup restored', 'success');
    } catch (e) {
      notify('Invalid backup file', 'error');
    }
  };
  reader.readAsText(file);
}

function exportData(kind) {
  let csv = '';
  if (kind === 'inventory') {
    const header = 'Code,Name,Category,Stock,Unit,Cost Price,Selling Price,Status\n';
    const rows = state.items.map(i => [i.code, i.name, i.category, i.stock, i.unit||'pcs', i.cost, i.price, i.status||'active'].join(',')).join('\n');
    csv = header + rows;
    downloadCSV('inventory_export.csv', csv);
  } else if (kind === 'customers') {
    const header = 'ID,First Name,Last Name,Type,Email,Phone,Total Purchases\n';
    const rows = state.customers.map(c => [c.id||'', c.firstName||'', c.lastName||'', c.type||'', c.email||'', c.phone||'', c.totalPurchases||0].join(',')).join('\n');
    csv = header + rows;
    downloadCSV('customers_export.csv', csv);
  } else if (kind === 'sales') {
    const header = 'Sale ID,Date,Customer,Items Count,Subtotal,Tax,Total,Payment Method\n';
    const rows = state.sales.map(s => [s.id, s.date, s.customer||'', s.items.length, s.subtotal, s.tax, s.total, s.payment].join(',')).join('\n');
    csv = header + rows;
    downloadCSV('sales_export.csv', csv);
  } else if (kind === 'transactions') {
    const header = 'ID,Date,Type,Party,Amount,Status\n';
    const rows = state.transactions.map(t => [t.id, t.date, t.type, t.party||'', t.amount, t.status||'completed'].join(',')).join('\n');
    csv = header + rows;
    downloadCSV('transactions_export.csv', csv);
  }
  notify(`${titleize(kind)} exported`, 'success');
}

function importData(kind) {
  const fileInput = document.getElementById(kind === 'inventory' ? 'inventoryFile' : 'customersFile');
  const file = fileInput && fileInput.files && fileInput.files[0];
  if (!file) return notify('Please select a CSV file to import', 'warning');

  const reader = new FileReader();
  reader.onload = () => {
    try {
      const lines = reader.result.split(/\r?\n/).filter(Boolean);
      if (lines.length <= 1) return notify('CSV has no data rows', 'warning');
      const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
      const rows = lines.slice(1).map(line => {
        const cols = line.split(',');
        const obj = {};
        headers.forEach((h, idx) => obj[h] = cols[idx]);
        return obj;
      });

      if (kind === 'inventory') {
        rows.forEach(r => {
          if (!r.code || !r.name) return;
          state.items.push({
            id: `ITM-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,
            code: r.code, name: r.name,
            category: r.category || 'other',
            stock: Number(r.stock || 0),
            unit: r.unit || 'pcs',
            cost: Number(r['cost price'] || r.cost || 0),
            price: Number(r['selling price'] || r.price || 0),
            status: r.status || 'active',
            min: 0
          });
        });
        if (typeof refreshInventoryTable === 'function') refreshInventoryTable();
      } else if (kind === 'customers') {
        rows.forEach(r => {
          state.customers.push({
            id: r.id || `CUS-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,
            firstName: r['first name'] || r.firstname || '',
            lastName: r['last name'] || r.lastname || '',
            type: r.type || 'individual',
            email: r.email || '',
            phone: r.phone || '',
            totalPurchases: Number(r['total purchases'] || 0)
          });
        });
        if (typeof refreshCustomersTable === 'function') refreshCustomersTable();
      }
      if (typeof refreshDashboard === 'function') refreshDashboard();
      notify(`${titleize(kind)} imported`, 'success');
    } catch (e) {
      notify('Failed to import CSV', 'error');
    }
  };
  reader.readAsText(file);
}

// Init defaults on load if present
(function initSettingsDefaults(){
  try {
    // Prefill forms from state
    const cc = document.getElementById('companyCurrency'); if (cc) cc.value = state.config?.currency || 'UGX';
    const cn = document.getElementById('companyName'); if (cn) cn.value = state.config?.companyName || 'Enhanced Business Management System';
    const tr = document.getElementById('taxRate'); if (tr) tr.value = state.config?.taxRate ?? 18;
    const et = document.getElementById('enableTax'); if (et) et.checked = !!state.config?.enableTax;

    // System
    const th = document.getElementById('systemTheme'); if (th) th.value = state.system?.theme || 'dark';
    const df = document.getElementById('dateFormat'); if (df) df.value = state.system?.dateFormat || 'DD/MM/YYYY';
    const tf = document.getElementById('timeFormat'); if (tf) tf.value = state.system?.timeFormat || '24';
    const as = document.getElementById('autoSave'); if (as) as.checked = !!state.system?.autoSave;
    const la = document.getElementById('lowStockAlerts'); if (la) la.checked = !!state.system?.lowStockAlerts;
    const en = document.getElementById('emailNotifications'); if (en) en.checked = !!state.system?.emailNotifications;
    const rh = document.getElementById('receiptHeader'); if (rh) rh.value = state.system?.receiptHeader || 'Thank you for your business!';
    const rf = document.getElementById('receiptFooter'); if (rf) rf.value = state.system?.receiptFooter || 'Visit us again soon!';
    const pl = document.getElementById('printLogo'); if (pl) pl.checked = !!state.system?.printLogo;

    refreshUsersTable();
  } catch {}
})();

    // Receipts
    let lastReceipt = null;
    function buildReceiptDataFromSale(s){
        return {
            type: 'sale',
            company: state.config.companyName,
            number: 'R'+ (++state.receiptCounter),
            date: new Date().toLocaleString(),
            cashier: state.currentUser?.fullName || 'USER',
            customer: s.customer,
            items: s.items,
            subtotal: s.subtotal,
            tax: s.tax,
            discount: s.discount,
            total: s.total,
            payment: s.payment
        };
    }
    
    function buildDepositReceipt(d){
        return {
            type: 'deposit',
            company: state.config.companyName,
            number: 'R'+ (++state.receiptCounter),
            date: new Date().toLocaleString(),
            cashier: state.currentUser?.fullName || 'USER',
            customer: d.customer,
            items: [{ name:`Deposit for ${d.item}`, qty:1, price:d.amount, total:d.amount, unit:'deposit' }],
            subtotal: d.amount,
            tax: 0,
            discount: 0,
            total: d.amount,
            extra: { item: d.item, totalOrderAmount: d.total, remaining: d.remaining, notes: d.notes }
        };
    }

    // Helpers
    function downloadCSV(filename, content){ downloadBlob(filename, new Blob([content],{type:'text/csv;charset=utf-8'})); }
    function downloadBlob(filename, blob){ const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0); }
    function titleize(s){ return String(s||'').replace(/-/g,' ').replace(/\b\w/g, c=>c.toUpperCase()); }
    function setText(id, v){ const el = document.getElementById(id); if(el) el.textContent = v; }
    </script>
</body>
</html>
